<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU é ç´„ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2', light: '#FDFBF7' } 
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        [v-cloak] { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFBF7; border-left: 4px solid #C69C6D; }
        .price-input:focus { border-color: #C69C6D; background-color: #fff; }
        .edit-input { width: 100%; border-bottom: 1px solid #ddd; background: transparent; padding: 4px 0; font-weight: bold; color: #4A4A4A; outline: none; }
        .edit-input:focus { border-bottom: 2px solid #C69C6D; }
        
        /* æ—¥æ›†é¸ä¸­æ¨£å¼ */
        .calendar-selected { background-color: #C69C6D !important; color: white !important; }
        
        /* è‡ªå®šç¾© SweetAlert */
        .swal2-confirm { background-color: #10B981 !important; }
        .swal2-deny { background-color: #6B7280 !important; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full w-full overflow-hidden">
        
        <!-- å·¦å´å´é‚Šæ¬„ï¼šæœå°‹ + æ—¥æ›† + åˆ—è¡¨ -->
        <aside class="w-full md:w-80 border-r bg-white flex flex-col z-30 transition-all shrink-0" 
               :class="{'hidden md:flex': selectedOrder}">
            
            <!-- æœå°‹æ¬„ -->
            <div class="p-4 border-b space-y-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold text-milu-gold tracking-tighter">MILU ADMIN</h1>
                    <button @click="fetchData" class="text-xs text-gray-400 hover:text-milu-gold transition">
                        <i class="fa-solid fa-rotate" :class="{'animate-spin': loading}"></i> åˆ·æ–°
                    </button>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-300 text-sm"></i>
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹å§“åã€é›»è©±..." 
                           class="w-full pl-9 pr-4 py-2.5 bg-gray-100 rounded-xl outline-none focus:ring-2 ring-milu-gold/20 text-sm font-medium">
                </div>
            </div>

            <!-- æ—¥æ›†å…ƒä»¶ -->
            <div class="p-4 border-b bg-gray-50/50" v-if="!searchQuery">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-sm text-gray-600">{{ currentMonthYear }}</h3>
                    <div class="flex gap-1">
                        <button @click="prevMonth" class="p-1.5 hover:bg-white rounded-lg transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                        <button @click="nextMonth" class="p-1.5 hover:bg-white rounded-lg transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-black text-gray-300 mb-1">
                    <div v-for="d in ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']" :key="d">{{ d }}</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
                    <div v-for="(day, idx) in calendarDays" :key="idx" 
                         @click="day.dateStr && toggleDateFilter(day.dateStr)"
                         class="h-8 rounded-lg flex flex-col items-center justify-center cursor-pointer transition-all relative text-[11px] font-bold"
                         :class="[
                            !day.dateStr ? 'opacity-0 pointer-events-none' : '',
                            filterDate === day.dateStr ? 'calendar-selected shadow-md scale-105 z-10' : 'hover:bg-white text-gray-600'
                         ]">
                        {{ day.dayNum }}
                        <div v-if="hasOrderOnDate(day.dateStr)" 
                             class="w-1 h-1 rounded-full absolute bottom-1"
                             :class="filterDate === day.dateStr ? 'bg-white' : 'bg-milu-gold'"></div>
                    </div>
                </div>
                <div v-if="filterDate" class="mt-2 text-center">
                    <button @click="filterDate = ''" class="text-[10px] text-milu-gold hover:underline">é¡¯ç¤ºæ‰€æœ‰æ—¥æœŸ</button>
                </div>
            </div>

            <!-- ç‹€æ…‹æ¨™ç±¤ -->
            <div class="flex p-2 gap-1 bg-white border-b overflow-x-auto no-scrollbar">
                <button v-for="st in ['ALL', 'UNPAID', 'CONFIRMED', 'COMPLETED']" 
                        :key="st" @click="filter = st"
                        class="px-3 py-1.5 text-[11px] font-bold rounded-full transition-all whitespace-nowrap border"
                        :class="filter === st ? 'bg-milu-gold text-white border-milu-gold' : 'bg-gray-50 text-gray-400 border-gray-100'">
                    {{ getStatusTabName(st) }}
                </button>
            </div>

            <!-- åˆ—è¡¨å€ -->
            <div class="flex-1 overflow-y-auto no-scrollbar bg-gray-50/30">
                <div v-if="filteredList.length === 0" class="p-10 text-center text-gray-300 text-xs italic">
                    <i class="fa-regular fa-folder-open text-2xl mb-2 block opacity-20"></i>
                    ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®
                </div>
                <div v-for="order in filteredList" :key="order.oid" 
                     @click="selectOrder(order)" 
                     class="p-4 border-b cursor-pointer hover:bg-milu-light transition-all bg-white relative"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    <div class="flex justify-between mb-1 font-mono text-[10px] text-gray-400">
                        <span>#{{ order.oid }}</span>
                        <span>{{ order.date }}</span>
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-sm font-bold text-gray-800" v-html="highlightText(order.contactName)"></h3>
                            <p class="text-[11px] text-gray-500 mt-0.5">{{ order.service }} Â· {{ order.time }}</p>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold" 
                              :class="getStatusClass(order.status)">
                            {{ getStatusText(order.status) }}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- é è…³è³‡è¨Š -->
            <div class="p-3 border-t bg-white text-[10px] text-gray-400 flex justify-between">
                <span>æœ€å¾Œæ›´æ–°: {{ lastUpdated || 'å°šæœªæ›´æ–°' }}</span>
                <span>å…± {{ filteredList.length }} ç­†</span>
            </div>
        </aside>

        <!-- å³å´è©³æƒ…é¢æ¿ -->
        <main class="flex-1 bg-gray-50 flex flex-col relative h-full overflow-hidden" 
              :class="{'hidden': !selectedOrder && isMobile}">
            
            <!-- ç§»å‹•ç«¯è¿”å›éµ -->
            <div v-if="selectedOrder" class="md:hidden absolute top-4 left-4 z-50">
                <button @click="selectedOrder = null" class="bg-white/90 backdrop-blur w-10 h-10 rounded-full shadow-lg text-gray-600 flex items-center justify-center">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto no-scrollbar relative">
                <div class="min-h-full flex flex-col items-center justify-center p-4 md:p-10">
                    
                    <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden w-full max-w-xl mx-auto card-shadow">
                        
                        <!-- é ‚éƒ¨ç‹€æ…‹ Banner -->
                        <div class="h-32 flex flex-col items-center justify-center text-white relative transition-colors duration-500"
                             :class="getStatusBg(selectedOrder.status)">
                            
                            <!-- ç·¨è¼¯/å„²å­˜æŒ‰éˆ• -->
                            <div class="absolute top-6 right-6 flex gap-2">
                                <button v-if="!isEditing" @click="startEdit" class="bg-white/20 hover:bg-white/30 p-2.5 rounded-full transition backdrop-blur-md">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <template v-else>
                                    <button @click="saveEdit" class="bg-green-500 hover:bg-green-600 px-4 py-1.5 rounded-full text-sm font-bold shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                                        <i class="fa-solid fa-floppy-disk"></i> å„²å­˜
                                    </button>
                                    <button @click="cancelEdit" class="bg-white/20 hover:bg-white/30 px-4 py-1.5 rounded-full text-sm backdrop-blur-md">
                                        å–æ¶ˆ
                                    </button>
                                </template>
                            </div>

                            <div class="text-4xl mb-1 opacity-90">
                                <i :class="getStatusIcon(selectedOrder.status)"></i>
                            </div>
                            <h2 class="text-lg font-bold tracking-[0.2em]">
                                {{ getStatusText(selectedOrder.status, true) }}
                            </h2>
                        </div>

                        <!-- è©³æƒ…å…§å®¹ -->
                        <div class="p-6 md:p-10 space-y-8 relative">
                            <div v-if="isEditing" class="absolute top-0 left-0 w-full h-1 bg-yellow-400 animate-pulse"></div>

                            <!-- å®¢æˆ¶å€å¡Š -->
                            <div class="flex flex-col md:flex-row md:justify-between gap-6 border-b border-gray-50 pb-8">
                                <div class="flex-1 space-y-4">
                                    <p class="text-[10px] font-black text-gray-300 tracking-widest uppercase">Customer Details</p>
                                    
                                    <div v-if="isEditing" class="space-y-3">
                                        <div>
                                            <label class="text-[10px] text-gray-400">LINE åç¨±</label>
                                            <input v-model="editForm.lineName" class="edit-input text-sm">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-gray-400">è¯çµ¡äººå§“å</label>
                                            <input v-model="editForm.contactName" class="edit-input text-xl">
                                        </div>
                                        <div>
                                            <label class="text-[10px] text-gray-400">é›»è©±è™Ÿç¢¼</label>
                                            <input v-model="editForm.phone" class="edit-input text-sm">
                                        </div>
                                    </div>

                                    <div v-else class="space-y-1">
                                        <div class="flex items-center gap-2 text-green-500 font-bold">
                                            <i class="fa-brands fa-line text-xl"></i>
                                            <span>{{ selectedOrder.lineName }}</span>
                                        </div>
                                        <h3 class="text-3xl font-black text-gray-800">{{ selectedOrder.contactName }}</h3>
                                        <p class="text-gray-500 flex items-center gap-2">
                                            <i class="fa-solid fa-phone text-xs"></i> {{ selectedOrder.phone }}
                                        </p>
                                        <p class="text-[10px] font-mono text-gray-300 mt-2">
                                            UID: {{ selectedOrder.userId || 'æœªé€£çµ' }}
                                        </p>
                                    </div>
                                </div>

                                <div class="md:text-right flex flex-col md:items-end justify-start gap-1">
                                    <p class="text-[10px] font-black text-gray-300 tracking-widest uppercase">Service Type</p>
                                    <p class="text-xl font-bold text-milu-gold">{{ selectedOrder.service }}</p>
                                </div>
                            </div>

                            <!-- æ™‚é–“èˆ‡æ—¥æœŸ -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                    <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase">Date</p>
                                    <input v-if="isEditing" type="date" v-model="editForm.date" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                    <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase">{{ getLabel('time', selectedOrder.service) }}</p>
                                    <template v-if="isEditing">
                                        <select v-if="isTimeSlotService(selectedOrder.service)" v-model="editForm.time" class="edit-input">
                                            <option v-for="slot in timeSlots" :key="slot" :value="slot">{{ slot }}</option>
                                        </select>
                                        <input v-else type="time" v-model="editForm.time" class="edit-input">
                                    </template>
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                                </div>
                            </div>

                            <!-- è²¡å‹™è©³æƒ… -->
                            <div class="bg-milu-beige p-6 rounded-[1.5rem] border border-milu-gold/10 space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-gray-500">å ±åƒ¹ç¸½é¡</span>
                                    <div class="flex items-center gap-1 font-mono">
                                        <span class="text-xs text-gray-400">NT$</span>
                                        <input type="number" v-model.number="displayRawPrice" @focus="handlePriceFocus"
                                               class="bg-transparent border-b border-gray-200 text-right w-24 font-bold text-lg outline-none focus:border-milu-gold">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-green-600">å·²æ”¶é‡‘é¡</span>
                                        <button @click="fillFullPayment" class="text-[9px] bg-green-100 text-green-700 px-2 py-0.5 rounded-md hover:bg-green-200 transition">âš¡å…¨é¡</button>
                                    </div>
                                    <div class="flex items-center gap-1 font-mono">
                                        <span class="text-xs text-green-400">NT$</span>
                                        <input type="number" v-model.number="displayReceivedPrice" @focus="handlePriceFocus"
                                               class="bg-transparent border-b border-green-200 text-right w-24 font-bold text-lg text-green-600 outline-none focus:border-green-500">
                                    </div>
                                </div>
                                <div class="pt-3 border-t border-milu-gold/10 flex justify-between items-center">
                                    <span class="text-xs font-black text-red-500">å°šæ¬ å°¾æ¬¾</span>
                                    <span class="text-2xl font-black text-red-500 font-mono">
                                        NT$ {{ formatMoney(displayRawPrice - displayReceivedPrice) }}
                                    </span>
                                </div>
                            </div>

                            <!-- åœ°é» -->
                            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase">{{ getLabel('location', selectedOrder.service) }}</p>
                                <input v-if="isEditing" type="text" v-model="editForm.location" class="edit-input">
                                <p v-else class="text-sm font-bold text-gray-700 leading-relaxed">{{ selectedOrder.location }}</p>
                            </div>

                            <!-- æ“ä½œæŒ‰éˆ•å€ -->
                            <div v-if="!isEditing" class="pt-4 space-y-3">
                                <button v-if="selectedOrder.status === 'UNPAID'" @click="updateOrderStatus('PAYMENT_REQUEST')" 
                                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-blue-500/20 transition flex items-center justify-center gap-2 active:scale-95">
                                    <i class="fa-solid fa-paper-plane"></i> ç™¼é€ä»˜æ¬¾å¸³è™Ÿé€šçŸ¥
                                </button>

                                <button v-if="['UNPAID', 'WAITING_PAYMENT'].includes(selectedOrder.status)" @click="updateOrderStatus('CONFIRM')" 
                                        class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-green-500/20 transition flex items-center justify-center gap-2 active:scale-95">
                                    <i class="fa-solid fa-circle-check"></i> ç¢ºèªæ”¶æ¬¾ä¸¦ç™»è¨˜
                                </button>

                                <button v-if="selectedOrder.status === 'CONFIRMED'" @click="updateOrderStatus('COMPLETE')" 
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-500/20 transition flex items-center justify-center gap-2 active:scale-95">
                                    <i class="fa-solid fa-flag-checkered"></i> çµæ¡ˆ (æœå‹™å·²å®Œæˆ)
                                </button>

                                <div v-if="['COMPLETED', 'CANCELED', 'REFUNDED'].includes(selectedOrder.status)" class="space-y-3">
                                    <div class="text-center py-4 bg-gray-100 text-gray-400 rounded-2xl font-bold border border-dashed text-sm">
                                        è¨‚å–®å·² {{ getStatusText(selectedOrder.status) }}
                                    </div>
                                    <button @click="updateOrderStatus('RESTORE')" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-2xl font-bold transition flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-rotate-left"></i> æ¢å¾©è‡³æœªä»˜æ¬¾ç‹€æ…‹
                                    </button>
                                </div>

                                <div class="flex gap-2" v-if="!['CANCELED', 'REFUNDED', 'COMPLETED'].includes(selectedOrder.status)">
                                    <button v-if="selectedOrder.status === 'CONFIRMED'" @click="updateOrderStatus('REFUND')" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 active:scale-95">
                                        è¾¦ç†é€€æ¬¾
                                    </button>
                                    <button @click="updateOrderStatus('CANCEL')" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-600 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 active:scale-95">
                                        å–æ¶ˆè¨‚å–®
                                    </button>
                                </div>
                                <p class="text-center text-[10px] text-gray-400">æ›´æ–°å°‡åŒæ­¥è‡³ Google è©¦ç®—è¡¨èˆ‡ LINE é€šçŸ¥</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-300 space-y-4 p-10 text-center">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-inbox text-4xl opacity-30"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-gray-400">å°šæœªé¸æ“‡è¨‚å–®</h2>
                    <p class="text-sm">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡ä¸€ç­†é ç´„è³‡æ–™ä»¥æŸ¥çœ‹è©³æƒ…</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        const CONFIG_MAP = {
            'å°ˆäººä½ˆç½®': { time: 'ä½ˆç½®æ™‚é–“', location: 'ä½ˆç½®åœ°å€', icon: 'âœ¨' },
            'å·¥ä½œå®¤å–è²¨': { time: 'å–è²¨æ™‚é–“', location: 'å–è²¨é–€å¸‚', icon: 'ğŸ›’' },
            'å¾Œè»Šå»‚ä½ˆç½®': { time: 'æŠµé”æ™‚é–“', location: 'æ–½ä½œåœ°é»', icon: 'ğŸš—' },
            'æ°£çƒå¤–é€': { time: 'å¤–é€æ™‚æ®µ', location: 'å¤–é€åœ°å€', icon: 'ğŸšš' }
        };

        const TIME_SLOTS = ["12:30 - 13:30", "13:00 - 14:00", "14:00 - 15:00", "15:00 - 16:00", "16:00 - 17:00", "17:00 - 18:00", "18:00 - 19:00"];

        createApp({
            setup() {
                const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwfAyj7ktWXv4gPoFo7wVPLn1_nQ6w0hX8kTToggetxt3jqqD7yp67cxlrg5l1N1rsLaA/exec';
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/63u0kheb71v9vengzdggfy1ga7r8gmng';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const isEditing = ref(false);
                const editForm = ref({});
                const filter = ref('ALL');
                const searchQuery = ref('');
                const filterDate = ref('');
                const loading = ref(false);
                const lastUpdated = ref(null);
                const currentMonth = ref(new Date());
                const isMobile = ref(typeof window !== 'undefined' ? window.innerWidth < 768 : false);

                // --- æ•¸æ“šè™•ç†è¼”åŠ© ---
                const formatMoney = (val) => Number(val || 0).toLocaleString();
                const parseMoney = (val) => parseInt(String(val).replace(/[^\d.-]/g, '')) || 0;
                
                const getLabel = (type, service) => (CONFIG_MAP[service] || CONFIG_MAP['å°ˆäººä½ˆç½®'])[type];
                const isTimeSlotService = (s) => s.includes('å¤–é€') || s.includes('å–è²¨') || s.includes('è‡ªå–');

                const formatGASDate = (val) => {
                    if (!val) return '';
                    const d = new Date(val);
                    if (isNaN(d.getTime())) return String(val);
                    return d.toISOString().split('T')[0];
                };

                const formatGASTime = (val) => {
                    if (!val) return '';
                    let s = String(val).trim();
                    if (s.includes(' - ') || s.includes('~')) return s;
                    // LMT èª¤å·®ä¿®æ­£ (1899å¹´å•é¡Œ)
                    if (s.includes('T') && (s.includes('1899') || s.includes('1900'))) {
                        const match = s.match(/T(\d{2}):(\d{2})/);
                        if (match) {
                            let total = parseInt(match[1]) * 60 + parseInt(match[2]) + 480 - 38;
                            while (total < 0) total += 1440;
                            while (total >= 1440) total -= 1440;
                            return `${String(Math.floor(total/60)).padStart(2,'0')}:${String(total%60).padStart(2,'0')}`;
                        }
                    }
                    return s;
                };

                // --- æ—¥æ›†é‚è¼¯ ---
                const currentMonthYear = computed(() => {
                    const y = currentMonth.value.getFullYear();
                    const m = currentMonth.value.getMonth() + 1;
                    return `${y}å¹´ ${m}æœˆ`;
                });

                const calendarDays = computed(() => {
                    const year = currentMonth.value.getFullYear();
                    const month = currentMonth.value.getMonth();
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    const days = [];
                    for (let i = 0; i < firstDay; i++) days.push({ dayNum: null, dateStr: null });
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        days.push({ dayNum: i, dateStr });
                    }
                    return days;
                });

                const prevMonth = () => currentMonth.value = new Date(currentMonth.value.getFullYear(), currentMonth.value.getMonth() - 1, 1);
                const nextMonth = () => currentMonth.value = new Date(currentMonth.value.getFullYear(), currentMonth.value.getMonth() + 1, 1);
                
                const hasOrderOnDate = (date) => reservations.value.some(r => r.date === date);
                const toggleDateFilter = (date) => filterDate.value = (filterDate.value === date) ? '' : date;

                // --- åˆ—è¡¨ç¯©é¸ ---
                const filteredList = computed(() => {
                    let list = reservations.value;
                    if (filter.value === 'UNPAID') list = list.filter(r => ['UNPAID', 'WAITING_PAYMENT'].includes(r.status));
                    else if (filter.value !== 'ALL') list = list.filter(r => r.status === filter.value);

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        list = list.filter(r => r.contactName.toLowerCase().includes(q) || r.phone.includes(q) || r.lineName.toLowerCase().includes(q));
                    }
                    if (filterDate.value) list = list.filter(r => r.date === filterDate.value);
                    return list;
                });

                const highlightText = (text) => {
                    if (!text || !searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="bg-yellow-200">$1</span>');
                };

                // --- API æ“ä½œ ---
                const fetchData = async () => {
                    if (isEditing.value) return;
                    loading.value = true;
                    try {
                        const res = await fetch(`${DATA_API_URL}?mode=api`);
                        const raw = await res.json();
                        const formatted = raw.filter(row => row[3]).map((row, index) => {
                            let status = 'UNPAID';
                            const s = (row[10] || '').trim();
                            if (s.includes('ç¢ºèª') || s.includes('å·²ä»˜')) status = 'CONFIRMED';
                            else if (s.includes('å®Œæˆ') || s.includes('çµæ¡ˆ')) status = 'COMPLETED';
                            else if (s.includes('å–æ¶ˆ')) status = 'CANCELED';
                            else if (s.includes('é€€æ¬¾')) status = 'REFUNDED';
                            else if (s.includes('ç­‰å¾…') || s.includes('é ˆçŸ¥')) status = 'WAITING_PAYMENT';

                            return {
                                oid: row[0] || `ID-${index}`,
                                lineName: row[2] || 'LINE',
                                contactName: row[3],
                                phone: row[4] || '',
                                service: row[8] || 'æœå‹™',
                                date: formatGASDate(row[5]),
                                time: formatGASTime(row[6]),
                                location: row[7] || 'æœªå¡«å¯«',
                                userId: row[9] || '',
                                status,
                                rawPrice: parseMoney(row[11]),
                                receivedPrice: parseMoney(row[12])
                            };
                        });
                        reservations.value = formatted.sort((a,b) => new Date(b.date) - new Date(a.date));
                        lastUpdated.value = new Date().toLocaleTimeString();
                        
                        // Auto-select first order on desktop if none selected
                        if (formatted.length > 0 && !selectedOrder.value && !isMobile.value) {
                            selectedOrder.value = formatted[0];
                        }
                    } catch (e) { console.error("Fetch Error:", e); }
                    loading.value = false;
                };

                // --- ç‹€æ…‹æ›´æ–°èˆ‡ LINE ç™¼é€ ---
                const updateOrderStatus = async (actionType) => {
                    const order = selectedOrder.value;
                    if (!order.userId) return Swal.fire('æç¤º', 'æ­¤å®¢æˆ¶æœªé€£çµ LINE IDï¼Œç„¡æ³•ç™¼é€é€šçŸ¥', 'warning');

                    const result = await Swal.fire({
                        title: 'ç¢ºèªæ›´æ–°è¨‚å–®ï¼Ÿ',
                        text: `å°‡ç™¼é€é€šçŸ¥çµ¦ ${order.contactName}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'ç¢ºå®šæ›´æ–°ä¸¦é€šçŸ¥'
                    });

                    if (result.isConfirmed) {
                        Swal.fire({ title: 'æ›´æ–°ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        
                        let statusText = '';
                        if (actionType === 'CONFIRM') statusText = 'âœ… å·²ä»˜æ¬¾'; 
                        else if (actionType === 'PAYMENT_REQUEST') statusText = 'â³ ç­‰å¾…åŒ¯æ¬¾';
                        else if (actionType === 'COMPLETE') statusText = 'ğŸ å·²å®Œæˆ'; 
                        else if (actionType === 'CANCEL') statusText = 'âŒ å·²å–æ¶ˆ';
                        else if (actionType === 'RESTORE') statusText = 'âš ï¸ æœªä»˜æ¬¾';

                        const payload = {
                            action: 'UPDATE_ORDER',
                            orderId: order.oid,
                            status: statusText,
                            price: order.rawPrice,
                            received: order.receivedPrice,
                            to: order.userId,
                            notifyMake: 'true',
                            clientName: order.contactName,
                            service: order.service,
                            date: order.date,
                            time: order.time
                        };

                        try {
                            await fetch(SEND_MSG_WEBHOOK, { 
                                method: 'POST', 
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(payload) 
                            });
                            await fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(e => {});
                            
                            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                            if (actionType === 'CONFIRM') order.status = 'CONFIRMED';
                            else if (actionType === 'COMPLETE') order.status = 'COMPLETED';
                            else if (actionType === 'CANCEL') order.status = 'CANCELED';
                            else if (actionType === 'RESTORE') order.status = 'UNPAID';
                            else if (actionType === 'PAYMENT_REQUEST') order.status = 'WAITING_PAYMENT';

                            Swal.fire('æˆåŠŸ', 'è¨‚å–®å·²æ›´æ–°', 'success');
                        } catch (e) { Swal.fire('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error'); }
                    }
                };

                // --- ç·¨è¼¯åŠŸèƒ½ ---
                const displayRawPrice = computed({
                    get: () => isEditing.value ? editForm.value.rawPrice : (selectedOrder.value?.rawPrice || 0),
                    set: (v) => isEditing.value ? editForm.value.rawPrice = v : selectedOrder.value.rawPrice = v
                });
                const displayReceivedPrice = computed({
                    get: () => isEditing.value ? editForm.value.receivedPrice : (selectedOrder.value?.receivedPrice || 0),
                    set: (v) => isEditing.value ? editForm.value.receivedPrice = v : selectedOrder.value.receivedPrice = v
                });

                const startEdit = () => { editForm.value = JSON.parse(JSON.stringify(selectedOrder.value)); isEditing.value = true; };
                const cancelEdit = () => isEditing.value = false;
                const saveEdit = async () => {
                    const { isConfirmed, isDenied } = await Swal.fire({
                        title: 'å„²å­˜è®Šæ›´',
                        text: 'æ˜¯å¦åŒæ™‚ç™¼é€ LINE é€šçŸ¥çµ¦å®¢äººï¼Ÿ',
                        showDenyButton: true, showCancelButton: true,
                        confirmButtonText: 'å„²å­˜ä¸¦é€šçŸ¥', denyButtonText: 'åƒ…å„²å­˜'
                    });
                    if (isConfirmed || isDenied) {
                        Swal.fire({ title: 'è™•ç†ä¸­...', didOpen: () => Swal.showLoading() });
                        const payload = {
                            action: 'UPDATE_ORDER',
                            orderId: selectedOrder.value.oid,
                            ...editForm.value,
                            to: isConfirmed ? selectedOrder.value.userId : '',
                            notifyMake: isConfirmed ? 'true' : 'false'
                        };
                        try {
                            await fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) }).catch(e=>{});
                            if(isConfirmed) await fetch(SEND_MSG_WEBHOOK, { method: 'POST', body: JSON.stringify(payload) }).catch(e=>{});
                            Object.assign(selectedOrder.value, editForm.value);
                            isEditing.value = false;
                            Swal.fire('æˆåŠŸ', 'è³‡æ–™å·²åŒæ­¥', 'success');
                        } catch (e) { Swal.fire('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error'); }
                    }
                };

                // --- UI è¼”åŠ© ---
                const getStatusTabName = (s) => ({'ALL':'å…¨éƒ¨', 'UNPAID':'å¾…ä»˜', 'CONFIRMED':'å·²æ”¶', 'COMPLETED':'çµæ¡ˆ'}[s]);
                const getStatusText = (s, en=false) => {
                    const m = {'UNPAID':'æœªä»˜æ¬¾', 'CONFIRMED':'å·²ä»˜æ¬¾', 'COMPLETED':'å·²å®Œæˆ', 'CANCELED':'å·²å–æ¶ˆ', 'REFUNDED':'å·²é€€æ¬¾', 'WAITING_PAYMENT':'å¾…åŒ¯æ¬¾'};
                    const e = {'UNPAID':'WAITING PAYMENT', 'CONFIRMED':'PAYMENT RECEIVED', 'COMPLETED':'ORDER FINISHED', 'CANCELED':'CANCELED', 'REFUNDED':'REFUNDED', 'WAITING_PAYMENT':'WAITING PAYMENT'};
                    return en ? e[s] : m[s];
                };
                const getStatusClass = (s) => ({
                    'CONFIRMED':'bg-green-100 text-green-600',
                    'UNPAID':'bg-red-100 text-red-500',
                    'COMPLETED':'bg-blue-100 text-blue-600',
                    'CANCELED':'bg-gray-100 text-gray-400'
                }[s] || 'bg-gray-100 text-gray-500');

                const getStatusBg = (s) => ({
                    'CONFIRMED':'bg-green-500', 'UNPAID':'bg-red-500', 'COMPLETED':'bg-indigo-600', 'WAITING_PAYMENT':'bg-blue-400'
                }[s] || 'bg-gray-500');

                const getStatusIcon = (s) => ({
                    'CONFIRMED':'fa-solid fa-circle-check', 'UNPAID':'fa-solid fa-circle-exclamation', 'COMPLETED':'fa-solid fa-flag-checkered'
                }[s] || 'fa-solid fa-circle-info');

                const selectOrder = (order) => { if(!isEditing.value) selectedOrder.value = order; };
                const fillFullPayment = () => displayReceivedPrice.value = displayRawPrice.value;
                const handlePriceFocus = () => { if(!isEditing.value) startEdit(); };
                
                const onResize = () => { isMobile.value = window.innerWidth < 768; };

                onMounted(() => {
                    window.addEventListener('resize', onResize);
                    fetchData();
                    setInterval(fetchData, 60000);
                });
                
                onUnmounted(() => {
                    window.removeEventListener('resize', onResize);
                });

                return {
                    reservations, selectedOrder, filter, searchQuery, filterDate, loading, lastUpdated,
                    currentMonthYear, calendarDays, prevMonth, nextMonth, hasOrderOnDate, toggleDateFilter,
                    filteredList, highlightText, selectOrder, fetchData, updateOrderStatus,
                    isEditing, editForm, startEdit, cancelEdit, saveEdit,
                    formatMoney, displayRawPrice, displayReceivedPrice, fillFullPayment, handlePriceFocus,
                    getStatusTabName, getStatusText, getStatusClass, getStatusBg, getStatusIcon,
                    getLabel, isTimeSlotService, timeSlots: TIME_SLOTS, isMobile
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
