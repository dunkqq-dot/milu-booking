<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU é ç´„ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
        .debug-modal pre { white-space: pre-wrap; word-wrap: break-word; font-size: 11px; color: #333; max-height: 400px; overflow-y: auto; background: #f1f1f1; padding: 15px; border-radius: 5px; text-align: left; }
        .price-input:focus { border-color: #C69C6D; background-color: #fff; }
        .edit-input { width: 100%; border-bottom: 1px solid #ddd; background: transparent; padding: 2px 0; font-weight: bold; color: #4A4A4A; }
        
        /* è‡ªå®šç¾© SweetAlert æŒ‰éˆ•æ¨£å¼ */
        .swal2-confirm { background-color: #10B981 !important; } /* ç¶ è‰² */
        .swal2-deny { background-color: #6B7280 !important; } /* ç°è‰² */
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
        <!-- å·¦å´åˆ—è¡¨ -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10" :class="{'hidden md:flex': selectedOrder}">
            
            <!-- Header å€å¡Šï¼šæ¨™é¡Œ + å·¥å…·åˆ— -->
            <div class="p-4 border-b border-gray-100 bg-[#F9F7F2] space-y-3">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-milu-gold tracking-wide font-serif">MILU ADMIN</h1>
                        <p class="text-xs text-gray-400 mt-1">è¨‚å–®æ ¸å°ç³»çµ±</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex gap-2">
                            <button @click="showDebug" class="text-xs px-2 py-1 bg-gray-200 rounded text-gray-600 hover:bg-gray-300">ğŸ” è¨ºæ–·</button>
                            <div class="text-xs px-2 py-1 bg-white rounded text-gray-400 border flex items-center gap-1" v-if="loading">
                                <i class="fa-solid fa-circle-notch fa-spin"></i> æ›´æ–°ä¸­...
                            </div>
                            <button @click="fetchData" v-else class="text-gray-400 hover:text-milu-gold transition" title="æ‰‹å‹•æ›´æ–°"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                        <span v-if="lastUpdated" class="text-[10px] text-gray-300">æ›´æ–°: {{ lastUpdated }}</span>
                    </div>
                </div>

                <!-- ğŸ” æ–°å¢ï¼šæœå°‹èˆ‡é€²éšç¯©é¸å€å¡Š -->
                <div class="bg-white p-2 rounded-lg border border-gray-200 space-y-2">
                    <!-- é—œéµå­—æœå°‹ -->
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-300 text-xs"></i>
                        <input type="text" v-model="searchQuery" placeholder="æœå°‹å§“åã€é›»è©±ã€LINE..." 
                               class="w-full pl-8 pr-2 py-1.5 text-xs bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold focus:bg-white transition">
                        <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-2 top-2 text-gray-300 hover:text-gray-500">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- æ—¥æœŸèˆ‡æœå‹™ç¯©é¸ -->
                    <div class="flex gap-2">
                        <input type="date" v-model="filterDate" class="flex-1 text-xs px-2 py-1.5 bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold text-gray-500">
                        <select v-model="filterService" class="flex-1 text-xs px-2 py-1.5 bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold text-gray-500">
                            <option value="">æ‰€æœ‰æœå‹™</option>
                            <option v-for="(conf, key) in configMap" :key="key" :value="key">{{ key }}</option>
                        </select>
                        <!-- æ¸…é™¤ç¯©é¸æŒ‰éˆ• -->
                        <button v-if="filterDate || filterService" @click="clearFilters" class="px-2 text-gray-400 hover:text-red-400" title="æ¸…é™¤ç¯©é¸">
                            <i class="fa-solid fa-filter-circle-xmark"></i>
                        </button>
                    </div>
                </div>

                <div v-if="errorMsg" class="p-2 bg-red-50 text-red-500 text-xs rounded border border-red-100 break-words">{{ errorMsg }}</div>
            </div>

            <!-- ç‹€æ…‹é ç±¤ (å…¨éƒ¨/æœªä»˜æ¬¾/å·²ä»˜æ¬¾) -->
            <div class="flex p-2 gap-2 bg-gray-50 border-b border-gray-200 shrink-0 overflow-x-auto">
                <button @click="filter = 'ALL'" :class="filter === 'ALL' ? 'bg-white text-milu-gold shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-2">å…¨éƒ¨</button>
                <button @click="filter = 'UNPAID'" :class="filter === 'UNPAID' ? 'bg-white text-red-500 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-2">æœªä»˜æ¬¾</button>
                <button @click="filter = 'CONFIRMED'" :class="filter === 'CONFIRMED' ? 'bg-white text-green-600 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-2">å·²ä»˜æ¬¾</button>
            </div>

            <!-- è¨‚å–®åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div v-if="filteredList.length === 0" class="text-center py-10 text-gray-400 text-sm flex flex-col items-center">
                    <i class="fa-regular fa-folder-open text-2xl mb-2 opacity-50"></i>
                    æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®
                </div>

                <div v-for="order in filteredList" :key="order.oid" @click="selectOrder(order)" 
                     class="p-4 rounded-xl cursor-pointer transition-all bg-white border border-transparent hover:border-gray-200 card-shadow"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded">#{{ order.oid }}</span>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold"
                              :class="{
                                  'bg-green-100 text-green-600': order.status === 'CONFIRMED',
                                  'bg-red-100 text-red-500': order.status === 'UNPAID',
                                  'bg-gray-200 text-gray-600': order.status === 'CANCELED',
                                  'bg-yellow-100 text-yellow-600': order.status === 'REFUNDED',
                                  'bg-blue-100 text-blue-600': order.status === 'COMPLETED',
                                  'bg-blue-400 text-white': order.status === 'WAITING_PAYMENT'
                              }">
                            {{ getStatusText(order.status) }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">
                            <span v-html="highlightText(order.contactName)"></span>
                        </h3>
                        <span class="text-xs text-gray-400">{{ order.service }}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 mt-2 gap-3">
                        <span class="flex items-center gap-1">ğŸ“… {{ order.date }}</span>
                        <span class="flex items-center gap-1">â° {{ order.time }}</span>
                    </div>
                    
                    <div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center" v-if="order.status !== 'CANCELED' && order.status !== 'COMPLETED'">
                        <span class="text-xs text-gray-400">ç¸½é¡: NT$ {{ formatMoney(order.rawPrice) }}</span>
                        <span class="text-xs font-bold" :class="order.rawPrice > 0 ? ((order.rawPrice - order.receivedPrice) > 0 ? 'text-red-400' : 'text-green-500') : 'text-gray-400'">
                            {{ order.rawPrice > 0 ? ((order.rawPrice - order.receivedPrice) > 0 ? `å°šæ¬ : NT$ ${formatMoney(order.rawPrice - order.receivedPrice)}` : 'å·²ä»˜æ¸…') : 'å¾…å ±åƒ¹' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´è©³æƒ… -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">â¬…</button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto relative">
                <div class="min-h-full flex flex-col items-center justify-center p-4 md:p-10 py-16 md:py-10">
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md mx-auto">
                    
                        <div class="h-28 flex items-center justify-center transition-colors duration-300 relative"
                             :class="{
                                 'bg-[#10B981]': selectedOrder.status === 'CONFIRMED',
                                 'bg-[#EF4444]': selectedOrder.status === 'UNPAID',
                                 'bg-gray-500': selectedOrder.status === 'CANCELED',
                                 'bg-yellow-500': selectedOrder.status === 'REFUNDED',
                                 'bg-blue-500': selectedOrder.status === 'COMPLETED',
                                 'bg-blue-400': selectedOrder.status === 'WAITING_PAYMENT'
                             }">
                            
                            <!-- ç·¨è¼¯æ¨¡å¼æŒ‰éˆ•å€ -->
                            <button v-if="!isEditing" @click="startEdit" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition backdrop-blur-sm" title="ç·¨è¼¯è³‡æ–™">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <div v-else class="absolute top-4 right-4 flex items-center gap-2">
                                <!-- ç§»é™¤åŸæœ¬çš„ checkboxï¼Œæ”¹ç”¨ç¢ºèªè¦–çª—é‚è¼¯ -->
                                <button @click="saveEdit" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm shadow font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-floppy-disk"></i> å„²å­˜
                                </button>
                                <button @click="cancelEdit" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg text-sm backdrop-blur-sm">
                                    å–æ¶ˆ
                                </button>
                            </div>

                            <div class="text-center text-white">
                                <div class="text-4xl mb-1">
                                    <i v-if="selectedOrder.status === 'CONFIRMED'" class="fa-solid fa-circle-check"></i>
                                    <i v-else-if="selectedOrder.status === 'CANCELED'" class="fa-solid fa-circle-xmark"></i>
                                    <i v-else-if="selectedOrder.status === 'REFUNDED'" class="fa-solid fa-money-bill-transfer"></i>
                                    <i v-else-if="selectedOrder.status === 'COMPLETED'" class="fa-solid fa-flag-checkered"></i>
                                    <i v-else-if="selectedOrder.status === 'WAITING_PAYMENT'" class="fa-solid fa-hourglass-half"></i>
                                    <i v-else class="fa-solid fa-circle-exclamation"></i>
                                </div>
                                <h2 class="text-lg font-bold tracking-widest opacity-90">
                                    {{ getStatusText(selectedOrder.status, true) }}
                                </h2>
                            </div>
                        </div>

                        <div class="p-8 space-y-6 relative">
                            <div v-if="isEditing" class="absolute top-0 left-0 w-full h-1 bg-yellow-400 animate-pulse"></div>

                            <!-- å®¢æˆ¶è³‡è¨Š -->
                            <div class="flex justify-between border-b border-gray-100 pb-4">
                                <div class="flex-1 mr-4">
                                    <p class="text-xs text-gray-400 mb-1">CUSTOMER</p>
                                    <div v-if="isEditing">
                                        <label class="text-[10px] text-gray-400">LINEåç¨±</label>
                                        <input v-model="editForm.lineName" class="edit-input text-sm mb-1" placeholder="LINEåç¨±">
                                        <label class="text-[10px] text-gray-400">è¯çµ¡äººå§“å</label>
                                        <input v-model="editForm.contactName" class="edit-input text-xl mb-1" placeholder="è¯çµ¡äººå§“å">
                                        <label class="text-[10px] text-gray-400">é›»è©±</label>
                                        <input v-model="editForm.phone" class="edit-input text-sm" placeholder="é›»è©±">
                                    </div>
                                    <div v-else>
                                        <p class="text-2xl text-gray-400 font-bold mb-1 flex items-center gap-2">
                                            <i class="fa-brands fa-line text-green-500 text-xl"></i> {{ selectedOrder.lineName }}
                                        </p>
                                        <p class="font-bold text-2xl text-gray-800">{{ selectedOrder.contactName }}</p>
                                        <p class="text-sm text-gray-600 mt-2 flex items-center gap-1">
                                            <i class="fa-solid fa-phone text-xs"></i> {{ selectedOrder.phone }}
                                        </p>
                                    </div>
                                    <p class="text-xs text-gray-300 font-mono mt-2" v-if="!isEditing">
                                        {{ selectedOrder.userId ? `ID: ...${selectedOrder.userId.substr(-4)}` : 'æœªç¶å®šLINE ID' }}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">SERVICE</p>
                                    <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                                </div>
                            </div>

                            <!-- æ™‚é–“æ—¥æœŸ -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                    <p class="text-xs text-gray-400 mb-1">DATE</p>
                                    <input v-if="isEditing" type="date" v-model="editForm.date" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                    <p class="text-xs text-gray-400 mb-1">{{ getLabel('time', selectedOrder.service) }}</p>
                                    <template v-if="isEditing">
                                        <select v-if="isTimeSlotService(selectedOrder.service)" v-model="editForm.time" class="edit-input">
                                            <option value="" disabled>è«‹é¸æ“‡æ™‚æ®µ</option>
                                            <option v-for="slot in timeSlots" :key="slot" :value="slot">{{ slot }}</option>
                                        </select>
                                        <input v-else type="time" v-model="editForm.time" class="edit-input">
                                    </template>
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                                </div>
                            </div>
                            
                            <!-- æ¬¾é …æ˜ç´° -->
                            <div class="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 space-y-3">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 font-bold">ç¸½é‡‘é¡ (å¡«å…¥å ±åƒ¹)</p>
                                    <div class="flex items-center">
                                        <span class="text-xs mr-1 text-gray-400">NT$</span>
                                        <input type="number" v-model.number="displayRawPrice" 
                                               @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-gray-800 bg-transparent border-b border-gray-300 w-24 text-right focus:outline-none" 
                                               placeholder="0">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-xs text-green-600 font-bold">å·²æ”¶æ¬¾ (å°å¸³)</p>
                                    <div class="flex items-center gap-2">
                                        <button @click="fillFullPayment" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 transition">
                                            âš¡åŒä¸Š
                                        </button>
                                        <span class="text-xs mr-1 text-green-600">NT$</span>
                                        <input type="number" v-model.number="displayReceivedPrice" 
                                               @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-green-600 bg-transparent border-b border-green-200 w-24 text-right focus:outline-none" 
                                               placeholder="0">
                                    </div>
                                </div>
                                <div class="border-t pt-2 flex justify-between items-center border-yellow-200">
                                    <p class="text-xs text-red-500 font-bold">å°šæ¬ å°¾æ¬¾</p>
                                    <p class="font-bold text-xl text-red-500">
                                        NT$ {{ formatMoney(displayRawPrice - displayReceivedPrice) }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- åœ°å€ -->
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                 <p class="text-xs text-gray-400 mb-1">{{ getLabel('location', selectedOrder.service) }}</p>
                                 <input v-if="isEditing" type="text" v-model="editForm.location" class="edit-input">
                                 <p v-else class="font-bold text-gray-600 text-sm break-words">{{ selectedOrder.location }}</p>
                            </div>

                            <!-- å‹•ä½œæŒ‰éˆ• -->
                            <div v-if="!isEditing" class="pt-2 space-y-3">
                                
                                <button v-if="selectedOrder.status === 'UNPAID'" @click="updateOrderStatus('PAYMENT_REQUEST')" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3.5 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-envelope mr-1"></i> (é¸ç”¨) ç™¼é€ä»˜æ¬¾é ˆçŸ¥ & å¸³è™Ÿ
                                </button>

                                <button v-if="selectedOrder.status === 'UNPAID' || selectedOrder.status === 'WAITING_PAYMENT'" @click="updateOrderStatus('CONFIRM')" class="w-full bg-[#10B981] hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg transition shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check-circle"></i> ç¢ºèªæ”¶æ¬¾ä¸¦ç™»è¨˜
                                </button>
                                
                                <div v-if="selectedOrder.status === 'CONFIRMED'" class="space-y-2">
                                    <button @click="updateOrderStatus('COMPLETE')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold transition shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-flag-checkered"></i> å®Œæˆè¨‚å–® (çµæ¡ˆ)
                                    </button>
                                    <p class="text-center text-xs text-gray-400">å·²ä»˜æ¬¾ï¼Œå¯é€²è¡Œçµæ¡ˆ</p>
                                </div>

                                <div v-if="selectedOrder.status === 'COMPLETED' || selectedOrder.status === 'CANCELED' || selectedOrder.status === 'REFUNDED'" class="space-y-3">
                                    <div class="text-center py-3 bg-gray-100 text-gray-500 rounded-xl font-bold border border-gray-200">
                                        æ­¤è¨‚å–®å·²çµæ¡ˆ ({{ getStatusText(selectedOrder.status) }})
                                    </div>
                                    <button @click="updateOrderStatus('RESTORE')" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold transition shadow active:scale-95 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-rotate-left"></i> æ¢å¾©è¨‚å–® (é‡è¨­ç‚ºæœªä»˜æ¬¾)
                                    </button>
                                </div>

                                <div class="flex gap-2" v-if="selectedOrder.status !== 'CANCELED' && selectedOrder.status !== 'REFUNDED' && selectedOrder.status !== 'COMPLETED'">
                                    <button v-if="selectedOrder.status === 'CONFIRMED'" @click="updateOrderStatus('REFUND')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow active:scale-95">
                                        <i class="fa-solid fa-money-bill-transfer"></i> è¾¦ç†é€€æ¬¾
                                    </button>
                                    <button @click="updateOrderStatus('CANCEL')" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow active:scale-95">
                                        <i class="fa-solid fa-ban"></i> å–æ¶ˆè¨‚å–®
                                    </button>
                                </div>

                                <p class="text-center text-xs text-gray-400 pt-2">* é»æ“ŠæŒ‰éˆ•å°‡åŒæ­¥æ›´æ–°è©¦ç®—è¡¨èˆ‡ç™¼é€ LINE é€šçŸ¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                <p>è«‹å¾å·¦å´é¸æ“‡ä¸€ç­†è¨‚å–®æŸ¥çœ‹è©³æƒ…</p>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const configMap = {
            'å°ˆäººä½ˆç½®': { time: 'é€²å ´ä½ˆç½®æ™‚é–“', location: 'ä½ˆç½®åœ°å€', icon: 'âœ¨' },
            'å·¥ä½œå®¤å–è²¨': { time: 'å–è²¨æ™‚é–“', location: 'å–è²¨é–€å¸‚', icon: 'ğŸ›ï¸' },
            'å¾Œè»Šå»‚ä½ˆç½®': { time: 'æŠµé”æ™‚é–“', location: 'æ–½ä½œåœ°é»', icon: 'ğŸš—' },
            'æ°£çƒå¤–é€': { time: 'å¤–é€æ™‚æ®µ', location: 'å¤–é€åœ°å€', icon: 'ğŸšš' }
        };

        const timeSlots = [
            "12:30 - 13:00", "13:00 - 14:00", "14:00 - 15:00", "15:00 - 16:00", 
            "16:00 - 17:00", "17:00 - 18:00", "18:00 - 19:00"
        ];

        createApp({
            setup() {
                const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwfAyj7ktWXv4gPoFo7wVPLn1_nQ6w0hX8kTToggetxt3jqqD7yp67cxlrg5l1N1rsLaA/exec'; 
                // âš ï¸ Make Webhook URL (ç”¨æ–¼ç›´æ¥ç™¼é€ LINE è¨Šæ¯)
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/63u0kheb71v9vengzdggfy1ga7r8gmng';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const isEditing = ref(false);
                const editForm = ref({});
                const filter = ref('ALL');
                
                // ğŸ” æ–°å¢ç¯©é¸è®Šæ•¸
                const searchQuery = ref('');
                const filterDate = ref('');
                const filterService = ref('');

                const loading = ref(true);
                const errorMsg = ref(null);
                const rawJsonData = ref(null);
                const lastUpdated = ref(null);

                const safeText = (text) => (text && String(text).trim() !== '') ? String(text) : ' ';
                const formatMoney = (val) => (!val && val !== 0) ? '0' : val.toLocaleString();
                const parseMoney = (val) => {
                    if (!val) return 0;
                    const str = String(val).replace(/[^\d.-]/g, '');
                    return parseInt(str) || 0;
                };

                const isTimeSlotService = (service) => service.includes('å¤–é€') || service.includes('è‡ªå–');

                const displayRawPrice = computed({
                    get: () => isEditing.value ? editForm.value.rawPrice : (selectedOrder.value ? selectedOrder.value.rawPrice : 0),
                    set: (val) => {
                        if (isEditing.value) editForm.value.rawPrice = val;
                        else if (selectedOrder.value) selectedOrder.value.rawPrice = val;
                    }
                });

                const displayReceivedPrice = computed({
                    get: () => isEditing.value ? editForm.value.receivedPrice : (selectedOrder.value ? selectedOrder.value.receivedPrice : 0),
                    set: (val) => {
                        if (isEditing.value) editForm.value.receivedPrice = val;
                        else if (selectedOrder.value) selectedOrder.value.receivedPrice = val;
                    }
                });

                const fillFullPayment = () => {
                    if (isEditing.value) editForm.value.receivedPrice = editForm.value.rawPrice;
                    else if (selectedOrder.value) selectedOrder.value.receivedPrice = selectedOrder.value.rawPrice;
                };

                const calculateDaysDiff = (dateStr) => {
                    if (!dateStr) return 0;
                    const targetDate = new Date(dateStr);
                    const today = new Date();
                    targetDate.setHours(0, 0, 0, 0);
                    today.setHours(0, 0, 0, 0);
                    const diffTime = targetDate - today;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                };

                const getPaymentMessage = (type, dateStr) => {
                    const diffDays = calculateDaysDiff(dateStr);
                    const rules = {
                        DECO_NORMAL: "1. å–®ä¸€æ™‚æ®µåƒ…æœå‹™ä¸€çµ„å®¢äººï¼Œä»¥å…ˆæ”¯ä»˜è¨‚é‡‘è€…å„ªå…ˆã€‚\n2. åŒ¯æ¬¾æœŸé™ï¼šè«‹æ–¼ä¸‰æ—¥å…§å®ŒæˆåŒ¯æ¬¾ã€‚\n3. è¨‚é‡‘è¦å‰‡ï¼šå¯ä»˜å…¨é¡æˆ– 50% è¨‚é‡‘ï¼Œå°¾æ¬¾æ–¼æ´»å‹•ç•¶æ—¥æ”¯ä»˜ã€‚\n4. æ”¹æœŸèˆ‡å–æ¶ˆï¼šåƒ…æ¥å—ä¸€æ¬¡æ”¹æœŸï¼›å€‹äººå› ç´ å–æ¶ˆæ”¶ 30% æœå‹™è²»ã€‚",
                        DECO_URGENT: "âš ï¸ 3æ—¥å…§æ€¥å–®å°ˆç”¨è¦å‰‡\n1. è«‹æ–¼é ç´„æ™‚ã€Œæ”¯ä»˜å…¨é¡æ¬¾é …ã€ä¸¦æˆªåœ–å›å‚³ã€‚\n2. é ç´„å‰ 5 å°æ™‚æœªæ”¶æ¬¾è¦–ç‚ºæœªæˆç«‹ã€‚\n3. 24å°æ™‚å…§æ€¥ä»¶éœ€åŠ æ”¶ $500ã€‚\n4. å–æ¶ˆä¸é€€é‚„ä»»ä½•æ¬¾é …ã€‚",
                        SIMPLE: "1. è«‹æ–¼é ç´„ç•¶ä¸‹ã€Œæ”¯ä»˜å…¨é¡æ¬¾é …ã€ä¸¦æˆªåœ–å›å‚³ã€‚\n2. é ç´„å‰ 24 å°æ™‚æœªæ”¶æ¬¾è¦–ç‚ºæœªæˆç«‹ã€‚\n3. æ€¥ä»¶åŠ æ”¶ $500ã€‚\n4. 24å°æ™‚å…§å–æ¶ˆä¸é€€æ¬¾ã€‚"
                    };
                    if (type.includes('ä½ˆç½®') || type.includes('å¾Œè»Šå»‚')) return diffDays <= 3 ? rules.DECO_URGENT : rules.DECO_NORMAL;
                    return rules.SIMPLE;
                };

                const formatForLine = (htmlText) => {
                    if (!htmlText) return "ç„¡";
                    return htmlText.replace(/<br\s*\/?>/gi, '\n')
                                   .replace(/<\/p>/gi, '\n\n')
                                   .replace(/<li>/gi, 'â€¢ ')
                                   .replace(/<\/li>/gi, '\n')
                                   .replace(/<[^>]+>/g, '') 
                                   .replace(/&nbsp;/g, ' ').trim();
                };

                const formatGASDate = (val) => {
                    if (!val) return '';
                    const s = String(val);
                    if (s.includes('T')) {
                        const d = new Date(s);
                        if (isNaN(d.getTime())) return s;
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        return `${y}-${m}-${day}`;
                    }
                    return s;
                };

                const formatGASTime = (val) => {
                    if (!val) return '';
                    const s = String(val);
                    if (s.includes('T') && s.includes('Z')) {
                        const d = new Date(s);
                        if (!isNaN(d.getTime())) {
                            return `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                        }
                    }
                    const simpleTimeRegex = /^(\d{1,2}):(\d{2})(:(\d{2}))?$/;
                    const match = s.trim().match(simpleTimeRegex);
                    if (match) return `${match[1].padStart(2, '0')}:${match[2]}`;
                    return s;
                };

                const fetchData = async () => {
                    if (isEditing.value) return; // ç·¨è¼¯ä¸­ä¸æ›´æ–°
                    loading.value = true; errorMsg.value = null;
                    if (!DATA_API_URL) { errorMsg.value = "å°šæœªè¨­å®š GAS API ç¶²å€"; loading.value = false; return; }

                    try {
                        const res = await fetch(`${DATA_API_URL}?mode=api`);
                        const text = await res.text();
                        if (text.trim() === "Accepted") throw new Error("Make API ç›®å‰æ²’æœ‰å›å‚³è³‡æ–™ã€‚");
                        let data = JSON.parse(text);
                        
                        data = data.filter(item => item[0] && String(item[0]).trim() !== '' && item[3] && String(item[3]).trim() !== '');
                        rawJsonData.value = data;

                        const formattedData = data.map((item, index) => {
                            let serviceName = item[8] || 'æœå‹™';
                            if (serviceName.includes('è‡ªå–')) serviceName = 'å·¥ä½œå®¤å–è²¨'; 
                            else if (serviceName.includes('å¾Œè»Šå»‚')) serviceName = 'å¾Œè»Šå»‚ä½ˆç½®';
                            else if (serviceName.includes('å¤–é€')) serviceName = 'æ°£çƒå¤–é€';
                            else if (serviceName.includes('ä½ˆç½®')) serviceName = 'å°ˆäººä½ˆç½®';

                            const rawStatus = (item[10] || '').trim();
                            let status = 'UNPAID';
                            if ((rawStatus.includes('å·²') || rawStatus.includes('ç¢ºèª') || rawStatus.includes('OK')) && !(rawStatus.includes('æœª') || rawStatus.includes('å¾…'))) status = 'CONFIRMED';
                            if (rawStatus.includes('å–æ¶ˆ')) status = 'CANCELED';
                            if (rawStatus.includes('é€€æ¬¾')) status = 'REFUNDED';
                            if (rawStatus.includes('å®Œæˆ') || rawStatus.includes('çµæ¡ˆ')) status = 'COMPLETED';
                            if (rawStatus.includes('ç­‰å¾…') || rawStatus.includes('é ˆçŸ¥')) status = 'WAITING_PAYMENT';

                            return {
                                id: index.toString(), 
                                oid: item[0] || `M-${index}`, 
                                lineName: item[2] || 'æœªçŸ¥LINE', 
                                contactName: item[3] || 'æœªçŸ¥å®¢æˆ¶', 
                                phone: item[4] || '', 
                                service: serviceName, 
                                date: formatGASDate(item[5]), 
                                time: formatGASTime(item[6]), 
                                location: item[7] || 'æœªå¡«å¯«åœ°é»', 
                                userId: item[9] || '', 
                                status, 
                                rawPrice: parseMoney(item[11]), 
                                receivedPrice: parseMoney(item[12])
                            };
                        });
                        reservations.value = formattedData.sort((a, b) => new Date(b.date) - new Date(a.date));
                        
                        if (selectedOrder.value) {
                             const updated = formattedData.find(r => r.oid === selectedOrder.value.oid);
                             if (updated && !isEditing.value) Object.assign(selectedOrder.value, updated);
                        } else if (formattedData.length > 0 && window.innerWidth >= 768) {
                             selectedOrder.value = formattedData[0];
                        }
                        
                        lastUpdated.value = new Date().toLocaleTimeString();
                    } catch (e) { errorMsg.value = e.message; }
                    loading.value = false;
                };

                const getStatusText = (status, isEnglish = false) => {
                    if (isEnglish) return status === 'CONFIRMED' ? 'PAYMENT CONFIRMED' : (status === 'COMPLETED' ? 'ORDER COMPLETED' : 'WAITING FOR PAYMENT');
                    return status === 'CONFIRMED' ? 'å·²ä»˜æ¬¾' : (status === 'COMPLETED' ? 'å·²å®Œæˆ' : (status === 'CANCELED' ? 'å·²å–æ¶ˆ' : (status === 'REFUNDED' ? 'å·²é€€æ¬¾' : (status === 'WAITING_PAYMENT' ? 'ç­‰å¾…åŒ¯æ¬¾' : 'æœªä»˜æ¬¾'))));
                };

                const getLabel = (type, service) => (configMap[service] || configMap['å°ˆäººä½ˆç½®'])[type];
                const selectOrder = (order) => { if(!isEditing.value) selectedOrder.value = order; };

                // ğŸ” å¼·åŒ–ç‰ˆç¯©é¸é‚è¼¯
                const filteredList = computed(() => {
                    let result = reservations.value;

                    // 1. ç‹€æ…‹ç¯©é¸
                    if (filter.value === 'UNPAID') result = result.filter(r => r.status === 'UNPAID' || r.status === 'WAITING_PAYMENT');
                    else if (filter.value !== 'ALL') result = result.filter(r => r.status === filter.value);

                    // 2. é—œéµå­—æœå°‹ (æ”¯æ´å§“åã€é›»è©±ã€LINE)
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(r => 
                            r.contactName.toLowerCase().includes(q) || 
                            r.phone.includes(q) || 
                            r.lineName.toLowerCase().includes(q)
                        );
                    }

                    // 3. æ—¥æœŸç¯©é¸
                    if (filterDate.value) {
                        result = result.filter(r => r.date === filterDate.value);
                    }

                    // 4. æœå‹™ç¯©é¸
                    if (filterService.value) {
                        result = result.filter(r => r.service === filterService.value);
                    }

                    return result;
                });

                const clearFilters = () => {
                    filterDate.value = '';
                    filterService.value = '';
                };
                
                // ç°¡å–®çš„é«˜äº®æ–‡å­—åŠŸèƒ½ (å¢åŠ é˜²å‘†)
                const highlightText = (text) => {
                    if (!text) return ''; // ğŸ‘ˆ é˜²å‘†
                    if (!searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="bg-yellow-200 text-black">$1</span>');
                };

                const buildRichFlexMessage = (order, actionType) => {
                      const config = configMap[order.service] || configMap['å°ˆäººä½ˆç½®'];
                      const total = parseInt(order.rawPrice) || 0;
                      const paid = parseInt(order.receivedPrice) || 0;
                      const balance = total - paid;
                      let titleText = 'PAYMENT CONFIRMED'; let descText = 'é ç´„èˆ‡æ¬¾é …å·²ç¢ºèª'; let statusColor = '#10B981';
                      let bodyContents = [];

                      if (actionType === 'CANCEL') { titleText = 'ORDER CANCELED'; descText = 'é ç´„å·²å–æ¶ˆ'; statusColor = '#EF4444'; }
                      else if (actionType === 'REFUND') { titleText = 'REFUND COMPLETED'; descText = 'é€€æ¬¾è¾¦ç†å®Œæˆ'; statusColor = '#EAB308'; }
                      else if (actionType === 'COMPLETE') { titleText = 'SERVICE COMPLETED'; descText = 'æœå‹™å·²å®Œæˆ'; statusColor = '#2563EB'; }
                      else if (actionType === 'RESTORE') { titleText = 'ORDER RESTORED'; descText = 'è¨‚å–®ç‹€æ…‹å·²æ¢å¾©'; statusColor = '#EF4444'; }
                      else if (actionType === 'UPDATE') { titleText = 'BOOKING UPDATED'; descText = 'é ç´„è³‡æ–™å·²æ›´æ–°'; statusColor = '#3B82F6'; }
                      else if (actionType === 'PAYMENT_REQUEST') { 
                          titleText = 'PAYMENT REQUEST'; 
                          descText = 'è«‹è©³é–±ä»˜æ¬¾è¦å‰‡ä¸¦å®ŒæˆåŒ¯æ¬¾'; 
                          statusColor = '#2563EB'; 
                          const ruleText = formatForLine(getPaymentMessage(order.service, order.date));
                          bodyContents = [
                            { "type": "text", "text": `æœ¬æ¬¡è¨‚å–®ç¸½é‡‘é¡: NT$ ${total.toLocaleString()}`, "weight": "bold", "size": "md", "color": "#C69C6D", "align": "center", "margin": "md" },
                            { "type": "separator", "margin": "md" },
                            { "type": "text", "text": "ä»˜æ¬¾æ³¨æ„äº‹é …", "weight": "bold", "size": "md", "color": "#2563EB", "margin": "md" },
                            { "type": "text", "text": safeText(ruleText), "size": "xs", "color": "#666666", "wrap": true, "margin": "sm" },
                            { "type": "separator", "margin": "lg" },
                            { "type": "text", "text": "åŒ¯æ¬¾è³‡è¨Šï¼šå½°åŒ–éŠ€è¡Œ (009)", "size": "xs", "color": "#aaaaaa", "margin": "lg" },
                            { 
                                "type": "text", 
                                "text": "54320100686300", 
                                "weight": "bold", 
                                "size": "xl", 
                                "color": "#4A4A4A", 
                                "margin": "md", 
                                "align": "center", 
                                "wrap": true,
                                "action": { "type": "clipboard", "clipboardText": "54320100686300", "label": "è¤‡è£½å¸³è™Ÿ" } 
                            },
                            { "type": "text", "text": "(é»æ“Šä¸Šæ–¹æ•¸å­—å³å¯è¤‡è£½)", "size": "xxs", "color": "#cccccc", "align": "center", "margin": "xs" }
                          ];
                      }

                      if (bodyContents.length === 0) {
                          if (actionType === 'COMPLETE') {
                              bodyContents = [ { "type": "text", "text": "æ„Ÿè¬æ‚¨é¸æ“‡ MILU BALLOONSï¼", "weight": "bold", "size": "md", "color": "#4A4A4A", "align": "center", "margin": "lg", "wrap": true }, { "type": "text", "text": "æœŸå¾…å†æ¬¡ç‚ºæ‚¨æœå‹™ â¤ï¸", "size": "sm", "color": "#666666", "align": "center", "margin": "sm" } ];
                          } else {
                              bodyContents = [
                                { "type": "box", "layout": "vertical", "margin": "md", "spacing": "sm",
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "å®¢æˆ¶å§“å", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.contactName), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "è¯çµ¡é›»è©±", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.phone), "size": "xs", "color": "#666666", "align": "end", "flex": 4 } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "é ç´„æ—¥æœŸ", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.date), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": config.time, "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.time), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "vertical", "margin": "sm", "contents": [ { "type": "text", "text": config.location, "size": "xs", "color": "#aaaaaa" }, { "type": "text", "text": safeText(order.location), "size": "xs", "color": "#666666", "margin": "xs", "wrap": true, "weight": "bold" } ] }
                                    ]
                                },
                                { "type": "separator", "margin": "xl" },
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", 
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ 
                                            { "type": "text", "text": "ç¸½è¨ˆé‡‘é¡", "size": "sm", "color": "#aaaaaa", "flex": 2 }, 
                                            { "type": "text", "text": `NT$ ${total.toLocaleString()}`, "size": "sm", "color": "#666666", "align": "end", "flex": 3, "weight": "bold" } 
                                        ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ 
                                            { "type": "text", "text": "å·²æ”¶æ¬¾", "size": "sm", "color": "#10B981", "weight": "bold", "flex": 2 }, 
                                            { "type": "text", "text": `NT$ ${paid.toLocaleString()}`, "size": "sm", "color": "#10B981", "align": "end", "weight": "bold", "flex": 3 } 
                                        ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ 
                                            { "type": "text", "text": "å°šæ¬ å°¾æ¬¾", "size": "sm", "color": "#EF4444", "weight": "bold", "flex": 2 }, 
                                            { "type": "text", "text": `NT$ ${balance.toLocaleString()}`, "size": "sm", "color": "#EF4444", "align": "end", "weight": "bold", "flex": 3 } 
                                        ] }
                                    ]
                                }
                             ];
                          }
                      }

                      return {
                         "type": "bubble", "size": "mega",
                         "header": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": safeText(titleText), "weight": "bold", "color": statusColor, "size": "xs", "align": "center" } ], "paddingBottom": "none" },
                          "body": {
                              "type": "box", "layout": "vertical",
                              "contents": [
                                  { "type": "text", "text": `${config.icon} ${safeText(order.service)}`, "weight": "bold", "size": "xl", "align": "center", "color": "#4A4A4A", "wrap": true },
                                  { "type": "text", "text": safeText(descText), "size": "sm", "color": "#999999", "align": "center", "margin": "xs" },
                                  { "type": "separator", "margin": "md" },
                                  ...bodyContents
                              ]
                          },
                          "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "å¦‚æœ‰ä»»ä½•å•é¡Œè«‹éš¨æ™‚ç§è¨Šæˆ‘å€‘", "size": "xxs", "color": "#cccccc", "align": "center" } ] }
                      };
                };

                // âš¡ å°ˆé–€è² è²¬ç™¼é€ LINE è¨Šæ¯çš„å‡½å¼ (ä¿®æ­£ç‰ˆï¼šå‚³é€æ‰€æœ‰æ¬„ä½ + å¼·åˆ¶è¦†å¯«è¨­å®š)
                const sendToMake = async (payload, flex) => {
                    // 1. åˆä½µå®Œæ•´è³‡æ–™ï¼Œç¢ºä¿ Make æ”¶åˆ°æ‰€æœ‰æ¬„ä½ (è§£æ±º"è³‡æ–™å¾ˆå°‘"çš„å•é¡Œ)
                    // 2. å¼·åˆ¶è¨­å®š notifyMake ç‚º 'true'ï¼Œç¢ºä¿ Make æ”¶åˆ°æ­£ç¢ºè¨Šè™Ÿ
                    const makePayload = {
                        ...payload, // åŒ…å« orderId, service, date, time, price, balance ç­‰æ‰€æœ‰æ¬„ä½
                        
                        // Override specific fields for Make to ensure success
                        notifyMake: 'true', 
                        flexContents: flex, 
                        flexJson: JSON.stringify(flex), 
                        altText: payload.message ? payload.message.altText : 'æ–°é€šçŸ¥',
                        
                        // é¡å¤–ç¢ºä¿é€™äº›æ¬„ä½å­˜åœ¨
                        lineName: payload.lineName,
                        clientName: payload.clientName,
                        
                        // æ¨¡æ“¬ LINE Bot API æ ¼å¼ (å‚™ç”¨)
                        messages: [ 
                            { 
                                type: "flex", 
                                altText: payload.message ? payload.message.altText : 'æ–°é€šçŸ¥', 
                                contents: flex 
                            } 
                        ]
                    };

                    // 3. æ·±æ‹·è²ç§»é™¤ Vue Proxy æ®˜ç•™
                    const cleanBody = JSON.parse(JSON.stringify(makePayload));

                    console.log("Sending to Make (Full Payload):", cleanBody);

                    return fetch(SEND_MSG_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=UTF-8' },
                        body: JSON.stringify(cleanBody)
                    });
                };

                const updateOrderStatus = async (actionType) => {
                    const order = selectedOrder.value;
                    if (!order) return;
                    if (!order.userId) return Swal.fire('ç„¡æ³•ç™¼é€', 'æ­¤è¨‚å–®æ²’æœ‰æŠ“åˆ°å®¢äººçš„ LINE ID', 'warning');
                    
                    Swal.fire({
                        title: 'ç¢ºèªç™¼é€é€šçŸ¥ï¼Ÿ',
                        text: `å³å°‡ç™¼é€ LINE é€šçŸ¥çµ¦ ${order.contactName}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'ç¢ºå®šç™¼é€',
                        cancelButtonText: 'å–æ¶ˆ'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                Swal.fire({ title: 'è™•ç†ä¸­...', text: 'æ­£åœ¨ç™¼é€é€šçŸ¥ä¸¦æ›´æ–°è³‡æ–™', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                const flex = buildRichFlexMessage(order, actionType);
                                
                                let statusText = '';
                                if (actionType === 'CONFIRM') statusText = 'âœ… å·²ä»˜æ¬¾'; 
                                else if (actionType === 'PAYMENT_REQUEST') statusText = 'â³ ç­‰å¾…åŒ¯æ¬¾';
                                else if (actionType === 'COMPLETE') statusText = 'ğŸ å·²å®Œæˆ'; 
                                else if (actionType === 'CANCEL') statusText = 'âŒ å·²å–æ¶ˆ';
                                else if (actionType === 'REFUND') statusText = 'ğŸ’¸ å·²é€€æ¬¾';
                                else if (actionType === 'RESTORE') statusText = 'âŒ æœªä»˜æ¬¾';

                                const price = parseInt(order.rawPrice) || 0;
                                const received = parseInt(order.receivedPrice) || 0;
                                const balance = price - received;

                                const payload = {
                                    action: 'UPDATE_ORDER',
                                    orderId: order.oid,
                                    service: order.service,
                                    lineName: order.lineName,
                                    clientName: order.contactName, 
                                    phone: order.phone,
                                    date: order.date,
                                    time: order.time,
                                    location: order.location,
                                    status: statusText,
                                    price: price,
                                    received: received,
                                    balance: balance,
                                    createCalendarEvent: actionType === 'CONFIRM' ? 'true' : 'false',
                                    notifyMake: 'false', // â›” å‘Šè¨´ GAS ä¸è¦ç™¼é€ï¼Œå› ç‚ºæˆ‘å€‘è‡ªå·±ç™¼
                                    to: order.userId,
                                    message: { type: "flex", altText: `é€šçŸ¥ï¼š${order.service} ${statusText}`, contents: flex },
                                    flexContents: flex
                                };

                                // ğŸš€ å¹³è¡Œè™•ç†ï¼šåŒæ™‚ç™¼ LINE (å¿«ï¼Œå‚³é€å®Œæ•´è³‡æ–™) å’Œå­˜ GAS (æ…¢)
                                await Promise.all([
                                    sendToMake(payload, flex), 
                                    fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) }) 
                                ]);
                                
                                if (actionType === 'CONFIRM') order.status = 'CONFIRMED';
                                else if (actionType === 'PAYMENT_REQUEST') order.status = 'WAITING_PAYMENT';
                                else if (actionType === 'COMPLETE') order.status = 'COMPLETED';
                                else if (actionType === 'CANCEL') order.status = 'CANCELED';
                                else if (actionType === 'REFUND') order.status = 'REFUNDED';
                                else if (actionType === 'RESTORE') order.status = 'UNPAID';
                                
                                Swal.fire('æˆåŠŸ', 'é€šçŸ¥å·²é€å‡ºï¼', 'success');
                            } catch (e) { Swal.fire('éŒ¯èª¤', 'ç™¼é€å¤±æ•—ï¼š' + e.message, 'error'); }
                        }
                    });
                };
                
                const handlePriceFocus = () => { if (!isEditing.value) startEdit(); };
                const startEdit = () => { 
                    const formData = { ...selectedOrder.value };
                    if (formData.date && formData.date.includes('/')) formData.date = formData.date.replace(/\//g, '-');
                    editForm.value = formData; 
                    isEditing.value = true; 
                };
                const cancelEdit = () => { isEditing.value = false; editForm.value = {}; };
                
                // ğŸ”¥ ä¿®æ”¹å¾Œçš„å„²å­˜é‚è¼¯ (è§£æ±ºå•é¡Œ 1)
                const saveEdit = async () => {
                    // 1. å…ˆè©¢å•ä½¿ç”¨è€…æ„é¡˜
                    const { isConfirmed, isDenied } = await Swal.fire({
                        title: 'å„²å­˜è®Šæ›´',
                        text: 'æ‚¨å¸Œæœ›åŒæ™‚ç™¼é€ LINE é€šçŸ¥çµ¦å®¢äººå—ï¼Ÿ',
                        icon: 'question',
                        showDenyButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'å„²å­˜ä¸¦ç™¼é€é€šçŸ¥', // isConfirmed = true
                        denyButtonText: 'åƒ…å„²å­˜ (ä¸é€šçŸ¥)',   // isDenied = true
                        cancelButtonText: 'å–æ¶ˆ',
                        confirmButtonColor: '#10B981', // ç¶ è‰²
                        denyButtonColor: '#6B7280'     // ç°è‰²
                    });

                    if (!isConfirmed && !isDenied) return; // æŒ‰ä¸‹å–æ¶ˆ

                    const order = selectedOrder.value;
                    const shouldNotify = isConfirmed; // true=ç™¼é€, false=éœéŸ³

                    Swal.fire({ title: 'å„²å­˜ä¸­...', text: shouldNotify ? 'æ­£åœ¨æ›´æ–°ä¸¦ç™¼é€é€šçŸ¥...' : 'æ­£åœ¨å®‰éœå„²å­˜...', didOpen: () => Swal.showLoading() });
                    
                    let statusText = '';
                    if (order.status === 'CONFIRMED') statusText = 'âœ… å·²ä»˜æ¬¾';
                    else if (order.status === 'WAITING_PAYMENT') statusText = 'â³ ç­‰å¾…åŒ¯æ¬¾';
                    else if (order.status === 'UNPAID') statusText = 'âŒ æœªä»˜æ¬¾';
                    else if (order.status === 'COMPLETED') statusText = 'ğŸ å·²å®Œæˆ';

                    const flex = buildRichFlexMessage({ ...order, ...editForm.value }, 'UPDATE');
                    
                    const price = parseMoney(editForm.value.rawPrice);
                    const received = parseMoney(editForm.value.receivedPrice);
                    const balance = price - received;

                    const payload = {
                        action: 'UPDATE_ORDER',
                        orderId: order.oid,
                        service: order.service,
                        lineName: editForm.value.lineName,
                        clientName: editForm.value.contactName, 
                        phone: editForm.value.phone,
                        date: editForm.value.date,
                        time: editForm.value.time,
                        location: editForm.value.location,
                        status: statusText,
                        price: price,
                        received: received,
                        balance: balance,
                        
                        // é‚è¼¯æ§åˆ¶
                        createCalendarEvent: (order.status === 'CONFIRMED' || order.status === 'COMPLETED') ? 'true' : 'false',
                        notifyMake: 'false', // â›” å‘Šè¨´ GAS ä¸è¦ç™¼é€
                        
                        // é—œéµï¼šå¦‚æœé¸æ“‡ä¸é€šçŸ¥ï¼Œå°‡ to è¨­ç‚ºç©ºå­—ä¸²ï¼Œè®“ Make çš„ Filter æ“‹ä¸‹
                        to: shouldNotify ? order.userId : '', 
                        
                        message: shouldNotify ? { type: "flex", altText: `è³‡æ–™æ›´æ–°ï¼š${order.service}`, contents: flex } : null,
                        flexContents: shouldNotify ? flex : null
                    };

                    try {
                        const requests = [];
                        // 1. å­˜æª”åˆ° GAS (æ°¸é åŸ·è¡Œ)
                        requests.push(fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) }));

                        // 2. ç™¼é€ LINE åˆ° Make (ä¿®æ­£ï¼šç„¡è«–æ˜¯å¦é€šçŸ¥éƒ½ç™¼é€ï¼Œäº¤ç”± Make Filter æ±ºå®š)
                        // ä¹‹å‰æ˜¯ if (shouldNotify) { ... }
                        requests.push(sendToMake(payload, flex)); 

                        await Promise.all(requests);
                        
                        Object.assign(selectedOrder.value, editForm.value);
                        selectedOrder.value.contactName = editForm.value.contactName; 
                        selectedOrder.value.rawPrice = parseMoney(editForm.value.rawPrice);
                        selectedOrder.value.receivedPrice = parseMoney(editForm.value.receivedPrice);
                        isEditing.value = false;
                        Swal.fire('æˆåŠŸ', shouldNotify ? 'è³‡æ–™å·²æ›´æ–°ä¸¦ç™¼é€é€šçŸ¥ï¼' : 'è³‡æ–™å·²æ›´æ–° (æœªç™¼é€é€šçŸ¥)', 'success');
                    } catch (e) { Swal.fire('éŒ¯èª¤', e.message, 'error'); }
                };

                const showDebug = () => {
                    Swal.fire({
                        title: 'åŸå§‹è³‡æ–™è¨ºæ–·',
                        html: `<div class="debug-modal text-left"><p class="text-[10px] mb-2 font-bold text-red-500">æª¢æ¸¬åˆ° ${rawJsonData.value.length} ç­†è³‡æ–™</p><pre>${JSON.stringify(rawJsonData.value[0], null, 2)}</pre></div>`,
                        width: '600px'
                    });
                };

                // å°‡è‡ªå‹•æ›´æ–°é »ç‡æ”¹ç‚º 30 ç§’ (è§£æ±ºå•é¡Œ 3)
                onMounted(() => { fetchData(); setInterval(fetchData, 30000); });
                return { 
                    reservations, selectedOrder, filter, loading, errorMsg, filteredList, 
                    selectOrder, fetchData, updateOrderStatus, getStatusText, getLabel, showDebug,
                    isEditing, editForm, startEdit, cancelEdit, saveEdit, formatMoney, displayRawPrice, displayReceivedPrice,
                    isTimeSlotService, timeSlots, fillFullPayment, lastUpdated, handlePriceFocus,
                    // æ–°å¢çš„æœå°‹èˆ‡ç¯©é¸è®Šæ•¸
                    searchQuery, filterDate, filterService, clearFilters, configMap, highlightText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
