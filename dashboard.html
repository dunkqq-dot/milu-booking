<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU È†êÁ¥ÑÁÆ°ÁêÜÂæåÂè∞ (ÂÖçÂØÜÁ¢ºÁâà)</title>
    <!-- Ë≥áÊ∫êËºâÂÖ• -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
        .price-input:focus { border-color: #C69C6D; background-color: #fff; }
        .edit-input { width: 100%; border-bottom: 1px solid #ddd; background: transparent; padding: 2px 0; font-weight: bold; color: #4A4A4A; outline: none; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
        <!-- üìÇ Â∑¶ÂÅ¥ÂàóË°® -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10" :class="{'hidden md:flex': selectedOrder}">
            <!-- Header -->
            <div class="p-5 border-b border-gray-100 bg-[#F9F7F2]">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-milu-gold tracking-wide font-serif">MILU ADMIN</h1>
                        <p class="text-xs text-gray-400 mt-1">Ë®ÇÂñÆÊ†∏Â∞çÁ≥ªÁµ± (ÂÖçÂØÜÁ¢º)</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex gap-2">
                            <div class="text-xs px-2 py-1 bg-white rounded text-gray-400 border flex items-center gap-1" v-if="loading">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </div>
                            <button @click="fetchData" class="text-gray-400 hover:text-milu-gold transition" title="ÊâãÂãïÊõ¥Êñ∞">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                        <span class="text-[10px] text-gray-300">ÊúÄÂæåÊõ¥Êñ∞: {{ lastUpdated || 'ËºâÂÖ•‰∏≠...' }}</span>
                    </div>
                </div>
                <!-- ÈåØË™§Ë≠¶Âëä -->
                <div v-if="errorMsg" class="mt-2 p-2 bg-red-50 text-red-500 text-xs rounded border border-red-100 break-words font-bold">
                    ‚ö†Ô∏è {{ errorMsg }}
                </div>
            </div>

            <!-- ÈÅéÊøæÊ®ôÁ±§ -->
            <div class="flex p-2 gap-2 bg-gray-50 border-b border-gray-200 shrink-0 overflow-x-auto no-scrollbar">
                <button @click="filter = 'ALL'" :class="filter === 'ALL' ? 'bg-white text-milu-gold shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">ÂÖ®ÈÉ®</button>
                <button @click="filter = 'UNPAID'" :class="filter === 'UNPAID' ? 'bg-white text-red-500 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">Êú™‰ªòÊ¨æ</button>
                <button @click="filter = 'CONFIRMED'" :class="filter === 'CONFIRMED' ? 'bg-white text-green-600 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">Â∑≤‰ªòÊ¨æ</button>
            </div>

            <!-- Ë®ÇÂñÆÊ∏ÖÂñÆ -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div v-if="loading && reservations.length === 0" class="text-center py-10 text-gray-400 text-sm">ËºâÂÖ•‰∏≠...</div>
                <div v-else-if="filteredList.length === 0" class="text-center py-10 text-gray-400 text-sm">ÁõÆÂâçÁÑ°Áõ∏ÈóúË®ÇÂñÆ</div>

                <div v-for="order in filteredList" :key="order.oid" @click="selectOrder(order)" 
                     class="p-4 rounded-xl cursor-pointer transition-all bg-white border border-transparent hover:border-gray-200 card-shadow"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded">#{{ order.oid }}</span>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                              :class="{
                                  'bg-green-100 text-green-600': order.status === 'CONFIRMED',
                                  'bg-red-100 text-red-500': order.status === 'UNPAID',
                                  'bg-gray-200 text-gray-600': order.status === 'CANCELED',
                                  'bg-yellow-100 text-yellow-600': order.status === 'REFUNDED',
                                  'bg-blue-100 text-blue-600': order.status === 'COMPLETED',
                                  'bg-blue-400 text-white': order.status === 'WAITING_PAYMENT'
                              }">
                            {{ getStatusText(order.status) }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">{{ order.contactName }}</h3>
                        <span class="text-xs text-gray-400">{{ order.service }}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 mt-2 gap-3">
                        <span>üìÖ {{ order.date }}</span>
                        <span>‚è∞ {{ order.time }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîç Âè≥ÂÅ¥Ë©≥ÊÉÖ -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <!-- ÊâãÊ©üÁâàËøîÂõûÊåâÈàï -->
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto">
                <div class="min-h-full flex flex-col items-center justify-center p-4 md:p-10 py-16 md:py-10">
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md mx-auto">
                    
                        <!-- È†ÇÈÉ®ÁãÄÊÖãÂàó -->
                        <div class="h-28 flex items-center justify-center relative transition-colors duration-300"
                             :class="{
                                 'bg-[#10B981]': selectedOrder.status === 'CONFIRMED',
                                 'bg-[#EF4444]': selectedOrder.status === 'UNPAID',
                                 'bg-gray-500': selectedOrder.status === 'CANCELED',
                                 'bg-yellow-500': selectedOrder.status === 'REFUNDED',
                                 'bg-blue-500': selectedOrder.status === 'COMPLETED',
                                 'bg-blue-400': selectedOrder.status === 'WAITING_PAYMENT'
                             }">
                            
                            <button v-if="!isEditing" @click="startEdit" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-2 rounded-full backdrop-blur-sm">
                                <i class="fa-solid fa-pen text-sm"></i>
                            </button>
                            <div v-else class="absolute top-4 right-4 flex items-center gap-2">
                                <label class="flex items-center space-x-2 text-xs text-white/90 bg-black/20 px-2 py-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="notifyOnUpdate" class="rounded">
                                    <span>ÁôºÈÄÅÈÄöÁü•</span>
                                </label>
                                <button @click="saveEdit" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-bold">ÂÑ≤Â≠ò</button>
                                <button @click="cancelEdit" class="bg-white/20 text-white px-3 py-1 rounded-lg text-sm">ÂèñÊ∂à</button>
                            </div>

                            <div class="text-center text-white">
                                <div class="text-4xl mb-1">
                                    <i v-if="selectedOrder.status === 'CONFIRMED'" class="fa-solid fa-circle-check"></i>
                                    <i v-else-if="selectedOrder.status === 'CANCELED'" class="fa-solid fa-circle-xmark"></i>
                                    <i v-else-if="selectedOrder.status === 'WAITING_PAYMENT'" class="fa-solid fa-hourglass-half"></i>
                                    <i v-else class="fa-solid fa-circle-exclamation"></i>
                                </div>
                                <h2 class="text-lg font-bold tracking-widest opacity-90">{{ getStatusText(selectedOrder.status) }}</h2>
                            </div>
                        </div>

                        <!-- ÂÖßÂÆπÁ¥∞ÁØÄ -->
                        <div class="p-8 space-y-6">
                            <div class="flex justify-between border-b border-gray-100 pb-4">
                                <div class="flex-1 mr-4">
                                    <p class="text-xs text-gray-400 mb-1">ÂÆ¢Êà∂Ë≥áË®ä</p>
                                    <div v-if="isEditing">
                                        <input v-model="editForm.contactName" class="edit-input text-xl mb-1" placeholder="ÂÆ¢Êà∂ÂßìÂêç">
                                        <input v-model="editForm.phone" class="edit-input text-sm" placeholder="ÈõªË©±">
                                    </div>
                                    <div v-else>
                                        <p class="font-bold text-2xl text-gray-800">{{ selectedOrder.contactName }}</p>
                                        <p class="text-sm text-gray-600 mt-1">{{ selectedOrder.phone }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">È†êÁ¥ÑÊúçÂãô</p>
                                    <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-xl">
                                    <p class="text-xs text-gray-400 mb-1">Êó•Êúü</p>
                                    <input v-if="isEditing" type="date" v-model="editForm.date" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-xl">
                                    <p class="text-xs text-gray-400 mb-1">ÊôÇÈñì</p>
                                    <input v-if="isEditing" type="text" v-model="editForm.time" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                                </div>
                            </div>

                            <!-- ÈáëÈ°ç -->
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 space-y-3">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 font-bold">Á∏ΩÈáëÈ°ç</p>
                                    <div class="flex items-center">
                                        <span class="text-xs mr-1 text-gray-400">NT$</span>
                                        <input type="number" v-model.number="displayRawPrice" @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-gray-800 bg-transparent border-b border-gray-300 w-24 text-right focus:outline-none">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-green-600 font-bold">Â∑≤Êî∂Ê¨æ</p>
                                    <div class="flex items-center gap-2">
                                        <button @click="fillFullPayment" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded">‚ö°ÂÖ®È°ç</button>
                                        <span class="text-xs mr-1 text-green-600">NT$</span>
                                        <input type="number" v-model.number="displayReceivedPrice" @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-green-600 bg-transparent border-b border-green-200 w-24 text-right focus:outline-none">
                                    </div>
                                </div>
                            </div>

                            <!-- Âú∞Èªû -->
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <p class="text-xs text-gray-400 mb-1">È†êÁ¥ÑÂú∞Èªû / Ë©≥Á¥∞Ë≥áÊñô</p>
                                <input v-if="isEditing" type="text" v-model="editForm.location" class="edit-input">
                                <p v-else class="font-bold text-gray-600 text-sm break-words">{{ selectedOrder.location }}</p>
                            </div>

                            <!-- ÊåâÈàï -->
                            <div v-if="!isEditing" class="pt-2 space-y-3">
                                <button v-if="selectedOrder.status === 'UNPAID'" @click="updateOrderStatus('PAYMENT_REQUEST')" class="w-full bg-blue-500 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-envelope"></i> ÁôºÈÄÅÂåØÊ¨æÂ∏≥Ëôü
                                </button>
                                <button v-if="selectedOrder.status === 'UNPAID' || selectedOrder.status === 'WAITING_PAYMENT'" @click="updateOrderStatus('CONFIRM')" class="w-full bg-[#10B981] text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check-circle"></i> Á¢∫Ë™çÊî∂Ê¨æ‰∏¶ÁôªË®ò
                                </button>
                                <button v-if="selectedOrder.status === 'CONFIRMED'" @click="updateOrderStatus('COMPLETE')" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-flag-checkered"></i> ÂÆåÊàêË®ÇÂñÆ (ÁµêÊ°à)
                                </button>
                                <div class="flex gap-2" v-if="['CONFIRMED', 'UNPAID', 'WAITING_PAYMENT'].includes(selectedOrder.status)">
                                    <button @click="updateOrderStatus('CANCEL')" class="flex-1 bg-gray-400 text-white py-3 rounded-xl font-bold shadow">ÂèñÊ∂àË®ÇÂñÆ</button>
                                </div>
                                <div v-if="['CANCELED', 'COMPLETED', 'REFUNDED'].includes(selectedOrder.status)">
                                    <button @click="updateOrderStatus('RESTORE')" class="w-full bg-gray-500 text-white py-3 rounded-xl font-bold shadow">ÊÅ¢Âæ©Ë®ÇÂñÆ (ÈáçË®≠ÁÇ∫Êú™‰ªò)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                <p>Ë´ãÂæûÂ∑¶ÂÅ¥ÈªûÈÅ∏Ë®ÇÂñÆÊü•ÁúãË©≥ÊÉÖ</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const GAS_URL = 'https://script.google.com/macros/s/AKfycbwfAyj7ktWXv4gPoFo7wVPLn1_nQ6w0hX8kTToggetxt3jqqD7yp67cxlrg5l1N1rsLaA/exec';
                
                const reservations = ref([]);
                const selectedOrder = ref(null);
                const isEditing = ref(false);
                const editForm = ref({});
                const filter = ref('ALL');
                const loading = ref(false);
                const errorMsg = ref(null);
                const lastUpdated = ref(null);
                const notifyOnUpdate = ref(true);

                // üìñ ÊäìÂèñË≥áÊñô
                const fetchData = async () => {
                    if (isEditing.value) return;
                    loading.value = true;
                    errorMsg.value = null;

                    try {
                        const res = await fetch(`${GAS_URL}?mode=api&t=${Date.now()}`, { 
                            method: "GET",
                            referrerPolicy: "no-referrer"
                        });
                        
                        if (!res.ok) throw new Error("ÈÄ£Á∑öÂ§±ÊïóÔºöË´ãÊ™¢Êü• GAS ÈÉ®ÁΩ≤Ê¨äÈôêÊòØÂê¶Ë®≠ÁÇ∫„Äé‰ªª‰Ωï‰∫∫„Äè");
                        const text = await res.text();
                        let data;
                        try { data = JSON.parse(text); } catch (e) { throw new Error("Ë≥áÊñôÊ†ºÂºèÈåØË™§ÔºöÁ≥ªÁµ±ÂèØËÉΩÂõûÂÇ≥‰∫ÜÁôªÂÖ•È†ÅÈù¢ (Ë´ãÂú®ÁÑ°ÁóïË¶ñÁ™óË©¶Ë©¶Áúã)"); }

                        if (data.error) throw new Error(data.error);

                        // Ê†ºÂºèÂåñË≥áÊñô
                        reservations.value = data.filter(item => item[0] && item[3]).map((item, idx) => ({
                            oid: String(item[0]),
                            lineName: item[2] || '',
                            contactName: item[3] || 'ÁÑ°Âêç',
                            phone: item[4] || '',
                            date: String(item[5]).split('T')[0],
                            time: String(item[6]),
                            location: item[7] || '',
                            service: item[8] || '',
                            userId: item[9] || '',
                            status: mapRawStatus(item[10]),
                            rawPrice: parseInt(item[11]) || 0,
                            receivedPrice: parseInt(item[12]) || 0
                        })).sort((a, b) => new Date(b.date) - new Date(a.date));

                        lastUpdated.value = new Date().toLocaleTimeString();
                    } catch (e) {
                        errorMsg.value = e.message;
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                const mapRawStatus = (s) => {
                    s = String(s);
                    if (s.includes('Â∑≤‰ªòÊ¨æ') || s.includes('CONFIRMED')) return 'CONFIRMED';
                    if (s.includes('ÂèñÊ∂à') || s.includes('CANCELED')) return 'CANCELED';
                    if (s.includes('ÂÆåÊàê') || s.includes('COMPLETED')) return 'COMPLETED';
                    if (s.includes('Á≠âÂæÖ') || s.includes('WAITING')) return 'WAITING_PAYMENT';
                    return 'UNPAID';
                };

                const getStatusText = (status) => {
                    const map = {
                        'CONFIRMED': 'üü¢ Â∑≤‰ªòÊ¨æ', 'UNPAID': 'üî¥ Êú™‰ªòÊ¨æ', 
                        'CANCELED': '‚ö™ Â∑≤ÂèñÊ∂à', 'COMPLETED': 'üîµ Â∑≤ÂÆåÊàê', 
                        'WAITING_PAYMENT': 'üü° Á≠âÂæÖÂåØÊ¨æ', 'REFUNDED': 'üí∏ Â∑≤ÈÄÄÊ¨æ'
                    };
                    return map[status] || status;
                };

                const selectOrder = (order) => { if (!isEditing.value) selectedOrder.value = order; };

                const filteredList = computed(() => {
                    if (filter.value === 'ALL') return reservations.value;
                    if (filter.value === 'UNPAID') return reservations.value.filter(r => r.status === 'UNPAID' || r.status === 'WAITING_PAYMENT');
                    return reservations.value.filter(r => r.status === filter.value);
                });

                // ‚úèÔ∏è Á∑®ËºØÈÇèËºØ
                const startEdit = () => { editForm.value = { ...selectedOrder.value }; isEditing.value = true; };
                const cancelEdit = () => { isEditing.value = false; };
                const saveEdit = async () => {
                    Swal.fire({ title: 'ÂÑ≤Â≠ò‰∏≠...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    try {
                        const payload = {
                            action: 'UPDATE_ORDER',
                            orderId: editForm.value.oid,
                            service: editForm.value.service,
                            lineName: editForm.value.lineName,
                            clientName: editForm.value.contactName,
                            phone: editForm.value.phone,
                            date: editForm.value.date,
                            time: editForm.value.time,
                            location: editForm.value.location,
                            status: getStatusRawText(editForm.value.status),
                            price: editForm.value.rawPrice,
                            received: editForm.value.receivedPrice,
                            notifyMake: notifyOnUpdate.value ? 'true' : 'false'
                        };
                        await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                        Object.assign(selectedOrder.value, editForm.value);
                        isEditing.value = false;
                        Swal.fire('ÊàêÂäü', 'Ë≥áÊñôÂ∑≤Êõ¥Êñ∞', 'success');
                    } catch (e) { Swal.fire('ÈåØË™§', e.message, 'error'); }
                };

                const updateOrderStatus = async (type) => {
                    const order = selectedOrder.value;
                    let nextStatus = '';
                    if (type === 'PAYMENT_REQUEST') nextStatus = '‚è≥ Á≠âÂæÖÂåØÊ¨æ';
                    else if (type === 'CONFIRM') nextStatus = '‚úÖ Â∑≤‰ªòÊ¨æ';
                    else if (type === 'COMPLETE') nextStatus = 'üèÅ Â∑≤ÂÆåÊàê';
                    else if (type === 'CANCEL') nextStatus = '‚ùå Â∑≤ÂèñÊ∂à';
                    else if (type === 'RESTORE') nextStatus = '‚ùå Êú™‰ªòÊ¨æ';

                    Swal.fire({
                        title: 'Á¢∫Ë™çÂü∑Ë°åÔºü',
                        text: `Âç≥Â∞áËÆäÊõ¥ÁãÄÊÖãÁÇ∫ ${nextStatus}`,
                        icon: 'question',
                        showCancelButton: true
                    }).then(async (res) => {
                        if (res.isConfirmed) {
                            Swal.fire({ title: 'ËôïÁêÜ‰∏≠...', didOpen: () => Swal.showLoading() });
                            try {
                                const payload = {
                                    action: 'UPDATE_ORDER',
                                    orderId: order.oid,
                                    service: order.service,
                                    status: nextStatus,
                                    price: order.rawPrice,
                                    received: order.receivedPrice,
                                    notifyMake: 'true',
                                    createCalendarEvent: type === 'CONFIRM' ? 'true' : 'false'
                                };
                                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                                order.status = mapRawStatus(nextStatus);
                                Swal.fire('ÊàêÂäü', 'Â∑≤Êõ¥Êñ∞‰∏¶ÁôºÈÄÅÈÄöÁü•', 'success');
                            } catch (e) { Swal.fire('ÈåØË™§', e.message, 'error'); }
                        }
                    });
                };

                const getStatusRawText = (s) => {
                    const map = { 'CONFIRMED': '‚úÖ Â∑≤‰ªòÊ¨æ', 'UNPAID': '‚ùå Êú™‰ªòÊ¨æ', 'CANCELED': '‚ùå Â∑≤ÂèñÊ∂à', 'COMPLETED': 'üèÅ Â∑≤ÂÆåÊàê', 'WAITING_PAYMENT': '‚è≥ Á≠âÂæÖÂåØÊ¨æ' };
                    return map[s] || '‚ùå Êú™‰ªòÊ¨æ';
                };

                const formatMoney = (n) => n ? n.toLocaleString() : '0';
                const fillFullPayment = () => { if (isEditing.value) editForm.value.receivedPrice = editForm.value.rawPrice; else selectedOrder.value.receivedPrice = selectedOrder.value.rawPrice; };
                const handlePriceFocus = () => { if (!isEditing.value) startEdit(); };

                const displayRawPrice = computed({
                    get: () => isEditing.value ? editForm.value.rawPrice : (selectedOrder.value ? selectedOrder.value.rawPrice : 0),
                    set: (v) => { if (isEditing.value) editForm.value.rawPrice = v; }
                });
                const displayReceivedPrice = computed({
                    get: () => isEditing.value ? editForm.value.receivedPrice : (selectedOrder.value ? selectedOrder.value.receivedPrice : 0),
                    set: (v) => { if (isEditing.value) editForm.value.receivedPrice = v; }
                });

                const showDebug = () => {
                    Swal.fire({
                        title: 'Á≥ªÁµ±Ë®∫Êñ∑',
                        html: `<div class="text-left text-xs bg-gray-100 p-3 rounded font-mono">GAS URL: ${GAS_URL.substring(0, 40)}...<br>Orders: ${reservations.value.length}</div>`
                    });
                };

                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 10000);
                });

                return {
                    reservations, selectedOrder, filter, loading, errorMsg, filteredList,
                    selectOrder, fetchData, getStatusText, startEdit, cancelEdit, saveEdit,
                    isEditing, editForm, updateOrderStatus, formatMoney, fillFullPayment,
                    lastUpdated, handlePriceFocus, displayRawPrice, displayReceivedPrice,
                    notifyOnUpdate, showDebug
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
