<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU é ç´„ç®¡ç†å¾Œå°</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ SweetAlert2 (ç”¨æ–¼ç™¼é€æˆåŠŸçš„æç¤ºï¼Œè‹¥ç„¡æœƒä½¿ç”¨ fallback) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
        <!-- å·¦å´é¸å–® (è¨‚å–®åˆ—è¡¨) -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10" :class="{'hidden md:flex': selectedOrder}">
            
            <!-- Header -->
            <div class="p-5 border-b border-gray-100 bg-[#F9F7F2]">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-milu-gold tracking-wide font-serif">MILU ADMIN</h1>
                        <p class="text-xs text-gray-400 mt-1">å³æ™‚é ç´„ç®¡ç†ç³»çµ±</p>
                    </div>
                    <div class="text-xs px-2 py-1 bg-white rounded text-gray-400 border" v-if="loading">æ›´æ–°ä¸­...</div>
                    <button @click="fetchData" v-else class="text-gray-400 hover:text-milu-gold transition"><i class="fa-solid fa-rotate-right"></i> åˆ·æ–°</button>
                </div>
                
                <!-- éŒ¯èª¤è¨Šæ¯æç¤ºå€ -->
                <div v-if="errorMsg" class="mt-2 p-2 bg-red-50 text-red-500 text-xs rounded border border-red-100 break-words">
                    <p class="font-bold mb-1">âš ï¸ é€£ç·šç‹€æ³ï¼š</p>
                    {{ errorMsg }}
                    <p class="mt-1 text-gray-400">(ç›®å‰é¡¯ç¤ºç¯„ä¾‹è³‡æ–™)</p>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="flex p-2 gap-2 bg-gray-50 border-b border-gray-200 shrink-0">
                <button @click="filter = 'ALL'" :class="filter === 'ALL' ? 'bg-white text-milu-gold shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">å…¨éƒ¨</button>
                <button @click="filter = 'UNPAID'" :class="filter === 'UNPAID' ? 'bg-white text-red-500 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">æœªä»˜æ¬¾</button>
                <button @click="filter = 'CONFIRMED'" :class="filter === 'CONFIRMED' ? 'bg-white text-green-600 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">å·²ç¢ºèª</button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div v-if="filteredList.length === 0" class="text-center py-10 text-gray-400 text-sm">
                    æ²’æœ‰ç›¸é—œè¨‚å–®
                </div>

                <div v-for="order in filteredList" :key="order.oid" @click="selectOrder(order)" 
                     class="p-4 rounded-xl cursor-pointer transition-all bg-white border border-transparent hover:border-gray-200 card-shadow"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded">#{{ order.oid }}</span>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold"
                              :class="order.status === 'CONFIRMED' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'">
                            {{ order.status === 'CONFIRMED' ? 'å·²ç¢ºèª' : 'æœªä»˜æ¬¾' }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">{{ order.clientName }}</h3>
                        <span class="text-xs text-gray-400">{{ order.service }}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 mt-2 gap-3">
                        <span class="flex items-center gap-1">ğŸ“… {{ order.date }}</span>
                        <span class="flex items-center gap-1">â° {{ order.time }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´è©³æƒ… (Detail View) -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <!-- æ‰‹æ©Ÿç‰ˆè¿”å›æŒ‰éˆ• -->
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">
                    â¬…
                </button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto p-4 md:p-10 flex items-center justify-center">
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md">
                    
                    <!-- å¡ç‰‡ç‹€æ…‹é ­éƒ¨ -->
                    <div class="h-28 flex items-center justify-center transition-colors duration-300"
                         :class="selectedOrder.status === 'CONFIRMED' ? 'bg-[#10B981]' : 'bg-[#EF4444]'">
                        <div class="text-center text-white">
                            <div class="text-4xl mb-1">
                                {{ selectedOrder.status === 'CONFIRMED' ? 'âœ“' : '!' }}
                            </div>
                            <h2 class="text-lg font-bold tracking-widest opacity-90">
                                {{ selectedOrder.status === 'CONFIRMED' ? 'PAYMENT CONFIRMED' : 'WAITING FOR PAYMENT' }}
                            </h2>
                        </div>
                    </div>

                    <!-- å¡ç‰‡å…§å®¹ -->
                    <div class="p-8 space-y-6">
                        <div class="flex justify-between border-b border-gray-100 pb-4">
                            <div>
                                <p class="text-xs text-gray-400 mb-1">CUSTOMER</p>
                                <p class="font-bold text-xl text-gray-800">{{ selectedOrder.clientName }}</p>
                                <p class="text-xs text-gray-500 mt-1 font-mono">{{ selectedOrder.userId ? 'IDå·²ç¶å®š' : 'æœªç¶å®šID' }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400 mb-1">SERVICE</p>
                                <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <p class="text-xs text-gray-400 mb-1">DATE</p>
                                <p class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <p class="text-xs text-gray-400 mb-1">TIME</p>
                                <p class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center">
                             <div>
                                <p class="text-xs text-gray-400 mb-1">TOTAL</p>
                                <p class="font-bold text-xl text-gray-800">NT$ {{ selectedOrder.price }}</p>
                             </div>
                             <div class="text-right">
                                <p class="text-xs text-gray-400 mb-1">PHONE</p>
                                <p class="font-bold text-gray-600 text-sm">{{ selectedOrder.phone }}</p>
                             </div>
                        </div>

                        <!-- å‹•ä½œæŒ‰éˆ• -->
                        <div class="pt-2 space-y-3">
                            <button @click="sendNotification" class="w-full bg-milu-dark text-white py-3.5 rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                ğŸ“² ç™¼é€é ç´„ç¢ºèªé€šçŸ¥
                            </button>
                            
                            <p class="text-center text-xs text-gray-400 pt-2">
                                * è‹¥è¦ä¿®æ”¹ç‹€æ…‹ï¼Œè«‹ç›´æ¥åœ¨ Google è©¦ç®—è¡¨æ“ä½œä¸¦åˆ·æ–°
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-300">
                <div class="text-6xl mb-4">ğŸ“‚</div>
                <p>è«‹å¾å·¦å´é¸æ“‡ä¸€ç­†è¨‚å–®æŸ¥çœ‹è©³æƒ…</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        // Mock Data structure (ç•¶ fetch å¤±æ•—æ™‚é¡¯ç¤ºçš„ç¯„ä¾‹è³‡æ–™)
        const MOCK_RESERVATIONS = [
            { id: 'mock1', clientName: 'ç‹å°ç¾ (ç¯„ä¾‹)', phone: '0912-345-678', service: 'å°ˆäººä½ˆç½®', date: '2025-12-25', time: '14:30', status: 'UNPAID', oid: 'M0001', rawPrice: '3000' },
            { id: 'mock2', clientName: 'é™³å¤§æ˜ (ç¯„ä¾‹)', phone: '0988-111-222', service: 'æ°£çƒå¤–é€', date: '2025-12-26', time: '10:00', status: 'CONFIRMED', oid: 'M0002', rawPrice: '1500' },
        ];

        createApp({
            setup() {
                // âœ… è®€å–è³‡æ–™ç”¨çš„ Webhook (Make: Dashboard Data API)
                const DATA_API_URL = 'https://hook.eu1.make.com/299dlrz8g64ecrg8q0obdpxhbkkxo5nj'; 
                // âœ… ç™¼é€é€šçŸ¥ç”¨çš„ Webhook (Make: OA Sender)
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/mhwhl6m6nqii8zfbv9p3ggz2ih12dpt6';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const filter = ref('ALL');
                const loading = ref(true);
                const errorMsg = ref(null);

                // è®€å–è³‡æ–™
                const fetchData = async () => {
                    loading.value = true;
                    errorMsg.value = null;
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ç§’è¶…æ™‚

                        const res = await fetch(DATA_API_URL, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        
                        if (!res.ok) {
                            throw new Error(`HTTP Error: ${res.status}`);
                        }

                        const textData = await res.text();
                        let data;
                        try {
                            data = JSON.parse(textData);
                        } catch (e) {
                            if (textData.trim() === "Accepted") {
                                throw new Error("Make å›å‚³ 'Accepted'ã€‚è«‹æª¢æŸ¥ Make åŠ‡æœ¬æ˜¯å¦å·²é–‹å•Ÿ (ON)ï¼Œä¸¦ä¸”æœ€å¾Œæœ‰ 'Webhook Response' æ¨¡çµ„ã€‚");
                            }
                            throw new Error("Make å›å‚³æ ¼å¼éŒ¯èª¤ (é JSON)ã€‚");
                        }
                        
                        // è³‡æ–™è½‰æ›
                        const formattedData = data.map((item, index) => ({
                            id: index.toString(), 
                            oid: item['A'] || `M-${index}`,
                            clientName: item['D'] || item['C'] || 'æœªçŸ¥å®¢æˆ¶', 
                            service: item['C'] || item['D'] || 'æœå‹™',    
                            date: (item['P'] || item['date'] || '').split('T')[0],
                            time: item['Q'] || item['time'] || '',
                            phone: item['G'] || item['phone'] || '',
                            userId: item['L'] || item['userId'] || '',
                            status: (item['ä»˜æ¬¾ç‹€æ…‹'] && item['ä»˜æ¬¾ç‹€æ…‹'].includes('å·²ä»˜æ¬¾')) ? 'CONFIRMED' : 'UNPAID',
                            rawPrice: item['M'] || item['price'] || '0',
                            location: item['F'] || 'ç„¡åœ°å€'
                        })).sort((a, b) => new Date(b.date) - new Date(a.date));

                        reservations.value = formattedData;
                        
                        if (formattedData.length > 0 && !selectedOrder.value) {
                             selectedOrder.value = formattedData[0];
                        }
                    } catch (e) {
                        console.error("Fetch Error:", e);
                        // é¡¯ç¤ºç¯„ä¾‹è³‡æ–™ä»¥å…ç•«é¢å…¨ç™½
                        reservations.value = MOCK_RESERVATIONS;
                        if (!selectedOrder.value) selectedOrder.value = MOCK_RESERVATIONS[0];
                        
                        let msg = e.message;
                        if (e.name === 'AbortError') msg = "é€£ç·šé€¾æ™‚ï¼ŒMake å›æ‡‰å¤ªæ…¢ã€‚";
                        if (msg.includes('Failed to fetch')) msg = "é€£ç·šå¤±æ•— (å¯èƒ½ç‚º CORS è·¨åŸŸé˜»æ“‹)ã€‚è«‹åœ¨ Make 'Webhook Response' æ¨¡çµ„æ–°å¢ Header: 'Access-Control-Allow-Origin' = '*'ã€‚";
                        
                        errorMsg.value = msg;
                    }
                    loading.value = false;
                };

                // ç™¼é€é€šçŸ¥
                const sendNotification = async () => {
                    const order = selectedOrder.value;
                    if (!order || !order.userId) {
                        return Swal.fire('ç„¡æ³•ç™¼é€', 'æ­¤è¨‚å–®æ²’æœ‰ User ID (å¯èƒ½æ˜¯èˆŠè¨‚å–®æˆ–æ¬Šé™æœªé–‹)', 'error');
                    }
                    
                    Swal.fire({ title: 'ç™¼é€ä¸­...', didOpen: () => Swal.showLoading() });

                    const payload = {
                        to: order.userId,
                        orderId: order.oid,
                        clientName: order.clientName,
                        service: order.service,
                        price: order.rawPrice,
                        date: order.date,
                        time: order.time,
                        phone: order.phone,
                        location: order.location,
                        // ç°¡åŒ–ç‰ˆ messageï¼Œå¯¦éš›å…§å®¹ç”± Make æ±ºå®š
                        message: { type: 'flex', altText: `âœ… æ‚¨çš„${order.service}é ç´„å·²ç¢ºèªï¼`, contents: {} } 
                    };
                    
                    try {
                        await fetch(SEND_MSG_WEBHOOK, {
                            method: 'POST',
                            mode: 'no-cors', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        Swal.fire('å·²ç™¼é€', 'æŒ‡ä»¤å·²ç™¼é€è‡³ Makeï¼Œè«‹æª¢æŸ¥ LINE', 'success');
                    } catch (e) {
                        Swal.fire('éŒ¯èª¤', e.message, 'error');
                    }
                };

                const selectOrder = (order) => {
                    selectedOrder.value = order;
                };

                const filteredList = computed(() => {
                    if (filter.value === 'ALL') return reservations.value;
                    return reservations.value.filter(r => r.status === filter.value);
                });

                onMounted(() => {
                    fetchData();
                    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
                    setInterval(fetchData, 30000); 
                });

                return {
                    reservations,
                    selectedOrder,
                    filter,
                    loading,
                    errorMsg,
                    filteredList,
                    selectOrder,
                    fetchData,
                    sendNotification
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
