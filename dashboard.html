<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU 預約管理後台</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <!-- 引入 SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- 引入 Vue.js (讓我們能輕鬆處理資料顯示) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
        <!-- 左側選單 (訂單列表) -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10" :class="{'hidden md:flex': selectedOrder}">
            
            <!-- Header -->
            <div class="p-5 border-b border-gray-100 bg-[#F9F7F2]">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-milu-gold tracking-wide font-serif">MILU ADMIN</h1>
                        <p class="text-xs text-gray-400 mt-1">即時預約管理系統</p>
                    </div>
                    <div class="text-xs px-2 py-1 bg-white rounded text-gray-400 border" v-if="loading">更新中...</div>
                    <button @click="fetchData" v-else class="text-gray-400 hover:text-milu-gold transition"><i class="fa-solid fa-rotate-right"></i> 刷新</button>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="flex p-2 gap-2 bg-gray-50 border-b border-gray-200 shrink-0">
                <button @click="filter = 'ALL'" :class="filter === 'ALL' ? 'bg-white text-milu-gold shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">全部</button>
                <button @click="filter = 'UNPAID'" :class="filter === 'UNPAID' ? 'bg-white text-red-500 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">未付款</button>
                <button @click="filter = 'CONFIRMED'" :class="filter === 'CONFIRMED' ? 'bg-white text-green-600 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all">已確認</button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div v-if="filteredList.length === 0" class="text-center py-10 text-gray-400 text-sm">
                    沒有相關訂單
                </div>

                <div v-for="order in filteredList" :key="order.oid" @click="selectOrder(order)" 
                     class="p-4 rounded-xl cursor-pointer transition-all bg-white border border-transparent hover:border-gray-200 card-shadow"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded">#{{ order.oid }}</span>
                        <span class="text-[10px] px-2 py-1 rounded-full font-bold"
                              :class="order.status === 'CONFIRMED' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-500'">
                            {{ order.status === 'CONFIRMED' ? '已確認' : '未付款' }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">{{ order.clientName }}</h3>
                        <span class="text-xs text-gray-400">{{ order.service }}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 mt-2 gap-3">
                        <span class="flex items-center gap-1"><i class="fa-regular fa-calendar"></i> {{ order.date }}</span>
                        <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> {{ order.time }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側詳情 (Detail View) -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <!-- 手機版返回按鈕 -->
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto p-4 md:p-10 flex items-center justify-center">
                <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md">
                    
                    <!-- 卡片狀態頭部 -->
                    <div class="h-28 flex items-center justify-center transition-colors duration-300"
                         :class="selectedOrder.status === 'CONFIRMED' ? 'bg-[#10B981]' : 'bg-[#EF4444]'">
                        <div class="text-center text-white">
                            <div class="text-4xl mb-1">
                                <i :class="selectedOrder.status === 'CONFIRMED' ? 'fa-solid fa-circle-check' : 'fa-solid fa-circle-exclamation'"></i>
                            </div>
                            <h2 class="text-lg font-bold tracking-widest opacity-90">
                                {{ selectedOrder.status === 'CONFIRMED' ? 'PAYMENT CONFIRMED' : 'WAITING FOR PAYMENT' }}
                            </h2>
                        </div>
                    </div>

                    <!-- 卡片內容 -->
                    <div class="p-8 space-y-6">
                        <div class="flex justify-between border-b border-gray-100 pb-4">
                            <div>
                                <p class="text-xs text-gray-400 mb-1">CUSTOMER</p>
                                <p class="font-bold text-xl text-gray-800">{{ selectedOrder.clientName }}</p>
                                <p class="text-xs text-gray-500 mt-1 font-mono">{{ selectedOrder.userId ? 'ID已綁定' : '未綁定ID' }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-400 mb-1">SERVICE</p>
                                <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <p class="text-xs text-gray-400 mb-1">DATE</p>
                                <p class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <p class="text-xs text-gray-400 mb-1">TIME</p>
                                <p class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center">
                             <div>
                                <p class="text-xs text-gray-400 mb-1">TOTAL</p>
                                <p class="font-bold text-xl text-gray-800">NT$ {{ selectedOrder.price }}</p>
                             </div>
                             <div class="text-right">
                                <p class="text-xs text-gray-400 mb-1">PHONE</p>
                                <p class="font-bold text-gray-600 text-sm">{{ selectedOrder.phone }}</p>
                             </div>
                        </div>

                        <!-- 動作按鈕 -->
                        <div class="pt-2 space-y-3">
                            <button @click="sendNotification" class="w-full bg-milu-dark text-white py-3.5 rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2 shadow-lg active:scale-95">
                                <i class="fa-brands fa-line text-xl"></i> 發送預約確認通知
                            </button>
                            
                            <p class="text-center text-xs text-gray-400 pt-2">
                                * 若要修改狀態，請直接在 Google 試算表操作並刷新
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="flex-1 flex flex-col items-center justify-center text-gray-300">
                <i class="fa-regular fa-folder-open text-6xl mb-4"></i>
                <p>請從左側選擇一筆訂單查看詳情</p>
            </div>
        </div>
    </div>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ⚠️ 設定：請填入您的 Make Webhook 網址
                const DATA_API_URL = 'https://hook.eu1.make.com/299dlrz8g64ecrg8q0obdpxhbkkxo5nj'; 
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/mhwhl6m6nqii8zfbv9p3ggz2ih12dpt6';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const filter = ref('ALL');
                const loading = ref(true);

                // 讀取資料
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(DATA_API_URL);
                        if (!res.ok) throw new Error('API Error');
                        const data = await res.json();
                        
                        // 轉換資料格式 (Mapping)
                        const formatted = data.map((item, idx) => ({
                            oid: item['A'] || `M-${idx}`,
                            clientName: item['D'] || item['C'] || '未知客戶', // 假設姓名在 D 欄 (請依實際調整)
                            service: item['C'] || item['D'] || '服務',    // 假設服務在 C 欄
                            date: (item['P'] || '').split('T')[0],
                            time: item['Q'] || '',
                            phone: item['G'] || '',
                            userId: item['L'] || '',
                            price: item['M'] || '0',
                            // 判斷狀態：若付款狀態欄位包含"已付款"則為 CONFIRMED
                            status: (item['付款狀態'] && item['付款狀態'].includes('已付款')) ? 'CONFIRMED' : 'UNPAID',
                            location: item['F'] || '無地址' // 假設地址在 F 欄
                        })).sort((a, b) => new Date(b.date) - new Date(a.date));

                        reservations.value = formatted;
                        
                        // 如果有選中的訂單，更新它
                        if (selectedOrder.value) {
                            const updated = formatted.find(r => r.oid === selectedOrder.value.oid);
                            if (updated) selectedOrder.value = updated;
                        }
                    } catch (e) {
                        console.error(e);
                        Swal.fire('連線錯誤', '無法讀取 Google Sheets 資料，請檢查 Make。', 'error');
                    }
                    loading.value = false;
                };

                // 發送通知
                const sendNotification = async () => {
                    const order = selectedOrder.value;
                    if (!order || !order.userId) return Swal.fire('錯誤', '找不到此客戶的 LINE ID', 'error');

                    Swal.fire({ title: '發送中...', didOpen: () => Swal.showLoading() });

                    // 這裡的 payload 要跟 admin.html 裡的一樣
                    const payload = {
                        to: order.userId,
                        orderId: order.oid,
                        clientName: order.clientName,
                        service: order.service,
                        price: order.price,
                        // 讓 Make 去組裝卡片
                        message: { 
                            type: 'flex', 
                            altText: `✅ 您的${order.service}預約已確認！`, 
                            contents: {} 
                        },
                        // 如果您的 admin.html 有用 buildProfessionalFlex，Make 端需要這些變數
                        // 這裡傳送純資料，Make 需設定好接收變數
                        date: order.date,
                        time: order.time,
                        phone: order.phone,
                        location: order.location
                    };

                    try {
                        await fetch(SEND_MSG_WEBHOOK, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        Swal.fire('成功', '發送指令已送出', 'success');
                    } catch (e) {
                        Swal.fire('失敗', e.message, 'error');
                    }
                };

                const selectOrder = (order) => {
                    selectedOrder.value = order;
                };

                const filteredList = computed(() => {
                    if (filter.value === 'ALL') return reservations.value;
                    return reservations.value.filter(r => r.status === filter.value);
                });

                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 30000); // 每30秒自動更新
                });

                return {
                    reservations,
                    selectedOrder,
                    filter,
                    loading,
                    filteredList,
                    selectOrder,
                    fetchData,
                    sendNotification
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
