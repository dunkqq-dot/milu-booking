<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU é ç´„ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
        .debug-modal pre { white-space: pre-wrap; word-wrap: break-word; font-size: 11px; color: #333; max-height: 400px; overflow-y: auto; background: #f1f1f1; padding: 15px; border-radius: 5px; text-align: left; }
        .price-input:focus { border-color: #C69C6D; background-color: #fff; }
        .edit-input { width: 100%; border-bottom: 1px solid #ddd; background: transparent; padding: 2px 0; font-weight: bold; color: #4A4A4A; }
        
        /* è‡ªå®šç¾© SweetAlert æŒ‰éˆ•æ¨£å¼ */
        .swal2-confirm { background-color: #10B981 !important; } /* ç¶ è‰² */
        .swal2-deny { background-color: #6B7280 !important; } /* ç°è‰² */

        /* æ¨¡æ“¬åŸæœ¬å…§æ–‡éºæ¼æˆ–éœ€è¦çš„æ—¥æ›†é¸ä¸­æ¨£å¼ */
        .calendar-selected { background-color: #C69C6D !important; color: white !important; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
          <!-- å·¦å´å´é‚Šæ¬„ï¼šæœå°‹ + æ—¥æ›† + åˆ—è¡¨ -->
        <aside class="w-full md:w-80 border-r bg-white flex flex-col z-30 transition-all shrink-0" 
               :class="{'hidden md:flex': selectedOrder}">
            
            <!-- æœå°‹æ¬„ -->
            <div class="p-4 border-b space-y-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold text-milu-gold tracking-tighter">MILU ADMIN</h1>
                    <button @click="fetchData" class="text-xs text-gray-400 hover:text-milu-gold transition">
                        <i class="fa-solid fa-rotate" :class="{'animate-spin': loading}"></i> åˆ·æ–°
                    </button>
                </div>
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-300 text-sm"></i>
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹å§“åã€é›»è©±..." 
                           class="w-full pl-9 pr-4 py-2.5 bg-gray-100 rounded-xl outline-none focus:ring-2 ring-milu-gold/20 text-sm font-medium">
                </div>
            </div>

            <!-- æ—¥æ›†å…ƒä»¶ (ç°¡åŒ–æ¨¡æ“¬) -->
            <div class="p-4 border-b bg-gray-50/50" v-if="!searchQuery">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-sm text-gray-600">{{ currentMonthYear || '2024å¹´ 5æœˆ' }}</h3>
                    <div class="flex gap-1">
                        <button class="p-1.5 hover:bg-white rounded-lg transition"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                        <button class="p-1.5 hover:bg-white rounded-lg transition"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
                <!-- é€™è£¡ä¿ç•™æ‚¨çš„ grid çµæ§‹ -->
                <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-black text-gray-300 mb-1">
                    <div v-for="d in ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']" :key="d">{{ d }}</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
                    <div v-for="n in 31" :key="n" 
                         class="h-8 rounded-lg flex flex-col items-center justify-center cursor-pointer transition-all relative text-[11px] font-bold hover:bg-white text-gray-600">
                        {{ n }}
                    </div>
                </div>
            </div>

            <!-- ç‹€æ…‹æ¨™ç±¤ -->
            <div class="flex p-2 gap-1 bg-white border-b overflow-x-auto no-scrollbar">
                <button v-for="st in ['ALL', 'UNPAID', 'CONFIRMED', 'COMPLETED']" 
                        :key="st" @click="filter = st"
                        class="px-3 py-1.5 text-[11px] font-bold rounded-full transition-all whitespace-nowrap border"
                        :class="filter === st ? 'bg-milu-gold text-white border-milu-gold' : 'bg-gray-50 text-gray-400 border-gray-100'">
                    {{ st === 'ALL' ? 'å…¨éƒ¨' : (st === 'UNPAID' ? 'å¾…ä»˜æ¬¾' : (st === 'CONFIRMED' ? 'å·²ç¢ºèª' : 'å·²å®Œæˆ')) }}
                </button>
            </div>

            <!-- åˆ—è¡¨å€ -->
            <div class="flex-1 overflow-y-auto no-scrollbar bg-gray-50/30">
                <div v-if="filteredList.length === 0" class="p-10 text-center text-gray-300 text-xs italic">
                    <i class="fa-regular fa-folder-open text-2xl mb-2 block opacity-20"></i>
                    ç„¡ç¬¦åˆæ¢ä»¶çš„è¨‚å–®
                </div>
                <div v-for="order in filteredList" :key="order.oid" 
                     @click="selectOrder(order)" 
                     class="p-4 border-b cursor-pointer hover:bg-milu-light transition-all bg-white relative"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    <div class="flex justify-between mb-1 font-mono text-[10px] text-gray-400">
                        <span>#{{ order.oid }}</span>
                        <span>{{ order.date }}</span>
                    </div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-sm font-bold text-gray-800" v-html="highlightText(order.contactName)"></h3>
                            <p class="text-[11px] text-gray-500 mt-0.5">{{ order.service }} Â· {{ order.time }}</p>
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold" 
                              :class="{
                                  'bg-green-100 text-green-600': order.status === 'CONFIRMED',
                                  'bg-red-100 text-red-500': order.status === 'UNPAID',
                                  'bg-blue-100 text-blue-600': order.status === 'COMPLETED'
                              }">
                            {{ getStatusText(order.status) }}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- é è…³è³‡è¨Š -->
            <div class="p-3 border-t bg-white text-[10px] text-gray-400 flex justify-between">
                <span>æœ€å¾Œæ›´æ–°: {{ lastUpdated || 'å°šæœªæ›´æ–°' }}</span>
                <span>å…± {{ filteredList.length }} ç­†</span>
            </div>
        </aside>

        <!-- å³å´è©³æƒ… -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">â¬…</button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto relative">
                <div class="min-h-full flex flex-col items-center justify-center p-4 md:p-10 py-16 md:py-10">
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md mx-auto">
                    
                        <div class="h-28 flex items-center justify-center transition-colors duration-300 relative"
                             :class="{
                                  'bg-[#10B981]': selectedOrder.status === 'CONFIRMED',
                                  'bg-[#EF4444]': selectedOrder.status === 'UNPAID',
                                  'bg-gray-500': selectedOrder.status === 'CANCELED',
                                  'bg-yellow-500': selectedOrder.status === 'REFUNDED',
                                  'bg-blue-500': selectedOrder.status === 'COMPLETED',
                                  'bg-blue-400': selectedOrder.status === 'WAITING_PAYMENT'
                             }">
                            
                            <!-- ç·¨è¼¯æ¨¡å¼æŒ‰éˆ•å€ -->
                            <button v-if="!isEditing" @click="startEdit" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition backdrop-blur-sm" title="ç·¨è¼¯è³‡æ–™">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <div v-else class="absolute top-4 right-4 flex items-center gap-2">
                                <button @click="saveEdit" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-sm shadow font-bold flex items-center gap-1">
                                    <i class="fa-solid fa-floppy-disk"></i> å„²å­˜
                                </button>
                                <button @click="cancelEdit" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg text-sm backdrop-blur-sm">
                                    å–æ¶ˆ
                                </button>
                            </div>

                            <div class="text-center text-white">
                                <div class="text-4xl mb-1">
                                    <i v-if="selectedOrder.status === 'CONFIRMED'" class="fa-solid fa-circle-check"></i>
                                    <i v-else-if="selectedOrder.status === 'CANCELED'" class="fa-solid fa-circle-xmark"></i>
                                    <i v-else-if="selectedOrder.status === 'COMPLETED'" class="fa-solid fa-flag-checkered"></i>
                                    <i v-else class="fa-solid fa-circle-exclamation"></i>
                                </div>
                                <h2 class="text-lg font-bold tracking-widest opacity-90">
                                    {{ getStatusText(selectedOrder.status, true) }}
                                </h2>
                            </div>
                        </div>

                        <div class="p-8 space-y-6 relative">
                            <div v-if="isEditing" class="absolute top-0 left-0 w-full h-1 bg-yellow-400 animate-pulse"></div>

                            <!-- å®¢æˆ¶è³‡è¨Š -->
                            <div class="flex justify-between border-b border-gray-100 pb-4">
                                <div class="flex-1 mr-4">
                                    <p class="text-xs text-gray-400 mb-1">CUSTOMER</p>
                                    <div v-if="isEditing">
                                        <label class="text-[10px] text-gray-400">LINEåç¨±</label>
                                        <input v-model="editForm.lineName" class="edit-input text-sm mb-1" placeholder="LINEåç¨±">
                                        <label class="text-[10px] text-gray-400">è¯çµ¡äººå§“å</label>
                                        <input v-model="editForm.contactName" class="edit-input text-xl mb-1" placeholder="è¯çµ¡äººå§“å">
                                        <label class="text-[10px] text-gray-400">é›»è©±</label>
                                        <input v-model="editForm.phone" class="edit-input text-sm" placeholder="é›»è©±">
                                    </div>
                                    <div v-else>
                                        <p class="text-lg text-gray-400 font-bold mb-1 flex items-center gap-2">
                                            <i class="fa-brands fa-line text-green-500 text-xl"></i> {{ selectedOrder.lineName }}
                                        </p>
                                        <p class="font-bold text-2xl text-gray-800">{{ selectedOrder.contactName }}</p>
                                        <p class="text-sm text-gray-600 mt-2 flex items-center gap-1">
                                            <i class="fa-solid fa-phone text-xs"></i> {{ selectedOrder.phone }}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">SERVICE</p>
                                    <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                                </div>
                            </div>

                            <!-- æ™‚é–“æ—¥æœŸ -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                    <p class="text-xs text-gray-400 mb-1">DATE</p>
                                    <input v-if="isEditing" type="date" v-model="editForm.date" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                    <p class="text-xs text-gray-400 mb-1">{{ getLabel('time', selectedOrder.service) }}</p>
                                    <template v-if="isEditing">
                                        <select v-if="isTimeSlotService(selectedOrder.service)" v-model="editForm.time" class="edit-input">
                                            <option value="" disabled>è«‹é¸æ“‡æ™‚æ®µ</option>
                                            <option v-for="slot in timeSlots" :key="slot" :value="slot">{{ slot }}</option>
                                        </select>
                                        <input v-else type="time" v-model="editForm.time" class="edit-input">
                                    </template>
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                                </div>
                            </div>
                            
                            <!-- æ¬¾é …æ˜ç´° -->
                            <div class="bg-yellow-50/50 p-4 rounded-xl border border-yellow-100 space-y-3">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 font-bold">ç¸½é‡‘é¡ (å¡«å…¥å ±åƒ¹)</p>
                                    <div class="flex items-center">
                                        <span class="text-xs mr-1 text-gray-400">NT$</span>
                                        <input type="number" v-model.number="displayRawPrice" 
                                               @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-gray-800 bg-transparent border-b border-gray-300 w-24 text-right focus:outline-none" 
                                               placeholder="0">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-xs text-green-600 font-bold">å·²æ”¶æ¬¾ (å°å¸³)</p>
                                    <div class="flex items-center gap-2">
                                        <button @click="fillFullPayment" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 transition">
                                            âš¡åŒä¸Š
                                        </button>
                                        <span class="text-xs mr-1 text-green-600">NT$</span>
                                        <input type="number" v-model.number="displayReceivedPrice" 
                                               @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-green-600 bg-transparent border-b border-green-200 w-24 text-right focus:outline-none" 
                                               placeholder="0">
                                    </div>
                                </div>
                                <div class="border-t pt-2 flex justify-between items-center border-yellow-200">
                                    <p class="text-xs text-red-500 font-bold">å°šæ¬ å°¾æ¬¾</p>
                                    <p class="font-bold text-xl text-red-500">
                                        NT$ {{ formatMoney(displayRawPrice - displayReceivedPrice) }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- åœ°å€ -->
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                 <p class="text-xs text-gray-400 mb-1">{{ getLabel('location', selectedOrder.service) }}</p>
                                 <input v-if="isEditing" type="text" v-model="editForm.location" class="edit-input">
                                 <p v-else class="font-bold text-gray-600 text-sm break-words">{{ selectedOrder.location }}</p>
                            </div>

                            <!-- å‹•ä½œæŒ‰éˆ• -->
                            <div v-if="!isEditing" class="pt-2 space-y-3">
                                <button v-if="selectedOrder.status === 'UNPAID'" @click="updateOrderStatus('PAYMENT_REQUEST')" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3.5 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-envelope mr-1"></i> (é¸ç”¨) ç™¼é€ä»˜æ¬¾é ˆçŸ¥ & å¸³è™Ÿ
                                </button>

                                <button v-if="selectedOrder.status === 'UNPAID' || selectedOrder.status === 'WAITING_PAYMENT'" @click="updateOrderStatus('CONFIRM')" class="w-full bg-[#10B981] hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg transition shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check-circle"></i> ç¢ºèªæ”¶æ¬¾ä¸¦ç™»è¨˜
                                </button>
                                
                                <div v-if="selectedOrder.status === 'CONFIRMED'" class="space-y-2">
                                    <button @click="updateOrderStatus('COMPLETE')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold transition shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-flag-checkered"></i> å®Œæˆè¨‚å–® (çµæ¡ˆ)
                                    </button>
                                </div>

                                <p class="text-center text-xs text-gray-400 pt-2">* é»æ“ŠæŒ‰éˆ•å°‡åŒæ­¥æ›´æ–°è©¦ç®—è¡¨èˆ‡ç™¼é€ LINE é€šçŸ¥</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                <p>è«‹å¾å·¦å´é¸æ“‡ä¸€ç­†è¨‚å–®æŸ¥çœ‹è©³æƒ…</p>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const configMap = {
            'å°ˆäººä½ˆç½®': { time: 'é€²å ´ä½ˆç½®æ™‚é–“', location: 'ä½ˆç½®åœ°å€', icon: 'âœ¨' },
            'å·¥ä½œå®¤å–è²¨': { time: 'å–è²¨æ™‚é–“', location: 'å–è²¨é–€å¸‚', icon: 'ğŸ›’' },
            'å¾Œè»Šå»‚ä½ˆç½®': { time: 'æŠµé”æ™‚é–“', location: 'æ–½ä½œåœ°é»', icon: 'ğŸš—' },
            'æ°£çƒå¤–é€': { time: 'å¤–é€æ™‚æ®µ', location: 'å¤–é€åœ°å€', icon: 'ğŸšš' }
        };

        const timeSlots = [
            "12:30 - 13:30", "13:00 - 14:00", "14:00 - 15:00", "15:00 - 16:00", 
            "16:00 - 17:00", "17:00 - 18:00", "18:00 - 19:00"
        ];

        createApp({
            setup() {
                const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwfAyj7ktWXv4gPoFo7wVPLn1_nQ6w0hX8kTToggetxt3jqqD7yp67cxlrg5l1N1rsLaA/exec'; 
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/63u0kheb71v9vengzdggfy1ga7r8gmng';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const isEditing = ref(false);
                const editForm = ref({});
                const filter = ref('ALL');
                
                const searchQuery = ref('');
                const filterDate = ref('');
                const filterService = ref('');

                const loading = ref(true);
                const errorMsg = ref(null);
                const rawJsonData = ref(null);
                const lastUpdated = ref(null);

                const safeText = (text) => (text && String(text).trim() !== '') ? String(text) : ' ';
                const formatMoney = (val) => (!val && val !== 0) ? '0' : val.toLocaleString();
                const parseMoney = (val) => {
                    if (!val) return 0;
                    const str = String(val).replace(/[^\d.-]/g, '');
                    return parseInt(str) || 0;
                };

                const isTimeSlotService = (service) => service && (service.includes('å¤–é€') || service.includes('è‡ªå–') || service.includes('å–è²¨'));

                const displayRawPrice = computed({
                    get: () => isEditing.value ? editForm.value.rawPrice : (selectedOrder.value ? selectedOrder.value.rawPrice : 0),
                    set: (val) => {
                        if (isEditing.value) editForm.value.rawPrice = val;
                        else if (selectedOrder.value) selectedOrder.value.rawPrice = val;
                    }
                });

                const displayReceivedPrice = computed({
                    get: () => isEditing.value ? editForm.value.receivedPrice : (selectedOrder.value ? selectedOrder.value.receivedPrice : 0),
                    set: (val) => {
                        if (isEditing.value) editForm.value.receivedPrice = val;
                        else if (selectedOrder.value) selectedOrder.value.receivedPrice = val;
                    }
                });

                const fillFullPayment = () => {
                    if (isEditing.value) editForm.value.receivedPrice = editForm.value.rawPrice;
                    else if (selectedOrder.value) selectedOrder.value.receivedPrice = selectedOrder.value.rawPrice;
                };

                const fetchData = async () => {
                    if (isEditing.value) return;
                    loading.value = true;
                    // é€™è£¡æ¨¡æ“¬ä¸€äº›è³‡æ–™ä¾›é è¦½
                    const mockData = [
                        { oid: 'M-1001', lineName: 'å°æ˜', contactName: 'ç‹å°æ˜', phone: '0912345678', service: 'å°ˆäººä½ˆç½®', date: '2024-05-20', time: '14:00', location: 'å°åŒ—å¸‚å¤§å®‰å€...', status: 'UNPAID', rawPrice: 5000, receivedPrice: 0, userId: 'U123' },
                        { oid: 'M-1002', lineName: 'é›…å©·', contactName: 'é™³é›…å©·', phone: '0987654321', service: 'å·¥ä½œå®¤å–è²¨', date: '2024-05-21', time: '10:00', location: 'ä¿¡ç¾©åº—', status: 'CONFIRMED', rawPrice: 1200, receivedPrice: 1200, userId: 'U456' }
                    ];
                    reservations.value = mockData;
                    if (!selectedOrder.value && mockData.length > 0) selectedOrder.value = mockData[0];
                    loading.value = false;
                    lastUpdated.value = new Date().toLocaleTimeString();
                };

                const getStatusText = (status, isEnglish = false) => {
                    if (isEnglish) return status === 'CONFIRMED' ? 'PAYMENT CONFIRMED' : (status === 'COMPLETED' ? 'ORDER COMPLETED' : 'WAITING FOR PAYMENT');
                    return status === 'CONFIRMED' ? 'å·²ä»˜æ¬¾' : (status === 'COMPLETED' ? 'å·²å®Œæˆ' : (status === 'CANCELED' ? 'å·²å–æ¶ˆ' : (status === 'REFUNDED' ? 'å·²é€€æ¬¾' : (status === 'WAITING_PAYMENT' ? 'ç­‰å¾…åŒ¯æ¬¾' : 'æœªä»˜æ¬¾'))));
                };

                const getLabel = (type, service) => (configMap[service] || configMap['å°ˆäººä½ˆç½®'])[type];
                const selectOrder = (order) => { if(!isEditing.value) selectedOrder.value = order; };

                const filteredList = computed(() => {
                    let result = reservations.value;
                    if (filter.value === 'UNPAID') result = result.filter(r => r.status === 'UNPAID' || r.status === 'WAITING_PAYMENT');
                    else if (filter.value !== 'ALL') result = result.filter(r => r.status === filter.value);

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(r => r.contactName.toLowerCase().includes(q) || r.phone.includes(q));
                    }
                    return result;
                });

                const highlightText = (text) => {
                    if (!text) return '';
                    if (!searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="bg-yellow-200 text-black">$1</span>');
                };

                const updateOrderStatus = async (actionType) => {
                    Swal.fire('ç™¼é€é€šçŸ¥', 'æ­¤ç‚ºé è¦½æ¨¡å¼ï¼ŒåŠŸèƒ½å·²é€£çµè‡³ï¼š' + actionType, 'info');
                };
                
                const handlePriceFocus = () => { if (!isEditing.value) startEdit(); };
                const startEdit = () => { 
                    editForm.value = { ...selectedOrder.value }; 
                    isEditing.value = true; 
                };
                const cancelEdit = () => { isEditing.value = false; };
                
                const saveEdit = async () => {
                    const { isConfirmed, isDenied } = await Swal.fire({
                        title: 'å„²å­˜è®Šæ›´',
                        text: 'æ‚¨å¸Œæœ›åŒæ™‚ç™¼é€ LINE é€šçŸ¥çµ¦å®¢äººå—ï¼Ÿ',
                        icon: 'question',
                        showDenyButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'å„²å­˜ä¸¦ç™¼é€é€šçŸ¥',
                        denyButtonText: 'åƒ…å„²å­˜ (ä¸é€šçŸ¥)',
                        cancelButtonText: 'å–æ¶ˆ'
                    });

                    if (isConfirmed || isDenied) {
                        Object.assign(selectedOrder.value, editForm.value);
                        isEditing.value = false;
                        Swal.fire('æˆåŠŸ', 'è³‡æ–™å·²æ›´æ–°', 'success');
                    }
                };

                onMounted(() => { fetchData(); });

                return { 
                    reservations, selectedOrder, filter, loading, errorMsg, filteredList, 
                    selectOrder, fetchData, updateOrderStatus, getStatusText, getLabel,
                    isEditing, editForm, startEdit, cancelEdit, saveEdit, formatMoney, displayRawPrice, displayReceivedPrice,
                    isTimeSlotService, timeSlots, fillFullPayment, lastUpdated, handlePriceFocus,
                    searchQuery, filterDate, filterService, highlightText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
