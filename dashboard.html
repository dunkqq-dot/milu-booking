<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MILU È†êÁ¥ÑÁÆ°ÁêÜÂæåÂè∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; height: 100vh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .active-item { background-color: #FDFbf7; border-left: 4px solid #C69C6D; }
        [v-cloak] { display: none; }
        .debug-modal pre { white-space: pre-wrap; word-wrap: break-word; font-size: 11px; color: #333; max-height: 400px; overflow-y: auto; background: #f1f1f1; padding: 15px; border-radius: 5px; text-align: left; }
        .price-input:focus { border-color: #C69C6D; background-color: #fff; }
        .edit-input { width: 100%; border-bottom: 1px solid #ddd; background: transparent; padding: 2px 0; font-weight: bold; color: #4A4A4A; outline: none; }
    </style>
</head>
<body id="app" v-cloak>

    <div class="flex h-full">
        <!-- üìÇ Â∑¶ÂÅ¥ÂàóË°® -->
        <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full z-10" :class="{'hidden md:flex': selectedOrder}">
            <!-- Header -->
            <div class="p-4 border-b border-gray-100 bg-[#F9F7F2] space-y-3">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold text-milu-gold tracking-wide font-serif">MILU ADMIN</h1>
                        <p class="text-xs text-gray-400 mt-1">Ë®ÇÂñÆÊ†∏Â∞çÁ≥ªÁµ±</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex gap-2">
                            <button @click="showDebug" class="text-xs px-2 py-1 bg-gray-200 rounded text-gray-600 hover:bg-gray-300">üîç Ë®∫Êñ∑</button>
                            <div class="text-xs px-2 py-1 bg-white rounded text-gray-400 border flex items-center gap-1" v-if="loading">
                                <i class="fa-solid fa-circle-notch fa-spin"></i> Êõ¥Êñ∞‰∏≠...
                            </div>
                            <button @click="fetchData" v-else class="text-gray-400 hover:text-milu-gold transition" title="ÊâãÂãïÊõ¥Êñ∞">
                                <i class="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                        <span v-if="lastUpdated" class="text-[10px] text-gray-300">Êõ¥Êñ∞: {{ lastUpdated }}</span>
                    </div>
                </div>

                <!-- üîç ÊêúÂ∞ãËàáÈÄ≤ÈöéÁØ©ÈÅ∏ÂçÄÂ°ä -->
                <div class="bg-white p-2 rounded-lg border border-gray-200 space-y-2">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-300 text-xs"></i>
                        <input type="text" v-model="searchQuery" placeholder="ÊêúÂ∞ãÂßìÂêç„ÄÅÈõªË©±„ÄÅLINE..." 
                               class="w-full pl-8 pr-2 py-1.5 text-xs bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold focus:bg-white transition">
                        <button v-if="searchQuery" @click="searchQuery = ''" class="absolute right-2 top-2 text-gray-300 hover:text-gray-500">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="date" v-model="filterDate" class="flex-1 text-xs px-2 py-1.5 bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold text-gray-500">
                        <select v-model="filterService" class="flex-1 text-xs px-2 py-1.5 bg-gray-50 border border-gray-100 rounded focus:outline-none focus:border-milu-gold text-gray-500">
                            <option value="">ÊâÄÊúâÊúçÂãô</option>
                            <option v-for="(conf, key) in configMap" :key="key" :value="key">{{ key }}</option>
                        </select>
                        <button v-if="filterDate || filterService" @click="clearFilters" class="px-2 text-gray-400 hover:text-red-400" title="Ê∏ÖÈô§ÁØ©ÈÅ∏">
                            <i class="fa-solid fa-filter-circle-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- ÈåØË™§Ë≠¶Âëä -->
                <div v-if="errorMsg" class="p-2 bg-red-50 text-red-500 text-xs rounded border border-red-100 break-words font-bold">
                    ‚ö†Ô∏è {{ errorMsg }}
                </div>
            </div>

            <!-- ÈÅéÊøæÊ®ôÁ±§ -->
            <div class="flex p-2 gap-2 bg-gray-50 border-b border-gray-200 shrink-0 overflow-x-auto no-scrollbar">
                <button @click="filter = 'ALL'" :class="filter === 'ALL' ? 'bg-white text-milu-gold shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">ÂÖ®ÈÉ®</button>
                <button @click="filter = 'UNPAID'" :class="filter === 'UNPAID' ? 'bg-white text-red-500 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">Êú™‰ªòÊ¨æ</button>
                <button @click="filter = 'CONFIRMED'" :class="filter === 'CONFIRMED' ? 'bg-white text-green-600 shadow-sm border' : 'text-gray-400'" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap px-4">Â∑≤‰ªòÊ¨æ</button>
            </div>

            <!-- Ë®ÇÂñÆÊ∏ÖÂñÆ -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                <div v-if="loading && reservations.length === 0" class="text-center py-10 text-gray-400 text-sm">ËºâÂÖ•‰∏≠...</div>
                <div v-else-if="filteredList.length === 0" class="text-center py-10 text-gray-400 text-sm">ÁõÆÂâçÁÑ°Áõ∏ÈóúË®ÇÂñÆ</div>

                <div v-for="order in filteredList" :key="order.oid" @click="selectOrder(order)" 
                     class="p-4 rounded-xl cursor-pointer transition-all bg-white border border-transparent hover:border-gray-200 card-shadow"
                     :class="{'active-item': selectedOrder && selectedOrder.oid === order.oid}">
                    
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-gray-400 bg-gray-100 px-1 rounded">#{{ order.oid }}</span>
                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                              :class="{
                                  'bg-green-100 text-green-600': order.status === 'CONFIRMED',
                                  'bg-red-100 text-red-500': order.status === 'UNPAID',
                                  'bg-gray-200 text-gray-600': order.status === 'CANCELED',
                                  'bg-yellow-100 text-yellow-600': order.status === 'REFUNDED',
                                  'bg-blue-100 text-blue-600': order.status === 'COMPLETED',
                                  'bg-blue-400 text-white': order.status === 'WAITING_PAYMENT'
                              }">
                            {{ getStatusText(order.status) }}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">
                             <span v-html="highlightText(order.contactName)"></span>
                        </h3>
                        <span class="text-xs text-gray-400">{{ order.service }}</span>
                    </div>
                    <div class="flex items-center text-xs text-gray-500 mt-2 gap-3">
                        <span>üìÖ {{ order.date }}</span>
                        <span>‚è∞ {{ order.time }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîç Âè≥ÂÅ¥Ë©≥ÊÉÖ -->
        <div class="w-full md:w-2/3 bg-[#F9F9F9] flex flex-col relative h-full" :class="{'hidden md:flex': !selectedOrder}">
            
            <!-- ÊâãÊ©üÁâàËøîÂõûÊåâÈàï -->
            <div class="md:hidden absolute top-4 left-4 z-20">
                <button @click="selectedOrder = null" class="bg-white p-2 rounded-full shadow text-gray-500">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>

            <div v-if="selectedOrder" class="flex-1 overflow-y-auto">
                <div class="min-h-full flex flex-col items-center justify-center p-4 md:p-10 py-16 md:py-10">
                    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden w-full max-w-md mx-auto">
                    
                        <!-- È†ÇÈÉ®ÁãÄÊÖãÂàó -->
                        <div class="h-28 flex items-center justify-center relative transition-colors duration-300"
                             :class="{
                                 'bg-[#10B981]': selectedOrder.status === 'CONFIRMED',
                                 'bg-[#EF4444]': selectedOrder.status === 'UNPAID',
                                 'bg-gray-500': selectedOrder.status === 'CANCELED',
                                 'bg-yellow-500': selectedOrder.status === 'REFUNDED',
                                 'bg-blue-500': selectedOrder.status === 'COMPLETED',
                                 'bg-blue-400': selectedOrder.status === 'WAITING_PAYMENT'
                             }">
                            
                            <!-- Á∑®ËºØÊ®°ÂºèÊåâÈàï -->
                            <button v-if="!isEditing" @click="startEdit" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white p-2 rounded-full backdrop-blur-sm">
                                <i class="fa-solid fa-pen text-sm"></i>
                            </button>
                            <div v-else class="absolute top-4 right-4 flex items-center gap-2">
                                <label class="flex items-center space-x-2 text-xs text-white/90 bg-black/20 px-2 py-1 rounded cursor-pointer">
                                    <input type="checkbox" v-model="notifyOnUpdate" class="rounded">
                                    <span>ÁôºÈÄÅÈÄöÁü•</span>
                                </label>
                                <button @click="saveEdit" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-bold">ÂÑ≤Â≠ò</button>
                                <button @click="cancelEdit" class="bg-white/20 text-white px-3 py-1 rounded-lg text-sm">ÂèñÊ∂à</button>
                            </div>

                            <div class="text-center text-white">
                                <div class="text-4xl mb-1">
                                    <i v-if="selectedOrder.status === 'CONFIRMED'" class="fa-solid fa-circle-check"></i>
                                    <i v-else-if="selectedOrder.status === 'CANCELED'" class="fa-solid fa-circle-xmark"></i>
                                    <i v-else-if="selectedOrder.status === 'REFUNDED'" class="fa-solid fa-money-bill-transfer"></i>
                                    <i v-else-if="selectedOrder.status === 'COMPLETED'" class="fa-solid fa-flag-checkered"></i>
                                    <i v-else-if="selectedOrder.status === 'WAITING_PAYMENT'" class="fa-solid fa-hourglass-half"></i>
                                    <i v-else class="fa-solid fa-circle-exclamation"></i>
                                </div>
                                <h2 class="text-lg font-bold tracking-widest opacity-90">{{ getStatusText(selectedOrder.status) }}</h2>
                            </div>
                        </div>

                        <!-- ÂÖßÂÆπÁ¥∞ÁØÄ -->
                        <div class="p-8 space-y-6">
                            <div class="flex justify-between border-b border-gray-100 pb-4">
                                <div class="flex-1 mr-4">
                                    <p class="text-xs text-gray-400 mb-1">ÂÆ¢Êà∂Ë≥áË®ä</p>
                                    <div v-if="isEditing">
                                        <input v-model="editForm.contactName" class="edit-input text-xl mb-1" placeholder="ÂÆ¢Êà∂ÂßìÂêç">
                                        <input v-model="editForm.phone" class="edit-input text-sm" placeholder="ÈõªË©±">
                                    </div>
                                    <div v-else>
                                        <p class="font-bold text-2xl text-gray-800">{{ selectedOrder.contactName }}</p>
                                        <p class="text-sm text-gray-600 mt-1">{{ selectedOrder.phone }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400 mb-1">È†êÁ¥ÑÊúçÂãô</p>
                                    <p class="font-bold text-lg text-milu-gold">{{ selectedOrder.service }}</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-xl">
                                    <p class="text-xs text-gray-400 mb-1">Êó•Êúü</p>
                                    <input v-if="isEditing" type="date" v-model="editForm.date" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.date }}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-xl">
                                    <p class="text-xs text-gray-400 mb-1">ÊôÇÈñì</p>
                                    <input v-if="isEditing" type="text" v-model="editForm.time" class="edit-input">
                                    <p v-else class="font-bold text-gray-700">{{ selectedOrder.time }}</p>
                                </div>
                            </div>

                            <!-- ÈáëÈ°ç -->
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 space-y-3">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-gray-500 font-bold">Á∏ΩÈáëÈ°ç</p>
                                    <div class="flex items-center">
                                        <span class="text-xs mr-1 text-gray-400">NT$</span>
                                        <input type="number" v-model.number="displayRawPrice" @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-gray-800 bg-transparent border-b border-gray-300 w-24 text-right focus:outline-none" placeholder="0">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-green-600 font-bold">Â∑≤Êî∂Ê¨æ</p>
                                    <div class="flex items-center gap-2">
                                        <button @click="fillFullPayment" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded">‚ö°ÂÖ®È°ç</button>
                                        <span class="text-xs mr-1 text-green-600">NT$</span>
                                        <input type="number" v-model.number="displayReceivedPrice" @focus="handlePriceFocus"
                                               class="price-input font-bold text-lg text-green-600 bg-transparent border-b border-green-200 w-24 text-right focus:outline-none">
                                    </div>
                                </div>
                                <div class="border-t pt-2 flex justify-between items-center border-yellow-200">
                                    <p class="text-xs text-red-500 font-bold">Â∞öÊ¨†Â∞æÊ¨æ</p>
                                    <p class="font-bold text-xl text-red-500">NT$ {{ formatMoney(displayRawPrice - displayReceivedPrice) }}</p>
                                </div>
                            </div>
                            
                            <!-- Âú∞Èªû -->
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <p class="text-xs text-gray-400 mb-1">È†êÁ¥ÑÂú∞Èªû / Ë©≥Á¥∞Ë≥áÊñô</p>
                                <input v-if="isEditing" type="text" v-model="editForm.location" class="edit-input">
                                <p v-else class="font-bold text-gray-600 text-sm break-words">{{ selectedOrder.location }}</p>
                            </div>

                            <!-- ÊåâÈàï -->
                            <div v-if="!isEditing" class="pt-2 space-y-3">
                                <button v-if="selectedOrder.status === 'UNPAID'" @click="updateOrderStatus('PAYMENT_REQUEST')" class="w-full bg-blue-500 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-envelope"></i> ÁôºÈÄÅÂåØÊ¨æÂ∏≥Ëôü
                                </button>
                                <button v-if="selectedOrder.status === 'UNPAID' || selectedOrder.status === 'WAITING_PAYMENT'" @click="updateOrderStatus('CONFIRM')" class="w-full bg-[#10B981] text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-check-circle"></i> Á¢∫Ë™çÊî∂Ê¨æ‰∏¶ÁôªË®ò
                                </button>
                                <button v-if="selectedOrder.status === 'CONFIRMED'" @click="updateOrderStatus('COMPLETE')" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-flag-checkered"></i> ÂÆåÊàêË®ÇÂñÆ (ÁµêÊ°à)
                                </button>
                                <div class="flex gap-2" v-if="['CONFIRMED', 'UNPAID', 'WAITING_PAYMENT'].includes(selectedOrder.status)">
                                    <button @click="updateOrderStatus('CANCEL')" class="flex-1 bg-gray-400 text-white py-3 rounded-xl font-bold shadow">ÂèñÊ∂àË®ÇÂñÆ</button>
                                </div>
                                <div v-if="['CANCELED', 'COMPLETED', 'REFUNDED'].includes(selectedOrder.status)">
                                    <button @click="updateOrderStatus('RESTORE')" class="w-full bg-gray-500 text-white py-3 rounded-xl font-bold shadow">ÊÅ¢Âæ©Ë®ÇÂñÆ (ÈáçË®≠ÁÇ∫Êú™‰ªò)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                <p>Ë´ãÂæûÂ∑¶ÂÅ¥ÈªûÈÅ∏Ë®ÇÂñÆÊü•ÁúãË©≥ÊÉÖ</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        const configMap = {
            'Â∞à‰∫∫‰ΩàÁΩÆ': { time: 'ÈÄ≤Â†¥‰ΩàÁΩÆÊôÇÈñì', location: '‰ΩàÁΩÆÂú∞ÂùÄ', icon: '‚ú®' },
            'Â∑•‰ΩúÂÆ§ÂèñË≤®': { time: 'ÂèñË≤®ÊôÇÈñì', location: 'ÂèñË≤®ÈñÄÂ∏Ç', icon: 'üõí' },
            'ÂæåËªäÂªÇ‰ΩàÁΩÆ': { time: 'ÊäµÈÅîÊôÇÈñì', location: 'ÊñΩ‰ΩúÂú∞Èªû', icon: 'üöó' },
            'Ê∞£ÁêÉÂ§ñÈÄÅ': { time: 'Â§ñÈÄÅÊôÇÊÆµ', location: 'Â§ñÈÄÅÂú∞ÂùÄ', icon: 'üöö' }
        };

        const timeSlots = [
            "12:30 - 13:00", "13:00 - 14:00", "14:00 - 15:00", "15:00 - 16:00", 
            "16:00 - 17:00", "17:00 - 18:00", "18:00 - 19:00"
        ];

        createApp({
            setup() {
                // ‚ö†Ô∏è Ëá™Âãï‰ΩøÁî®ÊÇ®Êèê‰æõÁöÑ GAS URL
                const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwfAyj7ktWXv4gPoFo7wVPLn1_nQ6w0hX8kTToggetxt3jqqD7yp67cxlrg5l1N1rsLaA/exec';
                const SEND_MSG_WEBHOOK = 'https://hook.eu1.make.com/63u0kheb71v9vengzdggfy1ga7r8gmng';

                const reservations = ref([]);
                const selectedOrder = ref(null);
                const isEditing = ref(false);
                const editForm = ref({});
                const filter = ref('ALL');
                const loading = ref(false);
                const errorMsg = ref(null);
                const lastUpdated = ref(null);
                const notifyOnUpdate = ref(true);
                
                // üîç Êñ∞Â¢ûÔºöÁØ©ÈÅ∏ËÆäÊï∏
                const searchQuery = ref('');
                const filterDate = ref('');
                const filterService = ref('');

                // üìñ Ê†ºÂºèÂåñÊôÇÈñì (‰øÆÂæ© 1899 ÈåØË™§)
                const formatTime = (timeVal) => {
                    if (!timeVal) return '';
                    const timeStr = String(timeVal);
                    if (timeStr.includes('1899') || timeStr.includes('T')) {
                        try {
                            const d = new Date(timeStr);
                            if (isNaN(d.getTime())) return timeStr;
                            // UTC+8 ÊôÇÈñì‰øÆÊ≠£
                            let hours = d.getUTCHours() + 8;
                            if (hours >= 24) hours -= 24;
                            const minutes = d.getUTCMinutes();
                            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                        } catch(e) { return timeStr; }
                    }
                    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
                    if (match) return `${match[1].padStart(2, '0')}:${match[2]}`;
                    return timeStr;
                };

                // üìñ Ê†ºÂºèÂåñÊó•Êúü (‰øÆÂæ©ÊôÇÂçÄ)
                const formatGASDate = (val) => {
                    if (!val) return '';
                    const s = String(val);
                    if (s.includes('T')) {
                        const d = new Date(s);
                        if (isNaN(d.getTime())) return s;
                        const offset = 8 * 60 * 60 * 1000;
                        const taiwanDate = new Date(d.getTime() + offset);
                        const y = taiwanDate.getUTCFullYear();
                        const m = String(taiwanDate.getUTCMonth() + 1).padStart(2, '0');
                        const day = String(taiwanDate.getUTCDate()).padStart(2, '0');
                        return `${y}-${m}-${day}`;
                    }
                    return s;
                };

                // üìñ ÊäìÂèñË≥áÊñô
                const fetchData = async () => {
                    if (isEditing.value) return;
                    loading.value = true;
                    errorMsg.value = null;

                    if (!DATA_API_URL) {
                        errorMsg.value = "Â∞öÊú™Ë®≠ÂÆö GAS API Á∂≤ÂùÄ"; loading.value = false; return;
                    }

                    try {
                        const res = await fetch(`${DATA_API_URL}?mode=api&t=${Date.now()}`, { 
                            method: "GET",
                            referrerPolicy: "no-referrer"
                        });
                        
                        if (!res.ok) throw new Error("ÈÄ£Á∑öÂ§±ÊïóÔºöË´ãÊ™¢Êü• GAS ÈÉ®ÁΩ≤Ê¨äÈôê");
                        const text = await res.text();
                        let data;
                        try { data = JSON.parse(text); } catch (e) { throw new Error("Ë≥áÊñôÊ†ºÂºèÈåØË™§"); }

                        if (data.error) throw new Error(data.error);

                        // ‚ö° ÈÅéÊøæÁ©∫Ë≥áÊñô
                        data = data.filter(item => item[0] && String(item[0]).trim() !== '' && item[3] && String(item[3]).trim() !== '');
                        rawJsonData.value = data;

                        // Ê†ºÂºèÂåñË≥áÊñô
                        reservations.value = data.map((item, idx) => {
                            let serviceName = item[8] || 'ÊúçÂãô';
                            // Áµ±‰∏ÄÊúçÂãôÂêçÁ®±Â∞çÊáâ
                            if (serviceName.includes('Ëá™Âèñ')) serviceName = 'Â∑•‰ΩúÂÆ§ÂèñË≤®'; 
                            else if (serviceName.includes('ÂæåËªäÂªÇ')) serviceName = 'ÂæåËªäÂªÇ‰ΩàÁΩÆ';
                            else if (serviceName.includes('Â§ñÈÄÅ')) serviceName = 'Ê∞£ÁêÉÂ§ñÈÄÅ';
                            else if (serviceName.includes('‰ΩàÁΩÆ')) serviceName = 'Â∞à‰∫∫‰ΩàÁΩÆ';

                            return {
                                oid: String(item[0]),
                                lineName: item[2] || '',
                                contactName: item[3] || 'ÁÑ°Âêç',
                                phone: item[4] || '',
                                date: formatGASDate(item[5]),
                                time: formatTime(item[6]),
                                location: item[7] || '',
                                service: serviceName,
                                userId: item[9] || '',
                                status: mapRawStatus(item[10]),
                                rawPrice: parseInt(item[11]) || 0,
                                receivedPrice: parseInt(item[12]) || 0
                            };
                        }).sort((a, b) => new Date(b.date) - new Date(a.date));

                        lastUpdated.value = new Date().toLocaleTimeString();
                        
                        // Ëá™ÂãïÊõ¥Êñ∞ÈÅ∏ÊìáÁöÑË®ÇÂñÆ
                        if (selectedOrder.value) {
                             const updated = reservations.value.find(r => r.oid === selectedOrder.value.oid);
                             if (updated && !isEditing.value) {
                                 Object.assign(selectedOrder.value, updated);
                             }
                        } else if (reservations.value.length > 0) {
                             // ÈõªËÖ¶ÁâàËá™ÂãïÈÅ∏Á¨¨‰∏ÄÁ≠ÜÔºåÊâãÊ©üÁâà‰∏çÈÅ∏
                             if (window.innerWidth >= 768 && !selectedOrder.value) {
                                 selectedOrder.value = reservations.value[0];
                             }
                        }

                    } catch (e) {
                        errorMsg.value = e.message;
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                const mapRawStatus = (s) => {
                    s = String(s);
                    if (s.includes('Â∑≤‰ªòÊ¨æ') || s.includes('CONFIRMED')) return 'CONFIRMED';
                    if (s.includes('ÂèñÊ∂à') || s.includes('CANCELED')) return 'CANCELED';
                    if (s.includes('ÂÆåÊàê') || s.includes('COMPLETED')) return 'COMPLETED';
                    if (s.includes('Á≠âÂæÖ') || s.includes('WAITING')) return 'WAITING_PAYMENT';
                    return 'UNPAID';
                };

                const getStatusText = (status) => {
                    const map = {
                        'CONFIRMED': 'üü¢ Â∑≤‰ªòÊ¨æ', 'UNPAID': 'üî¥ Êú™‰ªòÊ¨æ', 
                        'CANCELED': '‚ö™ Â∑≤ÂèñÊ∂à', 'COMPLETED': 'üîµ Â∑≤ÂÆåÊàê', 
                        'WAITING_PAYMENT': 'üü° Á≠âÂæÖÂåØÊ¨æ', 'REFUNDED': 'üí∏ Â∑≤ÈÄÄÊ¨æ'
                    };
                    return map[status] || status;
                };

                const getLabel = (type, service) => (configMap[service] || configMap['Â∞à‰∫∫‰ΩàÁΩÆ'])[type];
                const selectOrder = (order) => { if (!isEditing.value) selectedOrder.value = order; };

                // üîç ÁØ©ÈÅ∏ÈÇèËºØË£úÂõû
                const filteredList = computed(() => {
                    let result = reservations.value;
                    if (filter.value === 'UNPAID') result = result.filter(r => r.status === 'UNPAID' || r.status === 'WAITING_PAYMENT');
                    else if (filter.value !== 'ALL') result = result.filter(r => r.status === filter.value);

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(r => r.contactName.toLowerCase().includes(q) || r.phone.includes(q) || r.lineName.toLowerCase().includes(q));
                    }
                    if (filterDate.value) result = result.filter(r => r.date === filterDate.value);
                    if (filterService.value) result = result.filter(r => r.service === filterService.value);

                    return result;
                });
                
                const clearFilters = () => { filterDate.value = ''; filterService.value = ''; searchQuery.value = ''; };
                
                // Á∞°ÂñÆÁöÑÈ´ò‰∫ÆÊñáÂ≠óÂäüËÉΩ
                const highlightText = (text) => {
                    if (!text) return ''; 
                    if (!searchQuery.value) return text;
                    const regex = new RegExp(`(${searchQuery.value})`, 'gi');
                    return text.replace(regex, '<span class="bg-yellow-200 text-black">$1</span>');
                };

                const buildRichFlexMessage = (order, actionType) => {
                      const config = configMap[order.service] || configMap['Â∞à‰∫∫‰ΩàÁΩÆ'];
                      const total = parseInt(order.rawPrice) || 0;
                      const paid = parseInt(order.receivedPrice) || 0;
                      const balance = total - paid;
                      let titleText = 'PAYMENT CONFIRMED'; let descText = 'È†êÁ¥ÑËàáÊ¨æÈ†ÖÂ∑≤Á¢∫Ë™ç'; let statusColor = '#10B981';
                      let bodyContents = [];

                      if (actionType === 'CANCEL') { titleText = 'ORDER CANCELED'; descText = 'È†êÁ¥ÑÂ∑≤ÂèñÊ∂à'; statusColor = '#EF4444'; }
                      else if (actionType === 'REFUND') { titleText = 'REFUND COMPLETED'; descText = 'ÈÄÄÊ¨æËæ¶ÁêÜÂÆåÊàê'; statusColor = '#EAB308'; }
                      else if (actionType === 'COMPLETE') { titleText = 'SERVICE COMPLETED'; descText = 'ÊúçÂãôÂ∑≤ÂÆåÊàê'; statusColor = '#2563EB'; }
                      else if (actionType === 'RESTORE') { titleText = 'ORDER RESTORED'; descText = 'Ë®ÇÂñÆÁãÄÊÖãÂ∑≤ÊÅ¢Âæ©'; statusColor = '#EF4444'; }
                      else if (actionType === 'UPDATE') { titleText = 'BOOKING UPDATED'; descText = 'È†êÁ¥ÑË≥áÊñôÂ∑≤Êõ¥Êñ∞'; statusColor = '#3B82F6'; }
                      else if (actionType === 'PAYMENT_REQUEST') { 
                          titleText = 'PAYMENT REQUEST'; 
                          descText = 'Ë´ãË©≥Èñ±‰ªòÊ¨æË¶èÂâá‰∏¶ÂÆåÊàêÂåØÊ¨æ'; 
                          statusColor = '#2563EB'; 
                          const ruleText = formatForLine(getPaymentMessage(order.service, order.date));
                          bodyContents = [
                            { "type": "text", "text": `Êú¨Ê¨°Ë®ÇÂñÆÁ∏ΩÈáëÈ°ç: NT$ ${total.toLocaleString()}`, "weight": "bold", "size": "md", "color": "#C69C6D", "align": "center", "margin": "md" },
                            { "type": "separator", "margin": "md" },
                            { "type": "text", "text": "‰ªòÊ¨æÊ≥®ÊÑè‰∫ãÈ†Ö", "weight": "bold", "size": "md", "color": "#2563EB", "margin": "md" },
                            { "type": "text", "text": safeText(ruleText), "size": "xs", "color": "#666666", "wrap": true, "margin": "sm" },
                            { "type": "separator", "margin": "lg" },
                            { "type": "text", "text": "ÂåØÊ¨æË≥áË®äÔºöÂΩ∞ÂåñÈäÄË°å (009)", "size": "xs", "color": "#aaaaaa", "margin": "lg" },
                            { 
                                "type": "box",
                                "layout": "vertical",
                                "backgroundColor": "#F5F5F5",
                                "cornerRadius": "md",
                                "paddingAll": "lg",
                                "margin": "md",
                                "contents": [
                                    {
                                        "type": "text", 
                                        "text": "54320100686300", 
                                        "weight": "bold", 
                                        "size": "3xl", 
                                        "color": "#4A4A4A", 
                                        "align": "center",
                                        "wrap": true
                                    }
                                ]
                            },
                            { "type": "text", "text": "(Ë´ãÈï∑Êåâ‰∏äÊñπÊï∏Â≠óÂç≥ÂèØË§áË£Ω)", "size": "xxs", "color": "#cccccc", "align": "center", "margin": "xs" }
                          ];
                      }

                      if (bodyContents.length === 0) {
                          if (actionType === 'COMPLETE') {
                              bodyContents = [
                                { "type": "text", "text": "ÊÑüË¨ùÊÇ®ÈÅ∏Êìá MILU BALLOONSÔºÅ", "weight": "bold", "size": "md", "color": "#4A4A4A", "align": "center", "margin": "lg", "wrap": true },
                                { "type": "text", "text": "ÊúüÂæÖÂÜçÊ¨°ÁÇ∫ÊÇ®ÊúçÂãô ‚ù§Ô∏è", "size": "sm", "color": "#666666", "align": "center", "margin": "sm" }
                             ];
                          } else {
                              bodyContents = [
                                {
                                    "type": "box", "layout": "vertical", "margin": "md", "spacing": "sm",
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "ÂÆ¢Êà∂ÂßìÂêç", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.contactName), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "ËÅØÁµ°ÈõªË©±", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.phone), "size": "xs", "color": "#666666", "align": "end", "flex": 4 } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "È†êÁ¥ÑÊó•Êúü", "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.date), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": config.time, "size": "xs", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": safeText(order.time), "size": "xs", "color": "#666666", "align": "end", "flex": 4, "weight": "bold" } ] },
                                        { "type": "box", "layout": "vertical", "margin": "sm", "contents": [ { "type": "text", "text": config.location, "size": "xs", "color": "#aaaaaa" }, { "type": "text", "text": safeText(order.location), "size": "xs", "color": "#666666", "margin": "xs", "wrap": true, "weight": "bold" } ] }
                                    ]
                                },
                                { "type": "separator", "margin": "xl" },
                                {
                                    "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", 
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "Á∏ΩË®àÈáëÈ°ç", "size": "sm", "color": "#aaaaaa", "flex": 2 }, { "type": "text", "text": `NT$ ${formatMoney(total)}`, "size": "sm", "color": "#666666", "align": "end", "flex": 3 } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "Â∑≤Êî∂Ê¨æ", "size": "sm", "color": "#10B981", "weight": "bold", "flex": 2 }, { "type": "text", "text": `NT$ ${formatMoney(paid)}`, "size": "sm", "color": "#10B981", "align": "end", "weight": "bold", "flex": 3 } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "Â∞öÊ¨†Â∞æÊ¨æ", "size": "sm", "color": "#EF4444", "weight": "bold", "flex": 2 }, { "type": "text", "text": `NT$ ${formatMoney(balance)}`, "size": "sm", "color": "#EF4444", "align": "end", "weight": "bold", "flex": 3 } ] }
                                    ]
                                }
                             ];
                          }
                      }

                      return {
                         "type": "bubble", "size": "mega",
                         "header": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": titleText, "weight": "bold", "color": statusColor, "size": "xs", "align": "center" } ], "paddingBottom": "none" },
                         "body": {
                             "type": "box", "layout": "vertical",
                             "contents": [
                                 { "type": "text", "text": `${config.icon} ${safeText(order.service)}`, "weight": "bold", "size": "xl", "align": "center", "color": "#4A4A4A", "wrap": true },
                                 { "type": "text", "text": safeText(descText), "size": "sm", "color": "#999999", "align": "center", "margin": "xs" },
                                 { "type": "separator", "margin": "md" },
                                 ...bodyContents
                             ]
                         },
                         "footer": { "type": "box", "layout": "vertical", "contents": [ { "type": "text", "text": "Â¶ÇÊúâ‰ªª‰ΩïÂïèÈ°åË´ãÈö®ÊôÇÁßÅË®äÊàëÂÄë", "size": "xxs", "color": "#cccccc", "align": "center" } ] }
                     };
                };

                const updateOrderStatus = async (actionType) => {
                    const order = selectedOrder.value;
                    if (!order) return;
                    if (!order.userId) return Swal.fire('ÁÑ°Ê≥ïÁôºÈÄÅ', 'Ê≠§Ë®ÇÂñÆÊ≤íÊúâÊäìÂà∞ÂÆ¢‰∫∫ÁöÑ LINE IDÔºåË´ãÊâãÂãïËÅØÁµ°„ÄÇ', 'warning');
                    
                    Swal.fire({
                        title: 'Á¢∫Ë™çÁôºÈÄÅÈÄöÁü•Ôºü',
                        text: `Âç≥Â∞áÁôºÈÄÅ LINE ÈÄöÁü•Áµ¶ ${order.contactName}`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Á¢∫ÂÆöÁôºÈÄÅ',
                        cancelButtonText: 'ÂèñÊ∂à'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            try {
                                Swal.fire({ title: 'ÁôºÈÄÅ‰∏≠...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                const flex = buildRichFlexMessage(order, actionType);
                                
                                let statusText = '';
                                if (actionType === 'CONFIRM') statusText = '‚úÖ Â∑≤‰ªòÊ¨æ'; 
                                else if (actionType === 'PAYMENT_REQUEST') statusText = '‚è≥ Á≠âÂæÖÂåØÊ¨æ';
                                else if (actionType === 'COMPLETE') statusText = 'üèÅ Â∑≤ÂÆåÊàê'; 
                                else if (actionType === 'CANCEL') statusText = '‚ùå Â∑≤ÂèñÊ∂à';
                                else if (actionType === 'REFUND') statusText = 'üí∏ Â∑≤ÈÄÄÊ¨æ';
                                else if (actionType === 'RESTORE') statusText = '‚ùå Êú™‰ªòÊ¨æ';

                                const payload = {
                                    action: 'UPDATE_ORDER', 
                                    orderId: order.oid,
                                    service: order.service, // Áî®‰æÜÊâæÂàÜÈ†Å
                                    
                                    // Ë≥áÊñôÊ¨Ñ‰Ωç
                                    lineName: order.lineName,
                                    clientName: order.contactName, 
                                    phone: order.phone,
                                    date: order.date,
                                    time: order.time,
                                    location: order.location,
                                    status: statusText,
                                    price: parseMoney(editForm.value.rawPrice),
                                    received: parseMoney(editForm.value.receivedPrice),
                                    
                                    // ÈÇèËºØÊéßÂà∂
                                    createCalendarEvent: actionType === 'CONFIRM' ? 'true' : 'false',
                                    notifyMake: 'true', // Âõ†ÁÇ∫ÊòØÊåâÈàïÂãï‰ΩúÔºåÊâÄ‰ª•Ë¶ÅÁôº LINE
                                    
                                    // ÂÇ≥Áµ¶ Make Áôº LINE Áî®ÁöÑË≥áÊñô (Flex Message)
                                    to: order.userId,
                                    message: { type: "flex", altText: `ÈÄöÁü•Ôºö${order.service} ${statusText}`, contents: flex },
                                    flexContents: flex
                                };

                                await fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                                
                                if (actionType === 'CONFIRM') order.status = 'CONFIRMED';
                                else if (actionType === 'PAYMENT_REQUEST') order.status = 'WAITING_PAYMENT';
                                else if (actionType === 'COMPLETE') order.status = 'COMPLETED';
                                else if (actionType === 'CANCEL') order.status = 'CANCELED';
                                else if (actionType === 'REFUND') order.status = 'REFUNDED';
                                else if (actionType === 'RESTORE') order.status = 'UNPAID';
                                
                                Swal.fire('ÊàêÂäü', 'ÈÄöÁü•Â∑≤ÈÄÅÂá∫ÔºÅ', 'success');
                            } catch (e) {
                                Swal.fire('ÈåØË™§', 'ÁôºÈÄÅÂ§±ÊïóÔºö' + e.message, 'error');
                            }
                        }
                    });
                };
                
                const handlePriceFocus = () => { if (!isEditing.value) startEdit(); };

                const startEdit = () => { 
                    const formData = { ...selectedOrder.value };
                    if (formData.date && formData.date.includes('/')) formData.date = formData.date.replace(/\//g, '-');
                    if (formData.time) {
                        if (isTimeSlotService(formData.service)) {
                            const cleanTime = formData.time.replace(/\s+/g, '');
                            const matchedSlot = timeSlots.find(slot => slot.replace(/\s+/g, '') === cleanTime);
                            if (matchedSlot) formData.time = matchedSlot;
                        } else {
                            const timeMatch = formData.time.match(/(\d{1,2}):(\d{2})/);
                            if (timeMatch) {
                                let hh = timeMatch[1]; let mm = timeMatch[2];
                                if (hh.length === 1) hh = '0' + hh; 
                                formData.time = `${hh}:${mm}`;
                            }
                        }
                    }
                    editForm.value = formData; isEditing.value = true; 
                };
                const cancelEdit = () => { isEditing.value = false; editForm.value = {}; };
                
                const saveEdit = async () => {
                    const order = selectedOrder.value;
                    Swal.fire({ title: 'ÂÑ≤Â≠ò‰∏≠...', text: 'Ê≠£Âú®Êõ¥Êñ∞Ë≥áÊñô', didOpen: () => Swal.showLoading() });
                    
                    let statusText = '';
                    if (order.status === 'CONFIRMED') statusText = '‚úÖ Â∑≤‰ªòÊ¨æ';
                    else if (order.status === 'WAITING_PAYMENT') statusText = '‚è≥ Á≠âÂæÖÂåØÊ¨æ';
                    else if (order.status === 'UNPAID') statusText = '‚ùå Êú™‰ªòÊ¨æ';
                    else if (order.status === 'COMPLETED') statusText = 'üèÅ Â∑≤ÂÆåÊàê';

                    const flex = buildRichFlexMessage({ ...order, ...editForm.value }, 'UPDATE');
                    
                    const payload = {
                        action: 'UPDATE_ORDER', // ÂëäË®¥ GAS ÈÄôÊòØÂØ´ÂÖ•Âãï‰Ωú
                        orderId: order.oid,
                        service: order.service,
                        
                        // Êõ¥Êñ∞ÂæåÁöÑË≥áÊñô
                        lineName: editForm.value.lineName,
                        clientName: editForm.value.contactName, 
                        phone: editForm.value.phone,
                        date: editForm.value.date,
                        time: editForm.value.time,
                        location: editForm.value.location,
                        status: statusText, // ÁãÄÊÖãÈÄöÂ∏∏‰∏çÂõ†Á∑®ËºØËÄåÊîπËÆäÔºåÈô§ÈùûÈÄ£ÂãïÈÇèËºØ
                        price: parseMoney(editForm.value.rawPrice),
                        received: parseMoney(editForm.value.receivedPrice),
                        
                        // ÈÇèËºØÊéßÂà∂
                        // Âè™ÊúâÂú®ÁãÄÊÖãÊòØ„ÄåÂ∑≤‰ªòÊ¨æ/Â∑≤ÂÆåÊàê„ÄçÊôÇÔºåÁ∑®ËºØÊâçÂêåÊ≠•Ë°å‰∫ãÊõÜ
                        createCalendarEvent: (order.status === 'CONFIRMED' || order.status === 'COMPLETED') ? 'true' : 'false',
                        notifyMake: notifyOnUpdate.value ? 'true' : 'false',
                        
                        // ÂÇ≥Áµ¶ Make Áôº LINE Áî®ÁöÑË≥áÊñô
                        to: order.userId,
                        message: { type: "flex", altText: `Ë≥áÊñôÊõ¥Êñ∞Ôºö${order.service}`, contents: flex },
                        flexContents: flex
                    };

                    try {
                        // üëâ ÊîπÁÇ∫ POST Âà∞ GAS
                        await fetch(DATA_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                        
                        Object.assign(selectedOrder.value, editForm.value);
                        selectedOrder.value.contactName = editForm.value.contactName; 
                        selectedOrder.value.rawPrice = parseMoney(editForm.value.rawPrice);
                        selectedOrder.value.receivedPrice = parseMoney(editForm.value.receivedPrice);
                        isEditing.value = false;
                        Swal.fire('ÊàêÂäü', 'Ë≥áÊñôÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
                    } catch (e) { Swal.fire('ÈåØË™§', e.message, 'error'); }
                };

                const showDebug = () => {
                    Swal.fire({
                        title: 'ÂéüÂßãË≥áÊñôË®∫Êñ∑',
                        html: `<div class="debug-modal text-left"><p class="text-[10px] mb-2 font-bold text-red-500">Ê™¢Ê∏¨Âà∞ ${rawJsonData.value.length} Á≠ÜË≥áÊñô</p><pre>${JSON.stringify(rawJsonData.value[0], null, 2)}</pre></div>`,
                        width: '600px'
                    });
                };

                // Â∞áËá™ÂãïÊõ¥Êñ∞È†ªÁéáÊîπÁÇ∫ 10 Áßí
                onMounted(() => { fetchData(); setInterval(fetchData, 10000); });
                return { 
                    reservations, selectedOrder, filter, loading, errorMsg, filteredList, 
                    selectOrder, fetchData, updateOrderStatus, getStatusText, getLabel, showDebug,
                    isEditing, editForm, startEdit, cancelEdit, saveEdit, formatMoney, displayRawPrice, displayReceivedPrice,
                    isTimeSlotService, timeSlots, notifyOnUpdate, fillFullPayment, lastUpdated,
                    handlePriceFocus, 
                    searchQuery, filterDate, filterService, clearFilters, configMap, highlightText // Ë£úÂõûÈÅ∫ÊºèÁöÑÂáΩÂºè
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


