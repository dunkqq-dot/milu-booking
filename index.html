<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上預約 | MILU Balloons</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background-color: #FFFFFF; font-family: 'Noto Sans TC', sans-serif; color: #4A4A4A; }
        body { padding-bottom: 40px; }
        .custom-input { width: 100%; padding: 12px 0; background: transparent; border-bottom: 1px solid #E5E7EB; outline: none; border-radius: 0; font-size: 1rem; color: #111; }
        .custom-input:focus { border-bottom: 1px solid #C69C6D; }
        .input-label { display: block; margin-top: 1rem; color: #4A4A4A; font-size: 0.9rem; font-weight: 700; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 0.8rem; margin-top: 0.8rem; font-size: 0.9rem; color: #666; cursor: pointer; line-height: 1.5; }
        .checkbox-input { margin-top: 0.2rem; accent-color: #C69C6D; width: 18px; height: 18px; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.85rem; font-weight: 500; transition: all 0.3s; white-space: nowrap; border: 1px solid #F3F4F6; color: #9CA3AF; }
        .tab-active { background-color: #4A4A4A; color: white; border-color: #4A4A4A; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hidden { display: none; }
        input[type="date"], input[type="time"] { -webkit-appearance: none; min-height: 45px; }

        /* 成功畫面樣式 */
        #success-screen { display: none; text-align: center; padding-top: 50px; }
        #main-content { transition: opacity 0.3s; }
    </style>
</head>
<body>

    <!-- 成功畫面 -->
    <div id="success-screen" class="px-6">
        <div class="mb-6 text-6xl text-green-500"><i class="fa-solid fa-circle-check"></i></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">預約已送出！</h2>
        <p class="text-gray-500 mb-6 text-sm leading-relaxed">感謝您的預約。<br>匯款資訊已發送至您的 LINE 聊天室。<br>請匯款後回傳帳號後五碼。</p>
        <div class="bg-yellow-50 p-4 rounded-lg text-left text-sm text-gray-600 mb-8 border border-yellow-100">
            <p class="font-bold text-yellow-800 mb-2">💰 匯款帳號備份</p>
            <p>銀行：009 彰化銀行</p>
            <p>帳號：54320100686300</p>
            <p>戶名：貴誰日工作室 蔡佳苓</p>
        </div>
        <button onclick="liff.closeWindow()" class="w-full bg-gray-800 text-white py-3 rounded-lg">關閉視窗</button>
    </div>

    <!-- 主內容 -->
    <div id="main-content" class="px-5 py-6 max-w-lg mx-auto">
        
        <script>
            const config = {
                LIFF_ID: '2004044468-w8s4Ex1k', 
                
                BANK_INFO: { 
                    CODE: '009 彰化銀行 (汐科分行)', 
                    ACCOUNT: '54320100686300', 
                    NAME: '貴誰日工作室 蔡佳苓' 
                },
                
                // 1. 專人佈置 (ID 已更新 ✅)
                DECO: { 
                    ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeuoWKBH5N0OD2ndd4lQY7HS-CplTGh7aN1P_KUsnIV0L22hg/formResponse', 
                    LINE_ID: '25342459', DATE_ID: '144531671', TIME_ID: '1297034041', ADDRESS_ID: '362812274', LOCATION_ID: '2051909207', NAME_ID: '1515108566', PHONE_ID: '2029864194', TERMS_ID: '1988418855', 
                    SYSTEM_ID: '854196062',     // User ID
                    PAYMENT_ID: '1383504004'    // 付款狀態
                },
                // 2. 氣球外送 (ID 已更新 ✅)
                DELIVERY: { 
                    ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeS_OuOMGKgpOmvVZdDtgzG_pBFLn6lbmg_8SsN5-XwBOg3kw/formResponse', 
                    LINE_ID: '25342459', DATE_ID: '1600332996', TIME_ID: '2101241835', ADDRESS_ID: '1233565012', RECEIVER_ID: '431322564', PHONE_ID: '542364066', TERMS_ID: '391729019', 
                    SYSTEM_ID: '2002313802',     // User ID (新)
                    PAYMENT_ID: '1973575588'     // 付款狀態 (新)
                }, 
                // 3. 後車廂佈置 (ID 已更新 ✅)
                TRUNK: { 
                    ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSdm8LpSR3hTEWQ2lDfNymhZD91WFyHXWqciFPV0dSxrKViw0Q/formResponse', 
                    LINE_ID: '25342459', LOCATION_ID: '1086826795', DATE_ID: '1836239432', TIME_ID: '1130825436', CAR_ID: '1571766022', NAME_ID: '1970717609', PHONE_ID: '1029904286', TERMS_ID: '1380789591',
                    SYSTEM_ID: '1545965466',   // User ID
                    PAYMENT_ID: '352227586'    // 付款狀態
                },
                // 4. 工作室自取 (ID 已更新 ✅)
                PICKUP: { 
                    ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeGfmaUfKjyhvUcerp1gpXU25-C6TRJBkCMyzGBg7qykSkjYg/formResponse', 
                    LINE_ID: '25342459', LOCATION_ID: '1448770209', DATE_ID: '995623192', TIME_ID: '1255688304', NAME_ID: '1307528521', PHONE_ID: '1776788492', TERMS_ID: '178386428',
                    SYSTEM_ID: '1557454594',   // User ID
                    PAYMENT_ID: '347397920'    // 付款狀態
                }
            };
        </script>

        <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted){/* handled in JS */}"></iframe>

        <div class="flex items-center justify-between mb-6">
            <div><h1 class="text-2xl font-bold font-serif text-milu-dark">MILU BALLOONS</h1><p class="text-xs text-gray-400 tracking-widest mt-1">MAKE YOUR MOMENT SPECIAL</p></div>
            <div class="text-2xl">🎈</div>
        </div>

        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
            <button onclick="switchTab('deco')" id="btn-deco" class="tab-btn tab-active">專人佈置</button>
            <button onclick="switchTab('trunk')" id="btn-trunk" class="tab-btn tab-inactive">後車廂驚喜</button>
            <button onclick="switchTab('delivery')" id="btn-delivery" class="tab-btn tab-inactive">氣球外送</button>
            <button onclick="switchTab('pickup')" id="btn-pickup" class="tab-btn tab-inactive">工作室自取</button>
        </div>

        <!-- 1. 專人佈置 -->
        <form id="form-deco" class="space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(this, 'deco')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="deco-line" class="custom-input" placeholder="請填寫" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">佈置日期</label><input type="date" id="deco-date" class="custom-input" required></div>
                <div><label class="input-label">進場時間</label><input type="time" id="deco-time" class="custom-input" required></div>
            </div>
            <div><label class="input-label">詳細地址</label><input type="text" id="deco-address" class="custom-input" placeholder="完整地址 (含樓層)" required></div>
            <div><label class="input-label">場地名稱</label><input type="text" id="deco-location" class="custom-input" placeholder="例：XX飯店 502號房" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">現場聯絡人</label><input type="text" id="deco-name" class="custom-input" required></div>
                <div><label class="input-label">聯絡電話</label><input type="tel" id="deco-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我已確認場地允許進行氣球佈置，並已通知場方。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我了解空飄氣球漂浮時間約 6～8 小時，會安排在活動前 1-2 小時完成佈置以達最佳效果。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於殘膠風險： 我了解工作室使用 3M 不易殘膠布膠，並同意於 36 小時內 拆除。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若超過 36 小時未拆除導致殘膠或漆面脫落，或因牆面材質特殊造成損損，我同意工作室不負修復或賠償責任。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 2. 氣球外送 -->
        <form id="form-delivery" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(this, 'delivery')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="delivery-line" class="custom-input" placeholder="請填寫" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">外送日期</label><input type="date" id="delivery-date" class="custom-input" required></div>
                <div><label class="input-label">送達時段</label><select id="delivery-time" class="custom-input" required><option value="" disabled selected>請選擇時段</option><option>10:00 - 11:00</option><option>11:00 - 12:00</option><option>12:00 - 13:00</option><option>13:00 - 14:00</option><option>14:00 - 15:00</option><option>15:00 - 16:00</option><option>16:00 - 17:00</option><option>17:00 - 18:00</option></select></div>
            </div>
            <div><label class="input-label">外送地點 (限一樓/管理室)</label><input type="text" id="delivery-address" class="custom-input" placeholder="完整地址" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">收件人</label><input type="text" id="delivery-receiver" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="delivery-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我了解空飄氣球時效約 6～8 小時（隨時間氧化變霧），已確認送達時間符合活動需求。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於交貨地點： 我了解外送僅配送至 一樓或管理室，司機不上樓，我（或收件人）會前往一樓取貨。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於商品驗收： 商品送達後，我（或收件人）會立即確認氣球完整性。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若送達當下有疑慮，我會立即向司機或 LINE 客服反映。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若商品送達後無立即反應，後續破損或消氣會自行負責。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 3. 工作室自取 -->
        <form id="form-pickup" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(this, 'pickup')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="pickup-line" class="custom-input" placeholder="請填寫" required></div>
            <div><label class="input-label">取貨地點</label><div class="flex gap-3 mt-2">
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="pickup-location-temp" value="板橋工作室（江子翠）" class="hidden" required onclick="document.getElementById('pickup-location').value=this.value"><span class="text-sm">板橋工作室</span></label>
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="pickup-location-temp" value="台中工作室（太平區）" class="hidden" onclick="document.getElementById('pickup-location').value=this.value"><span class="text-sm">台中工作室</span></label>
                <input type="hidden" id="pickup-location">
            </div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">取貨日期</label><input type="date" id="pickup-date" class="custom-input" required></div>
                <div><label class="input-label">取貨時間</label><select id="pickup-time" class="custom-input" required><option value="" disabled selected>請選擇時段</option><option>10:00 - 11:00</option><option>11:00 - 12:00</option><option>12:00 - 13:00</option><option>13:00 - 14:00</option><option>14:00 - 15:00</option><option>15:00 - 16:00</option><option>16:00 - 17:00</option><option>17:00 - 18:00</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">取貨人姓名</label><input type="text" id="pickup-name" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="pickup-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於交通工具： 氣球怕風吹且體積大，我會安排**「汽車」**取貨（❌強烈不建議騎機車）。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於司機代取： 若委託司機（如 Uber/Lalamove）代取，我理解工作室僅負責交貨時的完整性（會拍照留存），運送途中的破損風險由我自行承擔。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於商品驗收： 我（或代取人）會在**「取貨當下」**確認商品完整性，如有疑慮會立即反映。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>離店後免責： 商品交付離店後，因運送過程、環境溫度或人為擠壓造成的消氣或破損，工作室恕不負責。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於時效： 我了解空飄氣球時效約 6～8 小時（依環境而異），會隨時間氧化變霧 或 消氣。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 4. 後車廂佈置 -->
        <form id="form-trunk" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(this, 'trunk')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="trunk-line" class="custom-input" placeholder="請填寫" required></div>
            <div><label class="input-label">施作地點</label><div class="flex gap-3 mt-2">
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="trunk-location-temp" value="板橋工作室（江子翠）" class="hidden" required onclick="document.getElementById('trunk-location').value=this.value"><span class="text-sm">板橋工作室</span></label>
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="trunk-location-temp" value="台中工作室（太平區）" class="hidden" onclick="document.getElementById('trunk-location').value=this.value"><span class="text-sm">台中工作室</span></label>
                <input type="hidden" id="trunk-location">
            </div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">佈置日期</label><input type="date" id="trunk-date" class="custom-input" required></div>
                <div><label class="input-label">抵達時間</label><input type="time" id="trunk-time" class="custom-input" required></div>
            </div>
            <div><label class="input-label">車款型號</label><input type="text" id="trunk-car" class="custom-input" placeholder="例如：Toyota RAV4" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">姓名</label><input type="text" id="trunk-name" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="trunk-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於作業時間： 我了解後車廂佈置需預留 至少 1 小時 的施作時間，我會準時抵達。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於時效： 如有訂購空飄氣球我了解空飄氣球時效約 6～8 小時（依環境而異），建議於活動前 1～2 小時內完成佈置以達最佳效果。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於空間： 我會提前清空後車廂雜物，以便現場人員直接進行佈置。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>離場後免責： 佈置完成驗收離場後，因行駛過程晃動、溫度變化或人為因素導致的破損或位移，工作室恕不負責。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <div class="text-center mt-6">
            <p class="text-xs text-gray-300 font-serif tracking-wider">&copy; 2025 MILU BALLOONS</p>
        </div>
    </div>

    <!-- JS 邏輯區 -->
    <script>
        window.onload = function() {
            if (config.LIFF_ID) {
                liff.init({ liffId: config.LIFF_ID })
                    .then(() => {
                        console.log('LIFF initialized');
                        if (!liff.isLoggedIn()) {
                            // liff.login(); 
                        }
                    })
                    .catch((err) => { console.error('LIFF Init Error:', err); });
            }
            bindFormInputs();
        };

        function bindFormInputs() {
            // DECO
            const decoForm = document.getElementById('form-deco');
            decoForm.action = config.DECO.ACTION;
            document.getElementById('deco-line').name = 'entry.' + config.DECO.LINE_ID;
            document.getElementById('deco-address').name = 'entry.' + config.DECO.ADDRESS_ID;
            document.getElementById('deco-location').name = 'entry.' + config.DECO.LOCATION_ID;
            document.getElementById('deco-name').name = 'entry.' + config.DECO.NAME_ID;
            document.getElementById('deco-phone').name = 'entry.' + config.DECO.PHONE_ID;

            // DELIVERY
            const deliveryForm = document.getElementById('form-delivery');
            if (config.DELIVERY.ACTION) {
                deliveryForm.action = config.DELIVERY.ACTION;
                document.getElementById('delivery-line').name = 'entry.' + config.DELIVERY.LINE_ID;
                document.getElementById('delivery-time').name = 'entry.' + config.DELIVERY.TIME_ID;
                document.getElementById('delivery-address').name = 'entry.' + config.DELIVERY.ADDRESS_ID;
                document.getElementById('delivery-receiver').name = 'entry.' + config.DELIVERY.RECEIVER_ID;
                document.getElementById('delivery-phone').name = 'entry.' + config.DELIVERY.PHONE_ID;
            }

            // PICKUP
            const pickupForm = document.getElementById('form-pickup');
            if (config.PICKUP.ACTION) {
                pickupForm.action = config.PICKUP.ACTION;
                document.getElementById('pickup-line').name = 'entry.' + config.PICKUP.LINE_ID;
                document.getElementById('pickup-location').name = 'entry.' + config.PICKUP.LOCATION_ID;
                document.getElementById('pickup-time').name = 'entry.' + config.PICKUP.TIME_ID; 
                document.getElementById('pickup-name').name = 'entry.' + config.PICKUP.NAME_ID;
                document.getElementById('pickup-phone').name = 'entry.' + config.PICKUP.PHONE_ID;
            }

            // TRUNK
            const trunkForm = document.getElementById('form-trunk');
            trunkForm.action = config.TRUNK.ACTION;
            document.getElementById('trunk-line').name = 'entry.' + config.TRUNK.LINE_ID;
            document.getElementById('trunk-location').name = 'entry.' + config.TRUNK.LOCATION_ID;
            document.getElementById('trunk-time').name = 'entry.' + config.TRUNK.TIME_ID;
            document.getElementById('trunk-car').name = 'entry.' + config.TRUNK.CAR_ID;
            document.getElementById('trunk-name').name = 'entry.' + config.TRUNK.NAME_ID;
            document.getElementById('trunk-phone').name = 'entry.' + config.TRUNK.PHONE_ID;
        }

        function switchTab(type) {
            ['deco', 'delivery', 'pickup', 'trunk'].forEach(t => {
                const btn = document.getElementById('btn-' + t);
                const form = document.getElementById('form-' + t);
                if (t === type) {
                    btn.classList.add('tab-active'); btn.classList.remove('tab-inactive');
                    form.classList.remove('hidden');
                } else {
                    btn.classList.add('tab-inactive'); btn.classList.remove('tab-active');
                    form.classList.add('hidden');
                }
            });
        }

        var submitted = false;
        function handleFormSubmit(form, type) {
            const configEntry = config[type.toUpperCase()];
            form.action = configEntry.ACTION;

            // 1. 自動填入 User ID (如果設定有 SYSTEM_ID)
            if (configEntry.SYSTEM_ID) {
                liff.getProfile().then(profile => {
                    const sysInput = document.createElement('input');
                    sysInput.type = 'hidden';
                    sysInput.name = 'entry.' + configEntry.SYSTEM_ID;
                    sysInput.value = profile.userId;
                    form.appendChild(sysInput);
                }).catch(err => console.log('Profile Error (Ignore if not in LINE)', err));
            }

            // 2. 自動填入 Payment Status = "未付款" (如果設定有 PAYMENT_ID)
            if (configEntry.PAYMENT_ID) {
                const payInput = document.createElement('input');
                payInput.type = 'hidden';
                payInput.name = 'entry.' + configEntry.PAYMENT_ID;
                payInput.value = '未付款';
                form.appendChild(payInput);
            }

            // 日期處理
            const dateInput = document.getElementById(type + '-date');
            if(dateInput && dateInput.value) {
                const parts = dateInput.value.split('-');
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_year', parts[0]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_month', parts[1]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_day', parts[2]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID, dateInput.value); 
            }
            
            // 時間處理
            const timeInput = document.getElementById(type + '-time');
            if(timeInput && (type === 'deco' || type === 'trunk')) {
                 if(timeInput.value) {
                    const parts = timeInput.value.split(':');
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID + '_hour', parts[0]);
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID + '_minute', parts[1]);
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID, timeInput.value); 
                }
            }

            // 條款處理
            let terms = [];
            if(type === 'deco') {
                terms = ["我已確認場地允許進行氣球佈置，並已通知場方。", "我了解空飄氣球漂浮時間約 6～8 小時，會安排在活動前 1-2 小時完成佈置以達最佳效果。", "關於殘膠風險： 我了解工作室使用 3M 不易殘膠布膠，並同意於 36 小時內 拆除。", "若超過 36 小時未拆除導致殘膠或漆面脫落，或因牆面材質特殊造成損損，我同意工作室不負修復或賠償責任。"];
            } else if(type === 'delivery') {
                terms = ["我了解空飄氣球時效約 6～8 小時（隨時間氧化變霧），已確認送達時間符合活動需求。", "關於交貨地點： 我了解外送僅配送至 一樓或管理室，司機不上樓，我（或收件人）會前往一樓取貨。", "關於商品驗收： 商品送達後，我（或收件人）會立即確認氣球完整性。", "若送達當下有疑慮，我會立即向司機或 LINE 客服反映。", "若商品送達後無立即反應，後續破損或消氣會自行負責。"];
            } else if(type === 'pickup') {
                terms = ["關於交通工具： 氣球怕風吹且體積大，我會安排**「汽車」**取貨（❌強烈不建議騎機車）。", "關於司機代取： 若委託司機（如 Uber/Lalamove）代取，我理解工作室僅負責交貨時的完整性（會拍照留存），運送途中的破損風險由我自行承擔。", "關於商品驗收： 我（或代取人）會在**「取貨當下」**確認商品完整性，如有疑慮會立即反映。", "離店後免責： 商品交付離店後，因運送過程、環境溫度或人為擠壓造成的消氣或破損，工作室恕不負責。", "關於時效： 我了解空飄氣球時效約 6～8 小時（依環境而異），會隨時間氧化變霧 或 消氣。"];
            } else if(type === 'trunk') {
                terms = ["關於作業時間： 我了解後車廂佈置需預留 至少 1 小時 的施作時間，我會準時抵達。", "關於時效： 如有訂購空飄氣球我了解空飄氣球時效約 6～8 小時（依環境而異），建議於活動前 1～2 小時內完成佈置以達最佳效果。", "關於空間： 我會提前清空後車廂雜物，以便現場人員直接進行佈置。", "離場後免責： 佈置完成驗收離場後，因行駛過程晃動、溫度變化或人為因素導致的破損或位移，工作室恕不負責。"];
            }
            terms.forEach(t => createHiddenInput(form, 'entry.' + configEntry.TERMS_ID, t));

            submitted = true;
            
            const nameVal = document.getElementById(type + '-name') ? document.getElementById(type + '-name').value : '-';
            const dateVal = dateInput ? dateInput.value : '-';
            const timeVal = timeInput ? timeInput.value : '-';
            const serviceName = type === 'deco' ? '專人佈置' : (type === 'delivery' ? '氣球外送' : (type === 'pickup' ? '工作室自取' : '後車廂驚喜'));

            // 1. 跳出匯款視窗
            if (liff.isInClient()) {
                Swal.fire({
                    title: '預約單已送出！',
                    html: `
                        <div class="text-left text-sm text-gray-600">
                            <p class="mb-2">感謝您的填寫！請完成最後一步驟：</p>
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-3">
                                <p class="font-bold text-yellow-800 mb-1">💰 匯款資訊</p>
                                <p>銀行代碼：<span class="font-bold text-gray-800">${config.BANK_INFO.CODE}</span></p>
                                <p>銀行帳號：<span class="font-bold text-gray-800">${config.BANK_INFO.ACCOUNT}</span></p>
                                ${config.BANK_INFO.NAME ? `<p>戶名：<span class="font-bold text-gray-800">${config.BANK_INFO.NAME}</span></p>` : ''}
                            </div>
                            <p class="font-bold text-red-500">⚠️ 匯款後請務必在 LINE 告知「帳號後五碼」</p>
                            <p class="mt-1">我們查帳確認後，會回傳「預約成功通知」給您，才算完成喔！</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: '好的，關閉視窗',
                    confirmButtonColor: '#4A4A4A',
                    background: '#F9F7F2',
                    color: '#4A4A4A',
                    customClass: { title: 'font-serif text-milu-gold', popup: 'rounded-xl border border-milu-light' },
                    allowOutsideClick: false
                }).then(() => {
                    sendFlexMessageAndClose(serviceName, nameVal, dateVal, timeVal);
                });
            } else {
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('success-screen').style.display = 'block';
            }

            return true;
        }

        function sendFlexMessageAndClose(service, name, date, time) {
            if (liff.isInClient()) {
                liff.sendMessages([{
                    type: 'flex',
                    altText: '預約申請已收到',
                    contents: {
                        "type": "bubble",
                        "size": "mega",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "預約申請已收到", "weight": "bold", "color": "#C69C6D", "size": "sm" },
                                { "type": "text", "text": "感謝您的預約！", "weight": "bold", "size": "xl", "margin": "md" },
                                { "type": "text", "text": "請匯款後回傳帳號後五碼", "size": "xs", "color": "#aaaaaa", "wrap": true },
                                { "type": "separator", "margin": "xxl" },
                                {
                                    "type": "box", "layout": "vertical", "margin": "xxl", "spacing": "sm",
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "姓名", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": name, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "項目", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": service, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "日期", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": date, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "時間", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": time, "size": "sm", "color": "#111111", "align": "end" } ] }
                                    ]
                                },
                                { "type": "separator", "margin": "xxl" },
                                { "type": "box", "layout": "vertical", "margin": "md", "backgroundColor": "#F9F7F2", "cornerRadius": "md", "paddingAll": "md", "contents": [ { "type": "text", "text": "匯款帳號 (彰化銀行 009)", "size": "xs", "color": "#C69C6D", "weight": "bold" }, { "type": "text", "text": config.BANK_INFO.ACCOUNT, "size": "lg", "weight": "bold", "color": "#4A4A4A", "margin": "sm" }, { "type": "text", "text": config.BANK_INFO.NAME, "size": "xs", "color": "#999999" } ] }
                            ]
                        }
                    }
                }]).then(() => {
                    setTimeout(() => { liff.closeWindow(); }, 500);
                }).catch((err) => {
                    console.log('Msg Error', err);
                    document.getElementById('main-content').style.display = 'none';
                    document.getElementById('success-screen').style.display = 'block';
                    liff.closeWindow(); 
                });
            }
        }

        function createHiddenInput(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }
    </script>
</body>
</html>
