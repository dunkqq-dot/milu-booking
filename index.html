<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>線上預約 | MILU Balloons</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', beige: '#F9F7F2' }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow-x: hidden; background-color: #FFFFFF; font-family: 'Noto Sans TC', sans-serif; color: #4A4A4A; }
        body { padding-bottom: 40px; }
        .custom-input { width: 100%; padding: 12px 0; background: transparent; border-bottom: 1px solid #E5E7EB; outline: none; border-radius: 0; font-size: 16px; color: #111; -webkit-appearance: none; }
        .custom-input:focus { border-bottom: 1px solid #C69C6D; }
        /* 下拉選單樣式優化 */
        select.custom-input { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .input-label { display: block; margin-top: 1.2rem; color: #4A4A4A; font-size: 0.9rem; font-weight: 700; }
        .checkbox-item { display: flex; align-items: flex-start; gap: 0.8rem; margin-top: 0.8rem; font-size: 0.9rem; color: #666; cursor: pointer; line-height: 1.5; }
        .checkbox-input { margin-top: 0.2rem; accent-color: #C69C6D; width: 18px; height: 18px; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.85rem; font-weight: 500; transition: all 0.3s; white-space: nowrap; border: 1px solid #F3F4F6; color: #9CA3AF; }
        .tab-active { background-color: #4A4A4A; color: white; border-color: #4A4A4A; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hidden { display: none; }
        input[type="date"], input[type="time"] { -webkit-appearance: none; min-height: 45px; }

        #fallback-success { display: none; padding: 40px 20px; text-align: center; }
    </style>
</head>
<body>

    <script>
        const config = {
            LIFF_ID: '2004044468-w8s4Ex1k', 
            
            BANK_INFO: { 
                CODE: '009 彰化銀行 (汐科分行)', 
                ACCOUNT: '54320100686300', 
                NAME: '貴誰日工作室 蔡佳苓' 
            },

            // 💰 付款規則設定 (已更新為最新版本)
            PAYMENT_RULES: {
                // 1. 專人佈置 & 後車廂 (3天以上 - 一般預約)
                DECO_NORMAL: `
                    <div class="text-left text-sm space-y-2">
                        <p class="font-bold">感謝您訂購 麋鹿氣球MILU balloons🎈的服務！</p>
                        <p>本工作室採 <b>先完成預約程序者優先制</b>。</p>
                        <hr class="border-blue-200 my-2">
                        <ol class="list-decimal pl-4 space-y-1">
                            <li>單一時段僅服務一組客人，如同時段有兩組或以上，將以 <b>最先支付訂金者優先</b>。</li>
                            <li><b>匯款期限：</b>請於 <b>三日內完成匯款</b>，並將匯款截圖回傳給我們。收到訂金後，預約程序才算完成。<br><span class="text-xs text-gray-500">若超過三日未匯款，訂單將視為 <b>未成立</b>，工作室不會準備任何商品，若仍有需求需重新確認空檔時段。</span></li>
                            <li><b>訂金規則：</b>預訂款可為 <b>全額或 50% 訂金</b>，尾款請於佈置當天或事先支付。<br><span class="text-xs text-gray-500">若匯款後增加商品數量，需另行支付費用。</span></li>
                            <li><b>改期與取消：</b>完成預約後 <b>僅接受一次改期</b>，改期日需另行預約。<br><span class="text-xs text-gray-500">若因個人因素取消預約，將 <b>收取總金額 30% 作為服務費</b>，剩餘款項退還。</span></li>
                        </ol>
                        <div class="mt-2 p-2 bg-yellow-100 rounded text-yellow-800 text-xs">
                            📢 <b>貼心提醒</b><br>完成訂金匯款後，預約才算正式成立，請務必依照以上規則操作，以確保您的時段順利保留。
                        </div>
                    </div>
                `,
                
                // 2. 專人佈置 & 後車廂 (3天內 - 急單)
                DECO_URGENT: `
                    <div class="text-left text-sm space-y-2">
                        <p class="font-bold text-red-600">⚠️ 本報價單為 三日內預約者專用。</p>
                        <p class="font-bold">⏱ 預約與付款規則</p>
                        <hr class="border-blue-200 my-2">
                        <ol class="list-decimal pl-4 space-y-2">
                            <li><b>完成預約程序</b><br>請於預約時 <b>支付全額款項</b> 並截圖回傳。<br><span class="text-xs text-gray-500">若在預約時間前「五小時」尚未收到款項，訂單將視為 <b>未成立</b>，工作室不會準備任何商品，敬請配合。</span></li>
                            <li><b>單一時段僅服務一組客人</b><br>若同時段有多組客人，將以 <b>最先付款者優先</b>。</li>
                            <li><b>臨時急件服務</b><br>若需安排 24 小時內佈置，將額外收取 <b>急件費 $500</b>。</li>
                            <li><b>取消規定</b><br>因個人因素取消預約，將收取 <b>總金額 30% 服務費</b>，剩餘款項退還。</li>
                        </ol>
                    </div>
                `,
                
                // 3. 氣球外送 & 工作室自取 (統一規則)
                SIMPLE: `
                    <div class="text-left text-sm space-y-2">
                        <p class="font-bold">⏱ 預約與付款規則</p>
                        <hr class="border-blue-200 my-2">
                        <ol class="list-decimal pl-4 space-y-2">
                            <li><b>完成預約程序</b><br>請於預約當下 <b>支付全額款項</b> 並截圖回傳。<br><span class="text-xs text-gray-500">若在預約時間前 24 小時 尚未收到款項，訂單將視為 <b>未成立</b>，工作室不會準備任何商品。</span></li>
                            <li><b>急件服務</b><br>若需安排 24 小時內臨時急件，需額外收取 <b>急件費 $500</b>。</li>
                            <li><b>取消規定</b><br>因個人因素 24 小時內取消預約，將 <b>不退還任何款項</b>。</li>
                        </ol>
                    </div>
                `
            },
            
            DECO: { 
                ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeuoWKBH5N0OD2ndd4lQY7HS-CplTGh7aN1P_KUsnIV0L22hg/formResponse', 
                LINE_ID: '25342459', DATE_ID: '144531671', TIME_ID: '1297034041', ADDRESS_ID: '362812274', LOCATION_ID: '2051909207', NAME_ID: '1515108566', PHONE_ID: '2029864194', TERMS_ID: '1988418855', 
                SYSTEM_ID: '854196062', PAYMENT_ID: '1383504004',
                SERVICE_ID: '' 
            },
            DELIVERY: { 
                ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeS_OuOMGKgpOmvVZdDtgzG_pBFLn6lbmg_8SsN5-XwBOg3kw/formResponse', 
                LINE_ID: '25342459', DATE_ID: '1600332996', TIME_ID: '2101241835', ADDRESS_ID: '1233565012', RECEIVER_ID: '431322564', PHONE_ID: '542364066', TERMS_ID: '391729019', 
                SYSTEM_ID: '2002313802', PAYMENT_ID: '1973575588',
                SERVICE_ID: ''
            }, 
            TRUNK: { 
                ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSdm8LpSR3hTEWQ2lDfNymhZD91WFyHXWqciFPV0dSxrKViw0Q/formResponse', 
                LINE_ID: '25342459', LOCATION_ID: '1086826795', DATE_ID: '1836239432', TIME_ID: '1130825436', CAR_ID: '1571766022', NAME_ID: '1970717609', PHONE_ID: '1029904286', TERMS_ID: '1380789591', 
                SYSTEM_ID: '1545965466', PAYMENT_ID: '352227586',
                SERVICE_ID: ''
            },
            PICKUP: { 
                ACTION: 'https://docs.google.com/forms/d/e/1FAIpQLSeGfmaUfKjyhvUcerp1gpXU25-C6TRJBkCMyzGBg7qykSkjYg/formResponse', 
                LINE_ID: '25342459', LOCATION_ID: '1448770209', DATE_ID: '995623192', TIME_ID: '1255688304', NAME_ID: '1307528521', PHONE_ID: '1776788492', TERMS_ID: '178386428', 
                SYSTEM_ID: '1557454594', PAYMENT_ID: '347397920',
                SERVICE_ID: ''
            }
        };

        // 台灣縣市區域資料
        const taiwanPlaces = {
            "臺北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "三重區", "中和區", "永和區", "新莊區", "新店區", "樹林區", "鶯歌區", "三峽區", "淡水區", "汐止區", "瑞芳區", "土城區", "蘆洲區", "五股區", "泰山區", "林口區", "深坑區", "石碇區", "坪林區", "三芝區", "石門區", "八里區", "平溪區", "雙溪區", "貢寮區", "金山區", "萬里區", "烏來區"],
            "桃園市": ["桃園區", "中壢區", "大溪區", "楊梅區", "蘆竹區", "大園區", "龜山區", "八德區", "龍潭區", "平鎮區", "新屋區", "觀音區", "復興區"],
            "臺中市": ["中區", "東區", "南區", "西區", "北區", "北屯區", "西屯區", "南屯區", "太平區", "大里區", "霧峰區", "烏日區", "豐原區", "后里區", "石岡區", "東勢區", "和平區", "新社區", "潭子區", "大雅區", "神岡區", "大肚區", "沙鹿區", "龍井區", "梧棲區", "清水區", "大甲區", "外埔區", "大安區"],
            "臺南市": ["中西區", "東區", "南區", "北區", "安平區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區", "學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區", "下營區", "柳營區", "鹽水區", "善化區", "大內區", "山上區", "新市區", "安定區"],
            "高雄市": ["楠梓區", "左營區", "鼓山區", "三民區", "苓雅區", "新興區", "前金區", "鹽埕區", "前鎮區", "旗津區", "小港區", "鳳山區", "林園區", "大寮區", "大樹區", "大社區", "仁武區", "鳥松區", "岡山區", "橋頭區", "燕巢區", "田寮區", "阿蓮區", "路竹區", "湖內區", "茄萣區", "永安區", "彌陀區", "梓官區", "旗山區", "美濃區", "六龜區", "甲仙區", "杉林區", "內門區", "茂林區", "桃源區", "那瑪夏區"],
            "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
            "新竹市": ["東區", "北區", "香山區"],
            "嘉義市": ["東區", "西區"],
            "新竹縣": ["竹北市", "竹東鎮", "新埔鎮", "關西鎮", "湖口鄉", "新豐鄉", "芎林鄉", "橫山鄉", "北埔鄉", "寶山鄉", "大山背", "峨眉鄉", "尖石鄉", "五峰鄉"],
            "苗栗縣": ["苗栗市", "頭份市", "苑裡鎮", "通霄鎮", "竹南鎮", "後龍鎮", "卓蘭鎮", "大湖鄉", "公館鄉", "銅鑼鄉", "南庄鄉", "頭屋鄉", "三義鄉", "西湖鄉", "造橋鄉", "三灣鄉", "獅潭鄉", "泰安鄉"],
            "彰化縣": ["彰化市", "員林市", "和美鎮", "鹿港鎮", "溪湖鎮", "二林鎮", "田中鎮", "北斗鎮", "花壇鄉", "芬園鄉", "大村鄉", "永靖鄉", "伸港鄉", "線西鄉", "福興鄉", "秀水鄉", "埔心鄉", "埔鹽鄉", "大城鄉", "芳苑鄉", "竹塘鄉", "社頭鄉", "二水鄉", "田尾鄉", "埤頭鄉", "溪州鄉"],
            "南投縣": ["南投市", "埔里鎮", "草屯鎮", "竹山鎮", "集集鎮", "名間鄉", "鹿谷鄉", "中寮鄉", "魚池鄉", "國姓鄉", "水里鄉", "信義鄉", "仁愛鄉"],
            "雲林縣": ["斗六市", "斗南鎮", "虎尾鎮", "西螺鎮", "土庫鎮", "北港鎮", "古坑鄉", "大埤鄉", "莿桐鄉", "林內鄉", "二崙鄉", "崙背鄉", "麥寮鄉", "東勢鄉", "褒忠鄉", "臺西鄉", "元長鄉", "四湖鄉", "口湖鄉", "水林鄉"],
            "嘉義縣": ["太保市", "朴子市", "布袋鎮", "大林鎮", "民雄鄉", "溪口鄉", "新港鄉", "六腳鄉", "東石鄉", "義竹鄉", "鹿草鄉", "水上鄉", "中埔鄉", "竹崎鄉", "梅山鄉", "番路鄉", "大埔鄉", "阿里山鄉"],
            "屏東縣": ["屏東市", "潮州鎮", "東港鎮", "恆春鎮", "萬丹鄉", "長治鄉", "麟洛鄉", "九如鄉", "里港鄉", "鹽埔鄉", "高樹鄉", "萬巒鄉", "內埔鄉", "竹田鄉", "新埤鄉", "枋寮鄉", "新園鄉", "崁頂鄉", "林邊鄉", "南州鄉", "佳冬鄉", "琉球鄉", "車城鄉", "滿州鄉", "枋山鄉", "三地門鄉", "霧臺鄉", "瑪家鄉", "泰武鄉", "來義鄉", "春日鄉", "獅子鄉", "牡丹鄉"],
            "宜蘭縣": ["宜蘭市", "羅東鎮", "蘇澳鎮", "頭城鎮", "礁溪鄉", "壯圍鄉", "員山鄉", "冬山鄉", "五結鄉", "三星鄉", "大同鄉", "南澳鄉"],
            "花蓮縣": ["花蓮市", "鳳林鎮", "玉里鎮", "新城鄉", "吉安鄉", "壽豐鄉", "光復鄉", "豐濱鄉", "瑞穗鄉", "富里鄉", "秀林鄉", "萬榮鄉", "卓溪鄉"],
            "臺東縣": ["臺東市", "成功鎮", "關山鎮", "卑南鄉", "大武鄉", "太麻里鄉", "東河鄉", "長濱鄉", "鹿野鄉", "池上鄉", "綠島鄉", "延平鄉", "海端鄉", "達仁鄉", "金峰鄉", "蘭嶼鄉"],
            "澎湖縣": ["馬公市", "湖西鄉", "白沙鄉", "西嶼鄉", "望安鄉", "七美鄉"],
            "金門縣": ["金城鎮", "金湖鎮", "金沙鎮", "金寧鄉", "烈嶼鄉", "烏坵鄉"],
            "連江縣": ["南竿鄉", "北竿鄉", "莒光鄉", "東引鄉"]
        };
    </script>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <!-- ⚠️ 這裡修改了 id，避免與 Swal 衝突 -->
    <div id="booking-success-template" style="display:none;">
        <div class="text-left text-sm text-gray-600">
            <p class="mb-2">感謝您的填寫！請完成最後一步驟：</p>
            
            <!-- 動態插入付款規則 -->
            <div id="payment-rule-container" class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-3 text-blue-800">
                <!-- JS 會把內容塞進這裡 -->
            </div>
            
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-3">
                <p class="font-bold text-yellow-800 mb-1">💰 匯款資訊</p>
                <p>銀行代碼：<span class="font-bold text-gray-800">${config.BANK_INFO.CODE}</span></p>
                <p>銀行帳號：<span class="font-bold text-gray-800">${config.BANK_INFO.ACCOUNT}</span></p>
                ${config.BANK_INFO.NAME ? `<p>戶名：<span class="font-bold text-gray-800">${config.BANK_INFO.NAME}</span></p>` : ''}
            </div>
            <p class="font-bold text-red-500">⚠️ 匯款後請務必在 LINE 告知「帳號後五碼」</p>
            <p class="mt-1">我們查帳確認後，會回傳「預約成功通知」給您，才算完成喔！</p>
        </div>
    </div>

    <!-- 成功落地頁 (當視窗關不掉時顯示) -->
    <div id="fallback-success">
        <div class="mb-6 text-6xl text-green-500"><i class="fa-solid fa-circle-check"></i></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4 font-serif">預約已送出！</h2>
        <p class="text-gray-500 mb-8 text-sm leading-relaxed">請截圖保存下方匯款資訊<br>並於匯款後回傳帳號後五碼</p>
        <!-- 這裡的內容會由 JS 動態更新，以顯示正確規則 -->
        <div id="fallback-content"></div>
        
        <button onclick="liff.closeWindow()" class="w-full bg-gray-800 text-white py-4 rounded-xl font-bold mb-4 shadow-lg hover:bg-gray-700">關閉視窗</button>
        <p class="text-xs text-gray-400">若無法自動關閉，請點擊左上角 X</p>
    </div>

    <div id="booking-page" class="px-5 py-6 max-w-lg mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div><h1 class="text-2xl font-bold font-serif text-milu-dark">MILU BALLOONS</h1><p class="text-xs text-gray-400 tracking-widest mt-1">MAKE YOUR MOMENT SPECIAL</p></div>
            <div class="text-2xl">🎈</div>
        </div>

        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
            <button onclick="switchTab('deco')" id="btn-deco" class="tab-btn tab-active">專人佈置</button>
            <button onclick="switchTab('trunk')" id="btn-trunk" class="tab-btn tab-inactive">後車廂驚喜</button>
            <button onclick="switchTab('delivery')" id="btn-delivery" class="tab-btn tab-inactive">氣球外送</button>
            <button onclick="switchTab('pickup')" id="btn-pickup" class="tab-btn tab-inactive">工作室自取</button>
        </div>

        <!-- 1. 專人佈置 -->
        <form id="form-deco" class="space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(event, this, 'deco')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="deco-line" class="custom-input" placeholder="自動帶入" readonly></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">佈置日期</label><input type="date" id="deco-date" class="custom-input" required></div>
                <div><label class="input-label">進場時間</label><input type="time" id="deco-time" class="custom-input" required></div>
            </div>
            
            <!-- 專人佈置：改為下拉選單地址 -->
            <div>
                <label class="input-label">佈置區域</label>
                <div class="grid grid-cols-2 gap-4">
                    <select id="deco-city" class="custom-input" onchange="updateDistricts('deco')" required>
                        <option value="">請選擇縣市</option>
                    </select>
                    <select id="deco-district" class="custom-input" required>
                        <option value="">請選擇區域</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="input-label">詳細地址 / 樓層</label>
                <input type="text" id="deco-addr-detail" class="custom-input" placeholder="路/街/巷/弄/號/樓" required>
            </div>
            <!-- 原本的地址 ID 欄位 (隱藏，用來組合上面三個) -->
            <input type="hidden" id="deco-address" name="entry.362812274">

            <div><label class="input-label">場地名稱</label><input type="text" id="deco-location" class="custom-input" placeholder="例：XX飯店 502號房" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">現場聯絡人</label><input type="text" id="deco-name" class="custom-input" required></div>
                <div><label class="input-label">聯絡電話</label><input type="tel" id="deco-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我已確認場地允許進行氣球佈置，並已通知場方。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我了解空飄氣球漂浮時間約 6～8 小時，會安排在活動前 1-2 小時完成佈置以達最佳效果。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於殘膠風險： 我了解工作室使用 3M 不易殘膠布膠，並同意於 36 小時內 拆除。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若超過 36 小時未拆除導致殘膠或漆面脫落，或因牆面材質特殊造成損損，我同意工作室不負修復或賠償責任。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於作業時間：我了解專人佈置需預留 至少 2 小時 的施作時間。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 2. 氣球外送 -->
        <form id="form-delivery" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(event, this, 'delivery')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="delivery-line" class="custom-input" placeholder="自動帶入" readonly></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">外送日期</label><input type="date" id="delivery-date" class="custom-input" required></div>
                <div><label class="input-label">送達時段</label><select id="delivery-time" class="custom-input" required>
                    <option value="" disabled selected>請選擇時段</option>
                    <option value="12:30 - 13:00">12:30 - 13:00</option>
                    <option value="13:00 - 14:00">13:00 - 14:00</option>
                    <option value="14:00 - 15:00">14:00 - 15:00</option>
                    <option value="15:00 - 16:00">15:00 - 16:00</option>
                    <option value="16:00 - 17:00">16:00 - 17:00</option>
                    <option value="17:00 - 18:00">17:00 - 18:00</option>
                    <option value="18:00 - 19:00">18:00 - 19:00</option>
                </select></div>
            </div>

            <!-- 氣球外送：改為下拉選單地址 -->
            <div>
                <label class="input-label">外送區域</label>
                <div class="grid grid-cols-2 gap-4">
                    <select id="delivery-city" class="custom-input" onchange="updateDistricts('delivery')" required>
                        <option value="">請選擇縣市</option>
                    </select>
                    <select id="delivery-district" class="custom-input" required>
                        <option value="">請選擇區域</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="input-label">詳細地址 / 樓層</label>
                <input type="text" id="delivery-addr-detail" class="custom-input" placeholder="路/街/巷/弄/號 (限一樓/管理室)" required>
            </div>
            <!-- 原本的地址 ID 欄位 (隱藏，用來組合上面三個) -->
            <input type="hidden" id="delivery-address" name="entry.1233565012">

            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">收件人</label><input type="text" id="delivery-receiver" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="delivery-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>我了解空飄氣球時效約 6～8 小時（隨時間氧化變霧），已確認送達時間符合活動需求。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於交貨地點： 我了解外送僅配送至 一樓或管理室，司機不上樓，我（或收件人）會前往一樓取貨。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於商品驗收： 商品送達後，我（或收件人）會立即確認氣球完整性。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若送達當下有疑慮，我會立即向司機或 LINE 客服反映。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>若商品送達後無立即反應，後續破損或消氣會自行負責。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 3. 工作室自取 -->
        <form id="form-pickup" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(event, this, 'pickup')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="pickup-line" class="custom-input" placeholder="自動帶入" readonly></div>
            <div><label class="input-label">取貨地點</label><div class="flex gap-3 mt-2">
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="pickup-location-temp" value="板橋工作室（江子翠）" class="hidden" required onclick="document.getElementById('pickup-location').value=this.value"><span class="text-sm">板橋工作室</span></label>
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="pickup-location-temp" value="台中工作室（太平區）" class="hidden" onclick="document.getElementById('pickup-location').value=this.value"><span class="text-sm">台中工作室</span></label>
                <input type="hidden" id="pickup-location">
            </div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">取貨日期</label><input type="date" id="pickup-date" class="custom-input" required></div>
                <div><label class="input-label">取貨時間</label><select id="pickup-time" class="custom-input" required>
                    <option value="" disabled selected>請選擇時段</option>
                    <option value="12:30 - 13:00">12:30 - 13:00</option>
                    <option value="13:00 - 14:00">13:00 - 14:00</option>
                    <option value="14:00 - 15:00">14:00 - 15:00</option>
                    <option value="15:00 - 16:00">15:00 - 16:00</option>
                    <option value="16:00 - 17:00">16:00 - 17:00</option>
                    <option value="17:00 - 18:00">17:00 - 18:00</option>
                    <option value="18:00 - 19:00">18:00 - 19:00</option>
                </select></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">取貨人姓名</label><input type="text" id="pickup-name" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="pickup-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於交通工具： 氣球怕風吹且體積大，我會安排**「汽車」**取貨（❌強烈不建議騎機車）。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於司機代取： 若委託司機（如 Uber/Lalamove）代取，我理解工作室僅負責交貨時的完整性（會拍照留存），運送途中的破損風險由我自行承擔。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於商品驗收： 我（或代取人）會在**「取貨當下」**確認商品完整性，如有疑慮會立即反映。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>離店後免責： 商品交付離店後，因運送過程、環境溫度或人為擠壓造成的消氣或破損，工作室恕不負責。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於時效： 我了解空飄氣球時效約 6～8 小時（依環境而異），會隨時間氧化變霧 或 消氣。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <!-- 4. 後車廂佈置 -->
        <form id="form-trunk" class="hidden space-y-4" method="POST" target="hidden_iframe" onsubmit="return handleFormSubmit(event, this, 'trunk')">
            <div><label class="input-label">訂購人 LINE 名稱</label><input type="text" id="trunk-line" class="custom-input" placeholder="自動帶入" readonly></div>
            <div><label class="input-label">施作地點</label><div class="flex gap-3 mt-2">
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="trunk-location-temp" value="板橋工作室（江子翠）" class="hidden" required onclick="document.getElementById('trunk-location').value=this.value"><span class="text-sm">板橋工作室</span></label>
                <label class="flex-1 border border-gray-200 p-3 text-center cursor-pointer rounded-lg hover:border-milu-gold transition-colors has-[:checked]:bg-gray-800 has-[:checked]:text-white"><input type="radio" name="trunk-location-temp" value="台中工作室（太平區）" class="hidden" onclick="document.getElementById('trunk-location').value=this.value"><span class="text-sm">台中工作室</span></label>
                <input type="hidden" id="trunk-location">
            </div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">佈置日期</label><input type="date" id="trunk-date" class="custom-input" required></div>
                <div><label class="input-label">抵達時間</label><input type="time" id="trunk-time" class="custom-input" required></div>
            </div>
            <div><label class="input-label">車款型號</label><input type="text" id="trunk-car" class="custom-input" placeholder="例如：Toyota RAV4" required></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="input-label">姓名</label><input type="text" id="trunk-name" class="custom-input" required></div>
                <div><label class="input-label">電話</label><input type="tel" id="trunk-phone" class="custom-input" required></div>
            </div>
            <div class="pt-4 border-t border-gray-100 mt-6"><p class="text-sm font-bold text-gray-800 mb-3">預約須知與條款</p><div class="space-y-3">
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於作業時間： 我了解後車廂佈置需預留 至少 1 小時 的施作時間，我會準時抵達。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於時效： 如有訂購空飄氣球我了解空飄氣球時效約 6～8 小時（依環境而異），建議於活動前 1～2 小時內完成佈置以達最佳效果。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>關於空間： 我會提前清空後車廂雜物，以便現場人員直接進行佈置。</span></label>
                <label class="checkbox-item"><input type="checkbox" class="checkbox-input dummy-term" required><span>離場後免責： 佈置完成驗收離場後，因行駛過程晃動、溫度變化或人為因素導致的破損或位移，工作室恕不負責。</span></label>
            </div></div>
            <div class="mt-8 mb-4"><button type="submit" class="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition transform active:scale-95">提交預約 (下一步：匯款)</button></div>
        </form>

        <div class="text-center mt-6">
            <p class="text-xs text-gray-300 font-serif tracking-wider">&copy; 2025 MILU BALLOONS</p>
        </div>
    </div>

    <script>
        window.onload = function() {
            initAddressSelectors('deco');
            initAddressSelectors('delivery');
            if (config.LIFF_ID) {
                liff.init({ liffId: config.LIFF_ID }).then(() => {
                    if (!liff.isLoggedIn()) { liff.login(); } 
                    else {
                        liff.getProfile().then(profile => {
                            const displayName = profile.displayName;
                            document.getElementById('deco-line').value = displayName;
                            document.getElementById('delivery-line').value = displayName;
                            document.getElementById('pickup-line').value = displayName;
                            document.getElementById('trunk-line').value = displayName;
                        }).catch(e => console.log('Profile Error', e));
                    }
                }).catch(err => console.error('LIFF Init Error:', err));
            }
            bindFormInputs();
        };

        function initAddressSelectors(type) {
            const citySelect = document.getElementById(type + '-city');
            const districtSelect = document.getElementById(type + '-district');

            Object.keys(taiwanPlaces).forEach(city => {
                const option = document.createElement('option');
                option.value = city; option.text = city;
                citySelect.appendChild(option);
            });
        }
        function updateDistricts(type) {
            const citySelect = document.getElementById(type + '-city');
            const districtSelect = document.getElementById(type + '-district');
            const selectedCity = citySelect.value;
            districtSelect.innerHTML = '<option value="">請選擇區域</option>';
            if (selectedCity && taiwanPlaces[selectedCity]) {
                taiwanPlaces[selectedCity].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district; option.text = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        // ... bindFormInputs, switchTab 保持不變 ...
        function bindFormInputs() {
            const decoForm = document.getElementById('form-deco');
            decoForm.action = config.DECO.ACTION;
            document.getElementById('deco-line').name = 'entry.' + config.DECO.LINE_ID;
            document.getElementById('deco-location').name = 'entry.' + config.DECO.LOCATION_ID;
            document.getElementById('deco-name').name = 'entry.' + config.DECO.NAME_ID;
            document.getElementById('deco-phone').name = 'entry.' + config.DECO.PHONE_ID;
            if(config.DECO.SYSTEM_ID) createHiddenInput(decoForm, 'entry.' + config.DECO.SYSTEM_ID, '');

            const deliveryForm = document.getElementById('form-delivery');
            if (config.DELIVERY.ACTION) {
                deliveryForm.action = config.DELIVERY.ACTION;
                document.getElementById('delivery-line').name = 'entry.' + config.DELIVERY.LINE_ID;
                document.getElementById('delivery-time').name = 'entry.' + config.DELIVERY.TIME_ID;
                document.getElementById('delivery-receiver').name = 'entry.' + config.DELIVERY.RECEIVER_ID;
                document.getElementById('delivery-phone').name = 'entry.' + config.DELIVERY.PHONE_ID;
                if(config.DELIVERY.SYSTEM_ID) createHiddenInput(deliveryForm, 'entry.' + config.DELIVERY.SYSTEM_ID, '');
            }
            const pickupForm = document.getElementById('form-pickup');
            if (config.PICKUP.ACTION) {
                pickupForm.action = config.PICKUP.ACTION;
                document.getElementById('pickup-line').name = 'entry.' + config.PICKUP.LINE_ID;
                document.getElementById('pickup-location').name = 'entry.' + config.PICKUP.LOCATION_ID;
                document.getElementById('pickup-time').name = 'entry.' + config.PICKUP.TIME_ID; 
                document.getElementById('pickup-name').name = 'entry.' + config.PICKUP.NAME_ID;
                document.getElementById('pickup-phone').name = 'entry.' + config.PICKUP.PHONE_ID;
                if(config.PICKUP.SYSTEM_ID) createHiddenInput(pickupForm, 'entry.' + config.PICKUP.SYSTEM_ID, '');
            }
            const trunkForm = document.getElementById('form-trunk');
            trunkForm.action = config.TRUNK.ACTION;
            document.getElementById('trunk-line').name = 'entry.' + config.TRUNK.LINE_ID;
            document.getElementById('trunk-location').name = 'entry.' + config.TRUNK.LOCATION_ID;
            document.getElementById('trunk-time').name = 'entry.' + config.TRUNK.TIME_ID;
            document.getElementById('trunk-car').name = 'entry.' + config.TRUNK.CAR_ID;
            document.getElementById('trunk-name').name = 'entry.' + config.TRUNK.NAME_ID;
            document.getElementById('trunk-phone').name = 'entry.' + config.TRUNK.PHONE_ID;
            if(config.TRUNK.SYSTEM_ID) createHiddenInput(trunkForm, 'entry.' + config.TRUNK.SYSTEM_ID, '');
        }

        function switchTab(type) {
             ['deco', 'delivery', 'pickup', 'trunk'].forEach(t => {
                const btn = document.getElementById('btn-' + t);
                const form = document.getElementById('form-' + t);
                if (t === type) {
                    btn.classList.add('tab-active'); btn.classList.remove('tab-inactive');
                    form.classList.remove('hidden');
                } else {
                    btn.classList.add('tab-inactive'); btn.classList.remove('tab-active');
                    form.classList.add('hidden');
                }
            });
        }

        function calculateDaysDiff(dateStr) {
            if (!dateStr) return 0;
            const targetDate = new Date(dateStr);
            const today = new Date();
            // Reset time to compare dates only
            targetDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getPaymentMessage(type, dateStr) {
            const rules = config.PAYMENT_RULES;
            const diffDays = calculateDaysDiff(dateStr);
            
            if (type === 'deco' || type === 'trunk') {
                if (diffDays <= 3) {
                    return rules.DECO_URGENT;
                } else {
                    return rules.DECO_NORMAL;
                }
            } else {
                return rules.SIMPLE;
            }
        }

        async function handleFormSubmit(event, form, type) {
            event.preventDefault(); 
            const configEntry = config[type.toUpperCase()];
            form.action = configEntry.ACTION;

            // ⚠️ 關鍵：組合地址 (縣市+區域+詳細)
            if (type === 'deco' || type === 'delivery') {
                const city = document.getElementById(type + '-city').value;
                const district = document.getElementById(type + '-district').value;
                const detail = document.getElementById(type + '-addr-detail').value;

                if (!city || !district || !detail) {
                    Swal.fire({
                        title: '請填寫完整地址',
                        text: '縣市、區域與詳細地址皆為必填',
                        icon: 'warning',
                        confirmButtonText: '好的',
                        confirmButtonColor: '#C69C6D'
                    });
                    return false;
                }
                
                let addressInput = document.getElementById(type + '-address');
                if (addressInput) {
                    addressInput.value = `${city}${district}${detail}`;
                } else {
                     createHiddenInput(form, 'entry.' + configEntry.ADDRESS_ID, `${city}${district}${detail}`);
                }
            }
            
            let sysInput = null;
            if (configEntry.SYSTEM_ID) {
                sysInput = form.querySelector(`input[name="entry.${configEntry.SYSTEM_ID}"]`);
                if (!sysInput) {
                    sysInput = document.createElement('input');
                    sysInput.type = 'hidden';
                    sysInput.name = 'entry.' + configEntry.SYSTEM_ID;
                    form.appendChild(sysInput);
                }
                if(liff.isInClient() && liff.isLoggedIn()) {
                    try {
                        const profile = await liff.getProfile();
                        sysInput.value = profile.userId;
                    } catch (e) {}
                }
            }
            
            if (configEntry.PAYMENT_ID) {
                let payInput = form.querySelector(`input[name="entry.${configEntry.PAYMENT_ID}"]`);
                if(!payInput) {
                    payInput = document.createElement('input');
                    payInput.type = 'hidden';
                    payInput.name = 'entry.' + configEntry.PAYMENT_ID;
                    form.appendChild(payInput);
                }
                payInput.value = '未付款';
            }
            if (configEntry.SERVICE_ID) {
                const serviceNameMap = { 'deco': '專人佈置', 'delivery': '氣球外送', 'trunk': '後車廂驚喜', 'pickup': '工作室自取' };
                let serviceInput = form.querySelector(`input[name="entry.${configEntry.SERVICE_ID}"]`);
                if (!serviceInput) {
                    serviceInput = document.createElement('input');
                    serviceInput.type = 'hidden';
                    serviceInput.name = 'entry.' + configEntry.SERVICE_ID;
                    form.appendChild(serviceInput);
                }
                serviceInput.value = serviceNameMap[type];
            }

            const dateInput = document.getElementById(type + '-date');
            if(dateInput && dateInput.value) {
                const parts = dateInput.value.split('-');
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_year', parts[0]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_month', parts[1]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID + '_day', parts[2]);
                createHiddenInput(form, 'entry.' + configEntry.DATE_ID, dateInput.value); 
            }
            
            const timeInput = document.getElementById(type + '-time');
            if(timeInput && (type === 'deco' || type === 'trunk')) {
                 if(timeInput.value) {
                    const parts = timeInput.value.split(':');
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID + '_hour', parts[0]);
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID + '_minute', parts[1]);
                    createHiddenInput(form, 'entry.' + configEntry.TIME_ID, timeInput.value); 
                }
            }

            let terms = [];
            if(type === 'deco') {
                terms = ["我已確認場地允許進行氣球佈置，並已通知場方。", "我了解空飄氣球漂浮時間約 6～8 小時，會安排在活動前 1-2 小時完成佈置以達最佳效果。", "關於殘膠風險： 我了解工作室使用 3M 不易殘膠布膠，並同意於 36 小時內 拆除。", "若超過 36 小時未拆除導致殘膠或漆面脫落，或因牆面材質特殊造成損損，我同意工作室不負修復或賠償責任。", "關於作業時間：我了解專人佈置需預留 至少 2 小時 的施作時間。"];
            } else if(type === 'delivery') {
                terms = ["我了解空飄氣球時效約 6～8 小時（隨時間氧化變霧），已確認送達時間符合活動需求。", "關於交貨地點： 我了解外送僅配送至 一樓或管理室，司機不上樓，我（或收件人）會前往一樓取貨。", "關於商品驗收： 商品送達後，我（或收件人）會立即確認氣球完整性。", "若送達當下有疑慮，我會立即向司機或 LINE 客服反映。", "若商品送達後無立即反應，後續破損或消氣會自行負責。"];
            } else if(type === 'pickup') {
                terms = ["關於交通工具： 氣球怕風吹且體積大，我會安排**「汽車」**取貨（❌強烈不建議騎機車）。", "關於司機代取： 若委託司機（如 Uber/Lalamove）代取，我理解工作室僅負責交貨時的完整性（會拍照留存），運送途中的破損風險由我自行承擔。", "關於商品驗收： 我（或代取人）會在**「取貨當下」**確認商品完整性，如有疑慮會立即反映。", "離店後免責： 商品交付離店後，因運送過程、環境溫度或人為擠壓造成的消氣或破損，工作室恕不負責。", "關於時效： 我了解空飄氣球時效約 6～8 小時（依環境而異），會隨時間氧化變霧 或 消氣。"];
            } else if(type === 'trunk') {
                terms = ["關於作業時間： 我了解後車廂佈置需預留 至少 1 小時 的施作時間，我會準時抵達。", "關於時效： 如有訂購空飄氣球我了解空飄氣球時效約 6～8 小時（依環境而異），建議於活動前 1～2 小時內完成佈置以達最佳效果。", "關於空間： 我會提前清空後車廂雜物，以便現場人員直接進行佈置。", "離場後免責： 佈置完成驗收離場後，因行駛過程晃動、溫度變化或人為因素導致的破損或位移，工作室恕不負責。"];
            }
            
            terms.forEach(t => createHiddenInput(form, 'entry.' + configEntry.TERMS_ID, t));

            submitted = true;
            form.submit();

            // 計算付款規則訊息
            const paymentMessage = getPaymentMessage(type, dateInput.value);

            // 成功畫面切換 & 顯示付款規則
            if (liff.isInClient()) {
                Swal.fire({
                    title: '預約單已送出！',
                    html: `
                        <div class="text-left text-sm text-gray-600 space-y-4">
                            <!-- 銀行帳號區塊 -->
                            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 shadow-sm">
                                <div class="flex items-center gap-2 mb-2 text-yellow-800 border-b border-yellow-200 pb-2">
                                    <i class="fa-solid fa-sack-dollar text-lg"></i>
                                    <span class="font-bold text-lg">匯款資訊</span>
                                </div>
                                <div class="space-y-1">
                                    <p><span class="text-gray-500 text-xs block">銀行代碼</span> <span class="font-bold text-gray-800 text-lg">${config.BANK_INFO.CODE}</span></p>
                                    <p><span class="text-gray-500 text-xs block">銀行帳號</span> <span class="font-mono font-bold text-xl text-gray-800 tracking-wider">${config.BANK_INFO.ACCOUNT}</span></p>
                                    ${config.BANK_INFO.NAME ? `<p><span class="text-gray-500 text-xs block">戶名</span> <span class="font-bold text-gray-800">${config.BANK_INFO.NAME}</span></p>` : ''}
                                </div>
                            </div>
                            
                            <!-- 付款規則區塊 -->
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-blue-900 shadow-sm">
                                <div class="leading-relaxed text-sm">
                                    ${paymentMessage}
                                </div>
                            </div>

                            <div class="bg-red-50 p-3 rounded-lg border border-red-100 text-center">
                                <p class="font-bold text-red-500 text-sm">⚠️ 匯款後請務必截圖回傳「帳號後五碼」</p>
                                <p class="text-xs text-gray-500 mt-1">我們查帳確認後，會回傳「預約成功通知」給您，才算完成喔！</p>
                            </div>
                        </div>
                    `,
                    icon: 'success',
                    confirmButtonText: '好的，關閉視窗',
                    confirmButtonColor: '#4A4A4A',
                    background: '#FFFFFF',
                    width: '90%',
                    customClass: { 
                        title: 'font-serif text-milu-gold text-2xl font-bold', 
                        popup: 'rounded-2xl shadow-xl' 
                    },
                    allowOutsideClick: false
                }).then(() => {
                    const nameId = type === 'delivery' ? 'delivery-receiver' : type + '-name';
                    const nameVal = document.getElementById(nameId) ? document.getElementById(nameId).value : '-';
                    
                    sendFlexMessageAndClose(
                        type === 'deco' ? '專人佈置' : (type === 'delivery' ? '氣球外送' : (type === 'pickup' ? '工作室自取' : '後車廂驚喜')), 
                        nameVal, 
                        dateInput.value, 
                        timeInput.value
                    );
                });
            } else {
                // 更新網頁版成功畫面內容
                const fallbackContent = document.getElementById('fallback-content');
                if(fallbackContent) {
                    fallbackContent.innerHTML = `
                         <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-6 text-left text-blue-900 shadow-sm">
                            <p class="font-bold text-lg mb-2"><i class="fa-solid fa-circle-info mr-1"></i> 付款注意事項</p>
                            ${paymentMessage}
                        </div>
                    `;
                }
                document.getElementById('booking-page').style.display = 'none';
                document.getElementById('fallback-success').style.display = 'block';
            }

            return false;
        }

        // ... (其餘部分保持不變) ...
        function sendFlexMessageAndClose(service, name, date, time) {
             if (liff.isInClient()) {
                liff.sendMessages([{
                    type: 'flex',
                    altText: '預約申請已收到',
                    contents: {
                        "type": "bubble",
                        "size": "mega",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "預約申請已收到", "weight": "bold", "color": "#C69C6D", "size": "sm" },
                                { "type": "text", "text": "感謝您的預約！", "weight": "bold", "size": "xl", "margin": "md" },
                                { "type": "text", "text": "請匯款後回傳帳號後五碼", "size": "xs", "color": "#aaaaaa", "wrap": true },
                                { "type": "separator", "margin": "xxl" },
                                {
                                    "type": "box", "layout": "vertical", "margin": "xxl", "spacing": "sm",
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "姓名", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": name, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "項目", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": service, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "日期", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": date, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "時間", "size": "sm", "color": "#555555", "flex": 0 }, { "type": "text", "text": time, "size": "sm", "color": "#111111", "align": "end" } ] }
                                    ]
                                },
                                { "type": "separator", "margin": "xxl" },
                                { "type": "box", "layout": "vertical", "margin": "md", "backgroundColor": "#F9F7F2", "cornerRadius": "md", "paddingAll": "md", "contents": [ { "type": "text", "text": "匯款帳號 (彰化銀行 009)", "size": "xs", "color": "#C69C6D", "weight": "bold" }, { "type": "text", "text": config.BANK_INFO.ACCOUNT, "size": "lg", "weight": "bold", "color": "#4A4A4A", "margin": "sm" }, { "type": "text", "text": config.BANK_INFO.NAME, "size": "xs", "color": "#999999" } ] }
                            ]
                        }
                    }
                }]).then(() => {
                    setTimeout(() => { liff.closeWindow(); }, 500);
                }).catch((err) => {
                    console.log('Msg Error', err);
                    document.getElementById('booking-page').style.display = 'none';
                    document.getElementById('fallback-success').style.display = 'block';
                    liff.closeWindow(); 
                });
            }
        }

        function createHiddenInput(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        }
    </script>
</body>
</html>
