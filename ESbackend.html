<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>East Store 系統 - 專業全屏版</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; height: 100vh; overflow: hidden; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .btn-active:active { transform: scale(0.95); }
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 選中狀態（側邊欄） */
        .selected-order { border-left: 6px solid #3b82f6 !important; background-color: #f8fafc; position: relative; }
        .selected-order::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: #3b82f6; border-radius: 4px 0 0 4px; }
    </style>
</head>
<body class="flex flex-col">

    <!-- 頂部導覽列 -->
    <header class="bg-[#0f172a] text-white p-4 shadow-xl flex justify-between items-center z-40">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/20">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM12 18h.01"/></svg>
            </div>
            <div>
                <h1 class="text-base md:text-xl font-black tracking-tighter uppercase italic leading-none">East Store <span class="text-blue-400">Admin</span></h1>
                <p id="sync-status" class="text-[9px] md:text-[10px] font-bold text-slate-500 uppercase tracking-[0.3em] mt-1">系統準備就緒</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-xs font-bold transition-all btn-active border border-slate-700">
                <svg id="refresh-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                <span class="hidden sm:inline uppercase">Sync Data</span>
            </button>
        </div>
    </header>

    <!-- 主內容區 -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- 左側：訂單選單 -->
        <aside id="sidebar" class="w-full md:w-[320px] lg:w-[380px] xl:w-[420px] border-r border-slate-200 bg-white flex flex-col h-full z-10 shadow-sm transition-all duration-300">
            <!-- 搜尋區 -->
            <div class="p-5 border-b border-slate-100 space-y-4 bg-white sticky top-0 z-10">
                <div class="relative group">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <input id="search-input" type="text" placeholder="搜尋訂單或姓名..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border-none rounded-2xl text-sm outline-none focus:ring-2 ring-blue-100 transition-all font-bold">
                </div>
                <div class="flex gap-2">
                    <button id="sort-id-btn" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest border bg-blue-600 text-white border-blue-600 shadow-lg shadow-blue-100 transition-all">編號 <span id="sort-id-icon">▼</span></button>
                    <button id="sort-date-btn" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest border bg-white text-slate-400 border-slate-100 transition-all">日期 <span id="sort-date-icon"></span></button>
                </div>
            </div>

            <!-- 列表 -->
            <div id="sidebar-list" class="flex-1 overflow-y-auto no-scrollbar">
                <div class="p-20 text-center flex flex-col items-center">
                    <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full spin mb-4"></div>
                    <p class="text-slate-300 font-bold text-xs uppercase tracking-widest animate-pulse">Fetching orders...</p>
                </div>
            </div>

            <!-- 載入更多 -->
            <div id="load-more-area" class="p-4 border-t border-slate-50 hidden bg-white">
                <button id="load-more-btn" class="w-full py-3 bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] rounded-xl hover:bg-blue-50 hover:text-blue-500 transition-all">Load More</button>
            </div>
        </aside>

        <!-- 右側：詳情視窗 -->
        <main id="main-content" class="absolute inset-0 md:relative md:flex-1 bg-slate-50 overflow-y-auto z-20 translate-x-full md:translate-x-0 transition-transform duration-300">
            
            <!-- 置頂專用透明點 -->
            <div id="top-anchor" style="height: 1px;"></div>

            <!-- 手機版 Header -->
            <div class="md:hidden bg-white/80 backdrop-blur-md p-4 border-b border-slate-200 flex items-center gap-4 sticky top-0 z-50">
                <button onclick="backToList()" class="p-2 -ml-2 text-slate-800 bg-slate-100 rounded-xl btn-active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <h2 id="mobile-title" class="font-black text-slate-900 tracking-tighter uppercase text-sm">Order Info</h2>
            </div>

            <!-- 初始加載中的提示 (只有還沒選中時顯示) -->
            <div id="empty-state" class="flex h-full flex-col items-center justify-center text-slate-300">
                <div class="text-center p-12">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full spin mx-auto mb-6"></div>
                    <p class="font-black text-xl text-[#0f172a] tracking-widest uppercase">Initializing...</p>
                    <p class="text-slate-400 text-xs font-bold mt-2 uppercase tracking-[0.3em]">系統正在自動讀取首筆訂單</p>
                </div>
            </div>

            <!-- 詳情內容區 -->
            <div id="detail-content" class="hidden p-4 md:p-10 w-full h-fit pb-32">
                <!-- 由 JavaScript 渲染 -->
            </div>
        </main>
    </div>

    <!-- 狀態通知 -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 md:left-auto md:right-10 md:translate-x-0 px-8 py-4 rounded-[2rem] shadow-2xl z-50 font-black text-xs uppercase bg-[#0f172a] text-white flex items-center gap-4 transition-all opacity-0 pointer-events-none transform translate-y-10">
        <div class="w-2 h-2 bg-blue-400 rounded-full animate-ping"></div>
        <span id="toast-msg">Success</span>
    </div>

    <script>
        // --- 1. 配置 ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwhH5axa1J6Q9nThs0Z8SQ3O4aEUAsTg5p9aTa1Mdwe-iJAd1GbI8t2SS1KnF6MDCTqBQ/exec";
        const PAGE_SIZE = 10; 
        let allOrders = [];
        let filteredOrders = [];
        let displayedCount = PAGE_SIZE;
        let currentSort = { key: 'id', desc: true };
        let selectedId = null;
        let isEditing = false;

        const FIELD_MAPS = {
            id: ["訂單編號", "編號", "OrderID", "ID"],
            name: ["姓名", "名字", "客戶姓名"],
            phone: ["電話", "聯絡電話", "手機"],
            recipientName: ["收件人", "收件者"],
            recipientPhone: ["收件電話", "收件人電話"],
            address: ["配送地址", "送貨地址", "收件地址", "地址"],
            date: ["取貨/送貨日期", "取貨日期", "送貨日期"],
            time: ["時間", "送貨時間"],
            period: ["時段", "配送時段"],
            note: ["備註"],
            syncStatus: ["同步狀態"]
        };

        const PERIOD_TAGS = ["不指定", "13:00 前", "14:00-18:00"];

        // --- 2. 核心工具 ---
        function getVal(order, type) {
            if (!order) return "";
            const keys = Object.keys(order);
            const targets = FIELD_MAPS[type];
            let key = keys.find(k => targets.includes(k.trim()));
            if (!key) key = keys.find(k => targets.some(t => k.includes(t)));
            let v = order[key] || "";
            if (type === 'phone' || type === 'recipientPhone') {
                v = String(v).trim();
                if (v.length === 9 && v.startsWith('9')) v = '0' + v;
            }
            if (type === 'date' && v) {
                const d = new Date(v);
                return (isNaN(d.getTime()) || d.getFullYear() === 1899) ? String(v) : d.toLocaleDateString('zh-TW');
            }
            if (type === 'time' || type === 'period') {
                let tKey = keys.find(k => FIELD_MAPS.time.includes(k.trim()));
                let pKey = keys.find(k => FIELD_MAPS.period.includes(k.trim()));
                let tv = order[tKey] || "";
                let pv = order[pKey] || "";
                if (String(tv).includes("1899")) {
                    const d = new Date(tv);
                    tv = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
                }
                if (String(tv).includes("-") || String(tv).includes("下午")) {
                    if (!pv) { pv = tv; tv = ""; }
                }
                return type === 'time' ? String(tv) : String(pv);
            }
            return String(v);
        }

        function forceScrollTop() {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.scrollTop = 0;
                mainContent.scrollTo({ top: 0, behavior: 'instant' });
                // 輔助：對齊頂部錨點
                const anchor = document.getElementById('top-anchor');
                if (anchor) anchor.scrollIntoView({ block: 'start', behavior: 'instant' });
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.style.opacity = '1'; toast.style.transform = 'translateY(0)';
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(2.5rem)'; }, 3000);
        }

        // --- 3. 渲染視圖 ---

        function renderSidebar() {
            const list = document.getElementById('sidebar-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            filteredOrders = allOrders.filter(o => !search || [getVal(o, 'id'), getVal(o, 'name')].some(v => v.toLowerCase().includes(search)));
            filteredOrders.sort((a, b) => {
                const valA = String(getVal(a, currentSort.key)), valB = String(getVal(b, currentSort.key));
                let res = valA.localeCompare(valB, undefined, {numeric: true});
                return currentSort.desc ? -res : res;
            });

            const toShow = filteredOrders.slice(0, displayedCount);
            if (toShow.length === 0) {
                list.innerHTML = `<div class="p-10 text-center text-slate-300 font-bold text-sm uppercase tracking-widest">No Results</div>`;
            } else {
                list.innerHTML = toShow.map(o => {
                    const id = getVal(o, 'id'), name = getVal(o, 'name'), date = getVal(o, 'date');
                    const isSelected = selectedId && selectedId.toString() === id.toString();
                    const displayId = id.toString().startsWith('#') ? id : '#'+id;
                    return `
                    <div onclick="selectOrder('${id}')" class="p-6 border-b border-slate-50 cursor-pointer hover:bg-slate-50 transition-all ${isSelected ? 'selected-order' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-mono font-black ${isSelected ? 'text-blue-600' : 'text-slate-400'} text-sm tracking-tighter">${displayId}</span>
                            <span class="text-[9px] text-slate-400 font-black uppercase tracking-wider">${date}</span>
                        </div>
                        <div class="text-[15px] font-bold text-slate-800">${name || "Guest"}</div>
                    </div>`;
                }).join('');
            }
            document.getElementById('load-more-area').classList.toggle('hidden', filteredOrders.length <= displayedCount);
        }

        function renderDetail() {
            const detailView = document.getElementById('detail-content');
            const emptyState = document.getElementById('empty-state');
            const mainContent = document.getElementById('main-content');
            
            if (!selectedId) {
                detailView.classList.add('hidden');
                emptyState.classList.remove('hidden');
                if (window.innerWidth < 768) mainContent.classList.add('translate-x-full');
                return;
            }

            const order = allOrders.find(o => getVal(o, 'id').toString().trim() === selectedId.toString().trim());
            
            if (!order) {
                detailView.classList.remove('hidden'); emptyState.classList.add('hidden');
                detailView.innerHTML = `<div class="p-20 text-center text-slate-300 font-bold tracking-widest animate-pulse">載入中...</div>`;
                forceScrollTop();
                return;
            }

            detailView.classList.remove('hidden'); emptyState.classList.add('hidden');
            mainContent.classList.remove('translate-x-full');

            const id = getVal(order, 'id');
            const displayId = id.toString().startsWith('#') ? id : `#${id}`;
            document.getElementById('mobile-title').innerText = displayId;

            detailView.innerHTML = `
                <!-- 頂部標題與操作區 -->
                <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 mb-6 border-b border-slate-100 pb-6">
                    <div>
                        <h2 class="text-5xl font-black text-[#0f172a] tracking-tighter">${displayId}</h2>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] mt-1">Management Console</p>
                    </div>
                    <div class="flex gap-3 w-full xl:w-auto">
                        ${isEditing ? `
                            <button onclick="saveOrder('${id}')" class="flex-1 xl:flex-none flex items-center justify-center gap-3 px-8 py-3.5 bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-100 btn-active text-xs uppercase">Confirm Save</button>
                            <button onclick="isEditing=false; renderDetail();" class="px-8 py-3.5 bg-white border border-slate-200 text-slate-400 rounded-2xl font-black text-xs uppercase btn-active">Cancel</button>
                        ` : `
                            <button onclick="isEditing=true; renderDetail();" class="flex-1 xl:flex-none flex items-center justify-center gap-3 px-8 py-3.5 bg-[#0f172a] text-white rounded-2xl font-black shadow-2xl shadow-slate-300 btn-active hover:bg-blue-600 text-xs uppercase transition-all">Edit Order</button>
                        `}
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 h-fit items-start">
                    <!-- 第一欄 -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/40 border border-white">
                            <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-6">Contact</h3>
                            <div class="space-y-6">${detailField("訂購人姓名", "name", order)}${detailField("訂購電話", "phone", order)}</div>
                        </div>
                        <div class="bg-blue-50/50 p-6 rounded-[2rem] shadow-sm border border-blue-100/50">
                            <h3 class="text-[10px] font-black text-blue-300 uppercase tracking-[0.3em] mb-6">Recipient</h3>
                            <div class="space-y-6">${detailField("收件人姓名", "recipientName", order)}${detailField("收件電話", "recipientPhone", order)}</div>
                        </div>
                    </div>
                    <!-- 第二欄 -->
                    <div class="bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/40 border border-white lg:min-h-[400px] flex flex-col">
                        <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-6">Address</h3>
                        <div class="flex-1">${detailField("詳細配送地址", "address", order, "textarea")}</div>
                    </div>
                    <!-- 第三欄 -->
                    <div class="bg-white p-6 rounded-[2rem] shadow-xl shadow-slate-200/40 border border-white h-full">
                        <h3 class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em] mb-6">Logistics</h3>
                        <div class="space-y-8">${detailField("配送日期", "date", order, "date")}${detailField("配送時間", "time", order, "time")}${detailField("時段標籤", "period", order, "period-tags")}</div>
                    </div>
                    <!-- 備註 -->
                    <div class="xl:col-span-3 bg-slate-100/50 p-6 rounded-[2rem]">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Internal Notes</h3>
                        ${detailField("備註說明", "note", order, "textarea")}
                    </div>
                </div>
            `;
            // 渲染後強制置頂
            forceScrollTop();
        }

        function detailField(label, type, order, inputType = "text") {
            let val = getVal(order, type);
            if (isEditing) {
                if (inputType === "date" && val) {
                    const d = new Date(val);
                    if (!isNaN(d.getTime())) val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
                if (inputType === "period-tags") {
                    return `<div class="flex flex-col gap-3">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${label}</span>
                        <div class="flex flex-wrap gap-2">${PERIOD_TAGS.map(tag => `<button onclick="setPeriodValue('${tag}')" class="px-3 py-1.5 rounded-xl text-[10px] font-black border transition-all ${val === tag ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-400 border-slate-100 shadow-sm'}">${tag}</button>`).join('')}</div>
                        <input id="edit-period" type="text" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm focus:border-blue-500 focus:bg-white outline-none font-bold bg-slate-50 transition-all shadow-inner" value="${val}">
                    </div>`;
                }
                if (inputType === "textarea") {
                    return `<div class="flex flex-col gap-1 h-full"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${label}</span><textarea id="edit-${type}" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm focus:border-blue-500 focus:bg-white outline-none font-bold bg-slate-50 transition-all min-h-[100px] shadow-inner">${val}</textarea></div>`;
                }
                return `<div class="flex flex-col gap-2"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${label}</span><input id="edit-${type}" type="${type === 'time' ? 'time' : inputType}" class="w-full border-2 border-slate-100 p-4 rounded-2xl text-sm focus:border-blue-500 focus:bg-white outline-none font-bold bg-slate-50 transition-all shadow-inner" value="${val}"></div>`;
            }
            return `<div class="flex flex-col text-left group"><span class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-3 leading-none">${label}</span><span class="text-[16px] font-bold text-slate-800 leading-tight">${val || "---"}</span></div>`;
        }

        // --- 4. 行為控制 ---

        function selectOrder(id) {
            selectedId = id; isEditing = false;
            // 先強制重置視角
            forceScrollTop();
            renderSidebar(); 
            renderDetail();
        }

        function backToList() { selectedId = null; isEditing = false; renderSidebar(); renderDetail(); }

        function setPeriodValue(val) {
            const input = document.getElementById('edit-period');
            if (input) {
                input.value = val;
                const btns = input.parentElement.querySelectorAll('button');
                btns.forEach(b => {
                    b.className = b.innerText === val ? 'px-4 py-2 rounded-xl text-[10px] font-black border transition-all bg-blue-600 text-white border-blue-600 shadow-lg' : 'px-3 py-1.5 rounded-xl text-[10px] font-black border transition-all bg-white text-slate-400 border-slate-100 shadow-sm';
                });
            }
        }

        async function fetchOrders() {
            document.getElementById('sync-status').innerText = "雲端同步中...";
            document.getElementById('refresh-icon').classList.add('spin');
            try {
                const res = await fetch(`${GAS_API_URL}?action=getOrders`);
                allOrders = await res.json();
                document.getElementById('sync-status').innerText = `最後同步：${new Date().toLocaleTimeString()} | 共 ${allOrders.length} 筆`;
                
                // --- 重點修正：如果還沒選中任何訂單，自動選取清單中的第一筆 ---
                if (allOrders.length > 0 && !selectedId) {
                    const firstId = getVal(allOrders[0], 'id');
                    selectOrder(firstId);
                } else {
                    renderSidebar(); 
                    renderDetail(); 
                }
            } catch (e) { showToast("連線失敗"); }
            finally { document.getElementById('refresh-icon').classList.remove('spin'); }
        }

        async function saveOrder(id) {
            document.getElementById('sync-status').innerText = "等待同步中...";
            showToast("正在傳送更新...");
            const order = allOrders.find(o => getVal(o, 'id').toString().trim() === id.toString().trim());
            const dataToSend = { "訂單編號": id };
            const syncHeader = Object.keys(order).find(k => FIELD_MAPS.syncStatus.includes(k.trim())) || "同步狀態";
            dataToSend[syncHeader] = "等待同步";

            ['name', 'phone', 'recipientName', 'recipientPhone', 'address', 'date', 'time', 'period', 'note'].forEach(type => {
                const el = document.getElementById(`edit-${type === 'period' ? 'period' : type}`);
                if (el) {
                    const rk = Object.keys(order).find(k => FIELD_MAPS[type].includes(k.trim())) || FIELD_MAPS[type][0];
                    let val = el.value;
                    if (type === 'date' && val) val = val.replace(/-/g, '/');
                    if ((type === 'phone' || type === 'recipientPhone') && val) val = "'" + val;
                    dataToSend[rk] = val;
                }
            });

            isEditing = false; renderDetail();
            try {
                await fetch(GAS_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateOrder', data: dataToSend }) });
                showToast("雲端同步完成");
                setTimeout(fetchOrders, 800);
            } catch (e) { alert("儲存失敗"); document.getElementById('sync-status').innerText = "同步失敗"; }
        }

        document.getElementById('refresh-btn').onclick = fetchOrders;
        document.getElementById('search-input').oninput = () => { displayedCount = PAGE_SIZE; renderSidebar(); };
        document.getElementById('load-more-btn').onclick = () => { displayedCount += PAGE_SIZE; renderSidebar(); };
        
        document.getElementById('sort-id-btn').onclick = () => {
            currentSort = { key: 'id', desc: currentSort.key === 'id' ? !currentSort.desc : true };
            renderSidebar();
        };

        document.getElementById('sort-date-btn').onclick = () => {
            currentSort = { key: 'date', desc: currentSort.key === 'date' ? !currentSort.desc : true };
            renderSidebar();
        };

        window.onload = fetchOrders;
    </script>
</body>
</html>
