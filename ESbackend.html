<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Official website calendar Admin Pro</title>
    <!-- ËºâÂÖ•ÂøÖË¶ÅÂ•ó‰ª∂ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-card { border-left: 5px solid #3b82f6 !important; background-color: #eff6ff; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbwhH5axa1J6Q9nThs0Z8SQ3O4aEUAsTg5p9aTa1Mdwe-iJAd1GbI8t2SS1KnF6MDCTqBQ/exec";
        
        const FIELD_DEFINITIONS = {
            id: ["Ë®ÇÂñÆÁ∑®Ëôü", "Á∑®Ëôü", "OrderID"],
            name: ["Êî∂‰ª∂‰∫∫ÂßìÂêç", "ÂßìÂêç", "ÂêçÂ≠ó", "ÂÆ¢Êà∂ÂßìÂêç"],
            phone: ["ÈõªË©±", "ËÅØÁµ°ÈõªË©±", "ÊâãÊ©ü"],
            address: ["Ë©≥Á¥∞Âú∞ÂùÄ", "ÈÖçÈÄÅÂú∞ÂùÄ", "ÈÄÅË≤®Âú∞ÂùÄ", "Âú∞ÂùÄ"],
            date: ["ÈÄÅË≤®Êó•Êúü", "ÂèñË≤®/ÈÄÅË≤®Êó•Êúü", "ÂèñË≤®Êó•Êúü", "ÈÖçÈÄÅÊó•Êúü", "Êó•Êúü"],
            time: ["ÈÄÅË≤®ÊôÇÊÆµ", "ÊôÇÈñì", "ÈÖçÈÄÅÊôÇÈñì", "ÈÄÅË≤®ÊôÇÈñì"],
            period: ["ÊôÇÊÆµ", "ÈÖçÈÄÅÊôÇÊÆµ"],
            uid: ["LINE UID", "UID"],
            status: ["ÂêåÊ≠•ÁãÄÊÖã"],
            note: ["ÂÇôË®ªÊ¨Ñ", "ÂÇôË®ª", "Ë®ÇÂñÆÂÇôË®ª"]
        };

        const PERIOD_TAGS = ["‰∏çÊåáÂÆö", "13:00 Ââç", "14:00-18:00"];
        
        const STUDIO_PICKUP = {
            "ÊùøÊ©ãÂ∑•‰ΩúÂÆ§": "ÊùøÊ©ãÂ∑•‰ΩúÂÆ§Ëá™Âèñ",
            "Âè∞‰∏≠Â∑•‰ΩúÂÆ§": "Âè∞‰∏≠Â∑•‰ΩúÂÆ§Ëá™Âèñ"
        };

        const App = () => {
            const [state, setState] = useState({
                allOrders: [],
                selectedOrder: null,
                isEditing: false,
                headerMap: {},
                editCache: {}
            });
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [toast, setToast] = useState(null);

            const notify = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const fetchOrders = async () => {
                const icon = document.getElementById('syncIcon');
                if (icon) icon.classList.add('spin');
                try {
                    const res = await fetch(`${API_URL}?action=getOrders&t=${Date.now()}`);
                    const data = await res.json();
                    setState(prev => {
                        let newSelected = prev.selectedOrder;
                        if (newSelected) {
                            const currentId = getCleanVal(newSelected, 'id');
                            newSelected = data.find(o => getCleanVal(o, 'id') === currentId) || null;
                        }
                        return { ...prev, allOrders: data, selectedOrder: newSelected };
                    });
                } catch (e) { notify("ÈÄ£Á∑öË∂ÖÊôÇÔºåË´ãÊ™¢Êü• GAS ÈÉ®ÁΩ≤"); }
                finally { if (icon) setTimeout(() => icon.classList.remove('spin'), 500); }
            };

            useEffect(() => { fetchOrders(); }, []);

            const getRealKey = (order, field) => {
                if (!order) return null;
                const keys = Object.keys(order);
                const targets = FIELD_DEFINITIONS[field];
                return keys.find(k => targets.some(t => k.trim() === t)) || keys.find(k => targets.some(t => k.includes(t)));
            };

            const getCleanVal = (order, field) => {
                if (!order) return "";
                const key = getRealKey(order, field);
                let val = order[key] || "";
                if (field === 'date' && val) {
                    const d = new Date(val);
                    if (isNaN(d.getTime())) return String(val).trim();
                    if (String(val).includes('T')) d.setHours(d.getHours() + 8);
                    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
                }
                if (field === 'time' || field === 'period') {
                    const tKey = getRealKey(order, 'time');
                    const pKey = getRealKey(order, 'period');
                    let tVal = String(order[tKey] || "").trim();
                    let pVal = String(order[pHeader] || "").trim();
                    if (tVal.includes("1899")) {
                        const d = new Date(tVal);
                        tVal = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    }
                    const isP = ["Ââç", "Âæå", "‰∏äÂçà", "‰∏ãÂçà", "-", "~"].some(k => tVal.includes(k));
                    if (isP && !pVal) return field === 'period' ? tVal : "";
                    return field === 'time' ? tVal : pVal;
                }
                return String(val).trim();
            };

            const selectOrder = (id) => {
                const order = state.allOrders.find(o => getCleanVal(o, 'id') === id);
                if (order) {
                    const hMap = {};
                    Object.keys(FIELD_DEFINITIONS).forEach(f => { hMap[f] = getRealKey(order, f); });
                    setState(prev => ({ ...prev, selectedOrder: order, isEditing: false, headerMap: hMap }));
                }
            };

            const startEdit = () => {
                const cache = {};
                Object.keys(FIELD_DEFINITIONS).forEach(f => { cache[f] = getCleanVal(state.selectedOrder, f); });
                setState(prev => ({ ...prev, isEditing: true, editCache: cache }));
            };

            const updateCache = (field, val) => {
                setState(prev => ({
                    ...prev,
                    editCache: { ...prev.editCache, [field]: val }
                }));
            };

            const saveEdit = async () => {
                setLoading(true);
                notify("Ê≠£Âú®‰∏äÂÇ≥‰øÆÊîπ...");

                const payload = {};
                Object.keys(state.editCache).forEach(f => {
                    const header = state.headerMap[f];
                    if (header) {
                        let v = state.editCache[f];
                        if (f === 'date' && v) v = v.replace(/-/g, '/');
                        if (f === 'phone' && v) v = "'" + String(v).replace(/^'/, "");
                        payload[header] = v;
                    }
                });

                // Âº∑Âà∂Ëß∏ÁôºÂêåÊ≠•
                const syncHeader = state.headerMap['status'] || "ÂêåÊ≠•ÁãÄÊÖã";
                payload[syncHeader] = "Á≠âÂæÖÂêåÊ≠•";

                try {
                    const orderId = getCleanVal(state.selectedOrder, 'id').replace('#', '').trim();
                    // ‰ΩøÁî® fetch ÁôºÈÄÅË´ãÊ±Ç
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'updateOrder',
                            data: { ID_KEY: orderId, payload: payload }
                        })
                    });
                    
                    notify("ÂÑ≤Â≠òÊàêÂäüÔºåÂêåÊ≠•‰∏≠...");
                    setTimeout(() => {
                        setState(prev => ({ ...prev, isEditing: false }));
                        fetchOrders();
                        setLoading(false);
                    }, 1500);
                } catch (e) {
                    notify("ÂÑ≤Â≠òÂ§±Êïó");
                    setLoading(false);
                }
            };

            const filteredOrders = useMemo(() => {
                return state.allOrders.filter(o => {
                    const id = getCleanVal(o, 'id').toLowerCase();
                    const name = getCleanVal(o, 'name').toLowerCase();
                    return id.includes(searchTerm.toLowerCase()) || name.includes(searchTerm.toLowerCase());
                }).sort((a,b) => String(getCleanVal(a,'id')).localeCompare(String(getCleanVal(b,'id')), undefined, {numeric: true}));
            }, [state.allOrders, searchTerm]);

            return (
                <div className="h-screen flex flex-col overflow-hidden">
                    <header className="h-16 bg-[#0f172a] text-white flex items-center justify-between px-6 shadow-lg z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" strokeWidth="3"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                            </div>
                            <span className="font-black tracking-tighter uppercase italic">Official website <span className="text-blue-400">Calendar Admin</span></span>
                        </div>
                        <button onClick={fetchOrders} className="p-2.5 bg-slate-800 rounded-xl hover:bg-slate-700 transition-all border border-slate-700 active:scale-95">
                            <svg id="syncIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
                        </button>
                    </header>

                    <div className="flex-1 flex overflow-hidden relative">
                        {/* ÂàóË°®ÂçÄ */}
                        <aside className={`w-full md:w-80 border-r bg-white flex flex-col z-30 transition-all ${state.selectedOrder ? 'hidden md:flex' : 'flex'}`}>
                            <div className="p-4 border-b">
                                <input type="text" placeholder="ÊêúÂ∞ãÁ∑®ËôüÊàñÂßìÂêç..." className="w-full px-4 py-2.5 bg-slate-100 rounded-xl outline-none focus:ring-2 ring-blue-500/20 text-sm font-bold" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                            <div className="flex-1 overflow-y-auto no-scrollbar text-xs">
                                {filteredOrders.map(o => {
                                    const id = getCleanVal(o, 'id');
                                    const isSelected = state.selectedOrder && getCleanVal(state.selectedOrder, 'id') === id;
                                    return (
                                        <div key={id} onClick={() => selectOrder(id)} className={`p-5 border-b cursor-pointer hover:bg-slate-50 transition-all ${isSelected ? 'active-card' : 'bg-white'}`}>
                                            <div className="flex justify-between mb-1 font-mono font-black text-slate-400">
                                                <span>#{id}</span>
                                                <span>{getCleanVal(o, 'date')}</span>
                                            </div>
                                            <div className="text-sm font-bold text-slate-800">{getCleanVal(o, 'name')}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </aside>

                        {/* Ë©≥ÊÉÖÂçÄ */}
                        <main className={`flex-1 bg-slate-50 flex flex-col overflow-y-auto z-40 ${state.selectedOrder ? 'flex' : 'hidden md:flex'}`}>
                            {state.selectedOrder ? (
                                <div className="p-6 md:p-10 space-y-8 max-w-5xl w-full mx-auto">
                                    <div className="flex flex-col lg:flex-row justify-between gap-6 pb-6 border-b">
                                        <div>
                                            <h2 className="text-5xl font-black tracking-tighter italic text-[#0f172a]">#{getCleanVal(state.selectedOrder, 'id')}</h2>
                                            <p className="text-[10px] font-black text-slate-400 mt-2 uppercase tracking-widest italic">{getCleanVal(state.selectedOrder, 'address').includes('Ëá™Âèñ') ? 'üè¨ Â∑•‰ΩúÂÆ§Ëá™Âèñ' : 'üöö ‰∏ÄËà¨ÈÖçÈÄÅ'}</p>
                                        </div>
                                        <div className="flex gap-3 text-xs">
                                            {state.isEditing ? (
                                                <>
                                                    <button onClick={saveEdit} disabled={loading} className="flex-1 lg:flex-none px-10 py-3 bg-blue-600 text-white rounded-2xl font-black tracking-widest shadow-xl active:scale-95 transition-all disabled:opacity-50 uppercase">Confirm Save</button>
                                                    <button onClick={() => setState(prev => ({...prev, isEditing: false}))} className="px-6 py-3 bg-white border rounded-2xl font-black text-slate-400 active:scale-95 transition-all uppercase">Cancel</button>
                                                </>
                                            ) : (
                                                <button onClick={startEdit} className="flex-1 lg:flex-none px-10 py-3 bg-[#0f172a] text-white rounded-2xl font-black tracking-widest shadow-2xl active:scale-95 transition-all uppercase">Edit Order</button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 space-y-8 shadow-sm text-xs">
                                            <h3 className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Contact</h3>
                                            <div className="space-y-4">
                                                <span className="text-[10px] font-black text-slate-400 uppercase">ÂßìÂêç</span>
                                                {state.isEditing ? <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-500 outline-none" value={state.editCache.name} onChange={e => updateCache('name', e.target.value)} /> : <p className="font-bold text-slate-800 text-sm">{getCleanVal(state.selectedOrder, 'name')}</p>}
                                                
                                                <span className="text-[10px] font-black text-slate-400 uppercase">ÈõªË©±</span>
                                                {state.isEditing ? <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-500 outline-none" value={state.editCache.phone} onChange={e => updateCache('phone', e.target.value)} /> : <p className="font-bold text-slate-800 text-sm">{getCleanVal(state.selectedOrder, 'phone')}</p>}
                                            </div>
                                        </div>

                                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 space-y-6 shadow-sm text-xs">
                                            <h3 className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Delivery Address</h3>
                                            {state.isEditing ? (
                                                <div className="space-y-4">
                                                    <div className="flex flex-wrap gap-2">
                                                        {Object.keys(STUDIO_PICKUP).map(k => (
                                                            <button key={k} onClick={() => updateCache('address', STUDIO_PICKUP[k])} className={`px-2 py-1.5 rounded-lg text-[9px] font-black border transition-all ${state.editCache.address === STUDIO_PICKUP[k] ? 'bg-blue-600 text-white' : 'bg-white text-slate-400 border-slate-100'}`}>{k}</button>
                                                        ))}
                                                    </div>
                                                    <textarea className="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-500 outline-none min-h-[100px]" value={state.editCache.address} onChange={e => updateCache('address', e.target.value)} />
                                                </div>
                                            ) : <p className="font-bold text-sm text-slate-600 leading-relaxed">{getCleanVal(state.selectedOrder, 'address')}</p>}
                                        </div>

                                        <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 space-y-6 shadow-sm text-xs">
                                            <h3 className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Schedule</h3>
                                            <div className="space-y-4">
                                                <span className="text-[10px] font-black text-slate-400 uppercase">Êó•Êúü</span>
                                                {state.isEditing ? <input type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-blue-500" value={(state.editCache.date || "").replace(/\//g, '-')} onChange={e => updateCache('date', e.target.value)} /> : <p className="font-bold text-slate-800 text-sm">{getCleanVal(state.selectedOrder, 'date')}</p>}
                                                
                                                <span className="text-[10px] font-black text-slate-400 uppercase">ÊôÇÈñì / ÊôÇÊÆµ</span>
                                                {state.isEditing ? (
                                                    <div className="space-y-2">
                                                        <div className="flex flex-wrap gap-2 mb-2">
                                                            {PERIOD_TAGS.map(t => <button key={t} onClick={() => updateCache('period', t)} className={`px-2 py-1.5 rounded-lg text-[9px] font-black border transition-all ${state.editCache.period === t ? 'bg-blue-600 text-white' : 'bg-white text-slate-400 border-slate-100'}`}>{t}</button>)}
                                                        </div>
                                                        <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-blue-500" value={state.editCache.time} onChange={e => updateCache('time', e.target.value)} />
                                                    </div>
                                                ) : <p className="font-bold text-slate-800 text-sm">{getCleanVal(state.selectedOrder, 'time')} / {getCleanVal(state.selectedOrder, 'period')}</p>}
                                            </div>
                                        </div>

                                        <div className="md:col-span-2 lg:col-span-3 bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-sm text-xs">
                                            <h3 className="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-4">Internal Note</h3>
                                            {state.isEditing ? <textarea className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none border-2 border-transparent focus:border-blue-500 min-h-[100px]" value={state.editCache.note} onChange={e => updateCache('note', e.target.value)} /> : <p className="font-bold text-slate-500 italic text-sm">{getCleanVal(state.selectedOrder, 'note') || "---"}</p>}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex-1 flex flex-col items-center justify-center text-slate-300">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" className="mb-4 opacity-20"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    <p className="font-black tracking-widest uppercase text-xs">Select an order</p>
                                </div>
                            )}
                        </main>
                    </div>

                    {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 bg-slate-900 text-white rounded-2xl shadow-2xl z-[100] font-black text-[10px] tracking-widest uppercase animate-bounce">{toast}</div>}
                    
                    {loading && <div className="fixed inset-0 bg-white/60 backdrop-blur-sm z-[100] flex items-center justify-center"><div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full spin"></div></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
