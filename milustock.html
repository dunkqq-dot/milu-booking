<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº‹é¹¿æ°£çƒ - æ•´åˆå‚™è²¨ç®¡ç†ç³»çµ± (è¨ºæ–·ç‰ˆ)</title>
    <!-- è¼‰å…¥æ ¸å¿ƒå¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .primary-gradient { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        .order-card { transition: all 0.2s ease-out; }
        .calendar-grid-container { min-height: 280px; }
        /* è¨ºæ–·é¢æ¿å‹•ç•« */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo, useRef } = React;

        const getLocalDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const CONFIG = {
            OFFICIAL: {
                id: "OFFICIAL",
                name: "å®˜ç¶²ç³»çµ±",
                url: "https://script.google.com/macros/s/AKfycbwhH5axa1J6Q9nThs0Z8SQ3O4aEUAsTg5p9aTa1Mdwe-iJAd1GbI8t2SS1KnF6MDCTqBQ/exec",
                statusField: "å‚™è²¨ç‹€æ…‹",
                params: "action=getOrders"
            },
            MILU: {
                id: "MILU",
                name: "MILUç³»çµ±",
                url: "https://script.google.com/macros/s/AKfycbyL1VarFpdQhPe24Fj9RQrGYoGunAcm1XNxlZwIW-kr_3CqG_hvQgWoS0xpCb9zb0vdjQ/exec",
                statusField: "æ’¿è²¨ç‹€æ…‹",
                params: "mode=api"
            }
        };

        const CATEGORIES = ["å…¨éƒ¨", "å°ˆäººä½ˆç½®", "æ°£çƒå¤–é€", "å·¥ä½œå®¤å–è²¨", "å¾Œè»Šå»‚ä½ˆç½®", "å®˜ç¶²è¨‚å–®"];

        const FIELD_MAPS = {
            id: ["è¨‚å–®ç·¨è™Ÿ", "ç·¨è™Ÿ", "OrderID"],
            name: ["æ”¶ä»¶äººå§“å", "æ”¶ä»¶äºº", "å®¢æˆ¶åç¨±", "å§“å"],
            address: ["è©³ç´°åœ°å€", "åœ°å€", "é€è²¨åœ°å€", "åœ°é»"],
            date: ["æ—¥æœŸ", "é€è²¨æ—¥æœŸ", "é ç´„æ—¥æœŸ", "å–è²¨/é€è²¨æ—¥æœŸ"],
            time: ["æ™‚é–“/æ™‚æ®µ", "æ™‚é–“", "é€è²¨æ™‚æ®µ", "é…é€æ™‚æ®µ", "é ç´„æ™‚é–“"],
            status: ["å‚™è²¨ç‹€æ…‹", "æ’¿è²¨ç‹€æ…‹", "å‚™è²¨"],
            payment: ["ä»˜æ¬¾ç‹€æ…‹", "ç‹€æ…‹", "ä»˜æ¬¾", "æ”¯ä»˜ç‹€æ…‹"],
            remark: ["å‚™è¨»", "å‚™è¨»æ¬„", "æ³¨æ„äº‹é …"],
            itemType: ["å“é …é¡å‹", "å“é …"],
        };

        const LucideIcon = memo(({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        });

        // è¨ºæ–·é¢æ¿å…ƒä»¶
        const DiagnosticPanel = ({ status, onClose }) => {
            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 fade-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-black text-slate-800 text-lg flex items-center gap-2">
                                <LucideIcon name="activity" className="text-blue-500" /> ç³»çµ±é€£ç·šè¨ºæ–·
                            </h3>
                            <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                                <LucideIcon name="x" size={16} />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            {[CONFIG.OFFICIAL, CONFIG.MILU].map(conf => {
                                const s = status[conf.id];
                                return (
                                    <div key={conf.id} className={`p-4 rounded-xl border-l-4 ${s.ok ? 'bg-emerald-50 border-emerald-500' : 'bg-red-50 border-red-500'}`}>
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="font-bold text-slate-700">{conf.name}</span>
                                            {s.ok ? 
                                                <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">é€£ç·šæˆåŠŸ</span> : 
                                                <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold">é€£ç·šå¤±æ•—</span>
                                            }
                                        </div>
                                        <div className="text-xs text-slate-500 space-y-1">
                                            <p>ğŸ“¦ è³‡æ–™ç­†æ•¸: <span className="font-mono font-bold">{s.count}</span> ç­†</p>
                                            <p>ğŸ“¡ ç‹€æ…‹è¨Šæ¯: {s.msg}</p>
                                            {s.sampleDate && (
                                                <p className="mt-2 pt-2 border-t border-slate-200/50 text-[10px] text-slate-400">
                                                    ğŸ” æ—¥æœŸæ¨£æœ¬: <span className="font-mono bg-white px-1 rounded">{String(s.sampleDate)}</span>
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="mt-6 text-center">
                            <p className="text-[10px] text-slate-400">
                                è‹¥é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¢ºèª Google Apps Script éƒ¨ç½²ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const OrderCard = memo(({ order, config, findVal, handleUpdate, isSyncing }) => {
            const status = findVal(order, 'status');
            const iType = findVal(order, 'itemType');
            const rawId = findVal(order, 'id');
            const displayId = String(rawId).startsWith('#') ? rawId : `#${rawId}`;

            return (
                <div className={`order-card bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-6 md:p-7 relative ${isSyncing ? 'opacity-70' : ''}`}>
                    {isSyncing && (
                        <div className="absolute top-4 right-8 flex items-center gap-1 text-[9px] font-bold text-emerald-600 animate-pulse">
                            <LucideIcon name="cloud-upload" size={12} /> åŒæ­¥ä¸­...
                        </div>
                    )}
                    <div className="flex justify-between items-start mb-5 gap-4">
                        <div className="flex-1 min-w-0 space-y-1.5">
                            <div className="flex gap-2 flex-wrap">
                                <span className={`text-[9px] font-black px-2 py-0.5 rounded border shrink-0 ${order._src === "OFFICIAL" ? "bg-blue-50 text-blue-600 border-blue-100" : "bg-emerald-50 text-emerald-600 border-emerald-100"}`}>
                                    {config[order._src].name}
                                </span>
                                <span className="text-[9px] font-black bg-slate-100 text-slate-400 px-2 py-0.5 rounded uppercase truncate max-w-[100px]">{order["__sheet__"]}</span>
                                {iType && iType !== "-" && <span className="text-[9px] font-black bg-amber-50 text-amber-600 px-2 py-0.5 rounded border border-amber-100 shrink-0">âœ¨ {iType}</span>}
                            </div>
                            <h4 className="font-black text-xl md:text-2xl text-slate-800 break-words leading-tight">{findVal(order, 'name')}</h4>
                            <p className="text-[10px] font-bold text-slate-300 tracking-wider truncate">{displayId}</p>
                        </div>
                        <div className={`text-[10px] font-black px-3 py-1.5 rounded-full shadow-sm transition-colors duration-200 shrink-0 whitespace-nowrap mt-1 ${
                            status.includes("æª¢æŸ¥") ? "bg-emerald-500 text-white" : status.includes("å·²å‚™") ? "bg-amber-400 text-white" : "bg-red-600 text-white"
                        }`}>{status || "æœªæ’¿å–"}</div>
                    </div>

                    <div className="space-y-3 mb-6">
                        <div className="flex items-center gap-3 text-slate-700 font-black bg-slate-50 p-3 rounded-2xl w-fit border border-slate-100">
                            <LucideIcon name="clock" className="text-emerald-500" />
                            <span className="whitespace-nowrap">{findVal(order, 'time')}</span>
                        </div>
                        <div className="flex items-start gap-3 px-1">
                            <LucideIcon name="map-pin" className="shrink-0 mt-0.5 text-slate-300" />
                            <span className="text-sm text-slate-500 font-bold leading-relaxed break-words">{findVal(order, 'address')}</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                        {["æœªæ’¿å–", "å·²å‚™è²¨", "æª¢æŸ¥å®Œç•¢"].map((st) => (
                            <button key={st} disabled={isSyncing} onClick={() => handleUpdate(order, st)} 
                                className={`status-btn py-3 md:py-4 rounded-2xl text-[10px] md:text-[11px] font-black border transition-all active:scale-95 ${
                                    status === st || (!status && st === "æœªæ’¿å–") ? 'bg-slate-800 text-white shadow-xl' : 'bg-white text-slate-400 border-slate-100 hover:bg-slate-50'
                                }`}>{st}</button>
                        ))}
                    </div>
                </div>
            );
        });

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(getLocalDateString(new Date()));
            const [currentCategory, setCurrentCategory] = useState("å…¨éƒ¨");
            const [toast, setToast] = useState(null);
            const [showDiagnostic, setShowDiagnostic] = useState(false);
            
            // ç³»çµ±é€£ç·šç‹€æ…‹
            const [sysStatus, setSysStatus] = useState({
                OFFICIAL: { ok: false, count: 0, msg: "ç­‰å¾…é€£ç·š...", sampleDate: "" },
                MILU: { ok: false, count: 0, msg: "ç­‰å¾…é€£ç·š...", sampleDate: "" }
            });

            const [syncingIds, setSyncingIds] = useState(new Set());
            const lastUpdateRef = useRef({});

            const findVal = useCallback((order, type) => {
                if (!order) return "";
                const keys = Object.keys(order);
                const targets = FIELD_MAPS[type] || [];
                const cleanKeys = keys.filter(k => !k.includes("æˆ³è¨˜") && !k.toLowerCase().includes("timestamp"));
                
                let actualKey = targets.reduce((found, t) => found || cleanKeys.find(k => k.trim() === t), null) || 
                                targets.reduce((found, t) => found || cleanKeys.find(k => k.includes(t)), null);
                
                let val = actualKey ? order[actualKey] : "";

                if (type === 'date' && val) {
                    const strVal = String(val).trim();
                    if (strVal.includes('T')) {
                        const d = new Date(strVal);
                        if (!isNaN(d.getTime())) return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
                    }
                    const match = strVal.match(/(\d{4})[\-\/\.](\d{1,2})[\-\/\.](\d{1,2})/);
                    if (match) return `${match[1]}/${match[2].padStart(2, '0')}/${match[3].padStart(2, '0')}`;
                    const d = new Date(val);
                    if (!isNaN(d.getTime())) return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
                }

                if (type === 'time' && val) {
                    try {
                        const d = new Date(val);
                        if (!isNaN(d.getTime())) {
                            if (order._src === "MILU") { d.setMinutes(d.getMinutes() - 38); }
                            const hh = d.getHours(), mm = d.getMinutes();
                            return `${hh >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ'} ${hh % 12 || 12}:${String(mm).padStart(2, '0')}`;
                        }
                    } catch(e) {}
                    return String(val);
                }
                return String(val || "").trim();
            }, []);

            // ç¨ç«‹çš„ Fetch å‡½å¼ï¼Œç”¨æ–¼å–®ç¨è¿½è¹¤æ¯å€‹ä¾†æºçš„ç‹€æ…‹
            const fetchSource = async (config) => {
                try {
                    const res = await fetch(`${config.url}?${config.params}&t=${Date.now()}`);
                    const text = await res.text();
                    
                    if (!text || text.includes("ç³»çµ±é‹ä½œä¸­")) {
                        throw new Error("å›å‚³è³‡æ–™ç‚ºç©ºæˆ–ç³»çµ±é‹ä½œä¸­");
                    }

                    let parsedData = [];
                    try {
                        const json = JSON.parse(text);
                        if (!Array.isArray(json)) throw new Error("éé™£åˆ—æ ¼å¼");
                        
                        // é‡å°ä¸åŒä¾†æºåšé è™•ç†
                        if (config.id === "MILU") {
                            parsedData = json.filter(row => Array.isArray(row) && row.length > 5).map(row => ({
                                "è¨‚å–®ç·¨è™Ÿ": row[0], "å®¢æˆ¶åç¨±": row[3], "æ—¥æœŸ": row[5], "æ™‚é–“/æ™‚æ®µ": row[6],
                                "åœ°é»": row[7], "ç‹€æ…‹": row[10], "æ’¿è²¨ç‹€æ…‹": row[21], "_src": "MILU", "_apiUrl": config.url, "__sheet__": row[row.length - 1] 
                            }));
                        } else {
                            parsedData = json.map(o => ({ ...o, _src: "OFFICIAL", _apiUrl: config.url, "__sheet__": "å®˜ç¶²è¨‚å–®" }));
                        }
                    } catch (parseError) {
                        throw new Error("JSON è§£æå¤±æ•—: " + parseError.message);
                    }

                    // æ›´æ–°è©²ä¾†æºçš„ç‹€æ…‹ç‚ºæˆåŠŸ
                    const sample = parsedData.length > 0 ? (config.id === "MILU" ? parsedData[0]["æ—¥æœŸ"] : parsedData[0]["é€è²¨æ—¥æœŸ"] || parsedData[0]["æ—¥æœŸ"]) : "ç„¡è³‡æ–™";
                    setSysStatus(prev => ({
                        ...prev,
                        [config.id]: { ok: true, count: parsedData.length, msg: "æ­£å¸¸", sampleDate: String(sample) }
                    }));

                    return parsedData;

                } catch (e) {
                    // æ›´æ–°è©²ä¾†æºçš„ç‹€æ…‹ç‚ºå¤±æ•—
                    setSysStatus(prev => ({
                        ...prev,
                        [config.id]: { ok: false, count: 0, msg: e.message, sampleDate: "-" }
                    }));
                    return [];
                }
            };

            const fetchAllData = useCallback(async (silent = false) => {
                if (!silent) setLoading(true);
                
                // å¹³è¡ŒåŸ·è¡Œå…©å€‹è«‹æ±‚
                const [officialData, miluData] = await Promise.all([
                    fetchSource(CONFIG.OFFICIAL),
                    fetchSource(CONFIG.MILU)
                ]);

                const combined = [...officialData, ...miluData];

                setOrders(prevOrders => {
                    return combined.map(newItem => {
                        const key = newItem._src + (newItem["è¨‚å–®ç·¨è™Ÿ"] || newItem["__row__"]);
                        const lastUpdate = lastUpdateRef.current[key];
                        if (lastUpdate && (Date.now() - lastUpdate < 10000)) {
                            const localItem = prevOrders.find(o => (o._src + (o["è¨‚å–®ç·¨è™Ÿ"] || o["__row__"])) === key);
                            return localItem || newItem;
                        }
                        return newItem;
                    });
                });
                
                setLoading(false);
            }, []);

            useEffect(() => {
                fetchAllData();
                const timer = setInterval(() => fetchAllData(true), 30000); 
                return () => clearInterval(timer);
            }, [fetchAllData]);

            const showToast = (text) => { setToast(text); setTimeout(() => setToast(null), 3000); };

            const handleUpdate = useCallback(async (order, newStatus) => {
                const key = order._src + (order["è¨‚å–®ç·¨è™Ÿ"] || order["__row__"]);
                lastUpdateRef.current[key] = Date.now();
                setSyncingIds(prev => new Set(prev).add(key));
                setOrders(prev => prev.map(o => {
                    if ((o._src + (o["è¨‚å–®ç·¨è™Ÿ"] || o["__row__"])) === key) {
                        return o._src === "MILU" ? { ...o, "æ’¿è²¨ç‹€æ…‹": newStatus } : { ...o, [CONFIG.OFFICIAL.statusField]: newStatus };
                    }
                    return o;
                }));

                try {
                    const isMilu = order._src === "MILU";
                    const payload = isMilu ? {
                        action: "UPDATE_ORDER", orderId: order["è¨‚å–®ç·¨è™Ÿ"], service: order["__sheet__"], pickingStatus: newStatus
                    } : {
                        action: "updateStatus", row: order["__row__"], status: newStatus, columnName: CONFIG.OFFICIAL.statusField
                    };

                    await fetch(order._apiUrl, { method: "POST", body: JSON.stringify(payload) });
                    showToast(`æ›´æ–°æˆåŠŸï¼š${newStatus}`);
                    setTimeout(() => fetchAllData(true), 1500);
                } catch (e) { 
                    showToast("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); 
                    delete lastUpdateRef.current[key];
                } finally {
                    setSyncingIds(prev => {
                        const next = new Set(prev);
                        next.delete(key);
                        return next;
                    });
                }
            }, [fetchAllData]);

            const dayStatusMap = useMemo(() => {
                const stats = {};
                const exclude = ["æœªä»˜æ¬¾", "UNPAID", "å·²å–æ¶ˆ", "CANCELED"];
                orders.forEach(o => {
                    const payStatus = (findVal(o, 'payment') || "").toUpperCase();
                    if (exclude.some(k => payStatus.includes(k))) return;

                    const dateStr = findVal(o, 'date');
                    if (!dateStr) return;
                    const dateKey = dateStr.replace(/\//g, '-');
                    
                    if (!stats[dateKey]) stats[dateKey] = { hasOrders: true, hasUnpicked: false, hasPending: false };
                    
                    const status = o._src === "MILU" ? o["æ’¿è²¨ç‹€æ…‹"] : o[CONFIG.OFFICIAL.statusField];
                    if (status !== "æª¢æŸ¥å®Œç•¢") {
                        if (!status || status === "æœªæ’¿å–") stats[dateKey].hasUnpicked = true;
                        else if (status === "å·²å‚™è²¨") stats[dateKey].hasPending = true;
                    }
                });
                return stats;
            }, [orders, findVal]);

            const filteredOrders = useMemo(() => {
                const exclude = ["æœªä»˜æ¬¾", "UNPAID", "å·²å–æ¶ˆ", "CANCELED"];
                return orders.filter(o => {
                    const payStatus = (findVal(o, 'payment') || "").toUpperCase();
                    if (exclude.some(k => payStatus.includes(k))) return false;
                    if (currentCategory !== "å…¨éƒ¨" && o["__sheet__"] !== currentCategory) return false;
                    
                    const orderDate = findVal(o, 'date').replace(/\//g, '-');
                    return orderDate === selectedDate;
                }).sort((a, b) => {
                    const tA = findVal(a, 'time') || "";
                    const tB = findVal(b, 'time') || "";
                    return tA.localeCompare(tB);
                });
            }, [orders, selectedDate, currentCategory, findVal]);

            const daysArray = useMemo(() => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const firstDayDate = new Date(year, month, 1, 12, 0, 0);
                const startDayOfWeek = firstDayDate.getDay(); 
                const totalDays = new Date(year, month + 1, 0).getDate();
                
                return Array.from({ length: 42 }, (_, i) => {
                    const dayNum = i - startDayOfWeek + 1;
                    if (dayNum > 0 && dayNum <= totalDays) {
                        return getLocalDateString(new Date(year, month, dayNum, 12, 0, 0));
                    }
                    return null;
                });
            }, [currentMonth]);

            const hasError = !sysStatus.OFFICIAL.ok || !sysStatus.MILU.ok;

            return (
                <div className="min-h-screen pb-20 overflow-x-hidden">
                    <header className="primary-gradient text-white p-4 sticky top-0 z-40 flex justify-between items-center shadow-lg">
                        <div className="flex items-center gap-3">
                            <LucideIcon name="package" size={22} />
                            <h1 className="text-lg md:text-xl font-black tracking-tight">éº‹é¹¿æ°£çƒ Â· æ•´åˆç®¡ç†</h1>
                        </div>
                        <div className="flex gap-2">
                             {/* è¨ºæ–·æŒ‰éˆ• */}
                            <button onClick={() => setShowDiagnostic(true)} 
                                className={`p-2 rounded-full transition-all ${hasError ? 'bg-red-500 animate-pulse' : 'hover:bg-white/20'}`}>
                                <LucideIcon name="activity" size={20} className={hasError ? "text-white" : ""} />
                            </button>
                            <button onClick={() => fetchAllData()} className="p-2 hover:bg-white/20 rounded-full transition-all">
                                <LucideIcon name="refresh-cw" size={20} className={loading ? "spin" : ""} />
                            </button>
                        </div>
                    </header>

                    <div className="bg-white/80 backdrop-blur-md border-b sticky top-[60px] z-30 overflow-x-auto no-scrollbar">
                        <div className="flex gap-2 max-w-6xl mx-auto p-3 px-4">
                            {CATEGORIES.map(cat => (
                                <button key={cat} onClick={() => setCurrentCategory(cat)}
                                    className={`px-5 py-2 rounded-full text-xs font-black whitespace-nowrap transition-all border ${
                                        currentCategory === cat ? 'bg-emerald-800 text-white border-emerald-800 shadow-md' : 'bg-slate-50 text-slate-400 border-slate-100'
                                    }`}>
                                    {cat}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="max-w-6xl mx-auto p-4 lg:flex gap-8 mt-4">
                        {/* å·¦å´æ—¥æ›† */}
                        <div className="lg:w-[340px] shrink-0 mb-6">
                            <div className="bg-white rounded-[2.5rem] shadow-sm border p-6 lg:sticky lg:top-[150px]">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="font-black text-slate-700 text-lg">{currentMonth.getFullYear()} / {currentMonth.getMonth() + 1}</h2>
                                    <div className="flex gap-1">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-2 hover:bg-slate-50 rounded-xl"><LucideIcon name="chevron-left" /></button>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-2 hover:bg-slate-50 rounded-xl"><LucideIcon name="chevron-right" /></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center calendar-grid-container">
                                    {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d} className="text-[10px] font-black text-slate-300 py-2 uppercase">{d}</div>)}
                                    {daysArray.map((d, i) => {
                                        const s = dayStatusMap[d];
                                        const dayLabel = d ? parseInt(d.split('-')[2]) : "";
                                        return (
                                            <div key={i} onClick={() => d && setSelectedDate(d)}
                                                className={`h-11 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-sm font-bold transition-all relative ${
                                                    !d ? 'invisible' : d === selectedDate ? 'bg-emerald-800 text-white shadow-lg scale-105 z-10' : 'hover:bg-slate-50 text-slate-600'
                                                }`}>
                                                <span>{dayLabel}</span>
                                                {s && (
                                                    <div className="flex gap-0.5 absolute bottom-1.5">
                                                        {s.hasOrders && <div className={`w-1 h-1 rounded-full ${d === selectedDate ? 'bg-white' : 'bg-emerald-500'}`}></div>}
                                                        {s.hasPending && <div className={`w-1 h-1 rounded-full ${d === selectedDate ? 'bg-amber-200' : 'bg-amber-400'}`}></div>}
                                                        {s.hasUnpicked && <div className={`w-1 h-1 rounded-full animate-pulse ${d === selectedDate ? 'bg-red-200' : 'bg-red-600'}`}></div>}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="mt-6 pt-4 border-t border-slate-50 text-[10px] text-slate-400 font-bold flex flex-col gap-2 px-1">
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span>ğŸŸ¢ ç•¶æ—¥æœ‰é è¨‚è¨‚å–®</span></div>
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-amber-400"></div><span>ğŸŸ¡ å°šæœ‰ã€Œè£½ä½œä¸­ã€è¨‚å–®</span></div>
                                    <div className="flex items-center gap-2"><div className="w-1.5 h-1.5 rounded-full bg-red-600 animate-pulse"></div><span>ğŸ”´ å°šæœ‰ã€Œæœªæ’¿å–ã€è¨‚å–®</span></div>
                                </div>
                            </div>
                        </div>

                        {/* å³å´åˆ—è¡¨ */}
                        <div className="flex-1 space-y-4">
                            <h3 className="font-black text-slate-600 flex items-center gap-2 px-2">
                                <LucideIcon name="list-checks" size={18} className="text-emerald-600" /> {selectedDate} æ’ç¨‹ ({filteredOrders.length})
                            </h3>
                            {filteredOrders.length === 0 ? (
                                <div className="py-24 text-center bg-white rounded-[3rem] border-2 border-dashed border-slate-100 text-slate-300 font-black italic">
                                    ç•¶æ—¥å°šç„¡å¾…è¾¦äº‹é …
                                </div>
                            ) : (
                                filteredOrders.map((o) => (
                                    <OrderCard 
                                        key={o._src + (o["è¨‚å–®ç·¨è™Ÿ"] || o["__row__"])} 
                                        order={o} config={CONFIG} findVal={findVal} handleUpdate={handleUpdate} 
                                        isSyncing={syncingIds.has(o._src + (o["è¨‚å–®ç·¨è™Ÿ"] || o["__row__"]))}
                                    />
                                ))
                            )}
                        </div>
                    </main>

                    {showDiagnostic && <DiagnosticPanel status={sysStatus} onClose={() => setShowDiagnostic(false)} />}

                    {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 px-10 py-4 rounded-full shadow-2xl z-[300] bg-slate-900 text-white text-sm font-black animate-bounce whitespace-nowrap">{toast}</div>}
                    {loading && (
                        <div className="fixed inset-0 bg-white/40 backdrop-blur-md flex flex-col items-center justify-center z-[500]">
                            <div className="w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

