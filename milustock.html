/**
 * ğŸˆ MILU è‡ªå‹•åŒ–æ ¸å¿ƒè…³æœ¬ (Web API å…¨å‹•æ…‹æ¬„ä½ç‰ˆ)
 * ä¿®æ­£ï¼š1. åƒ…æŠ“å–å·²ä»˜æ¬¾è³‡æ–™ 2. æ”¯æ´ã€Œæœªå‚™è²¨ã€å·²å‚™è²¨ã€ç‹€æ…‹
 */

const CALENDAR_NAME = 'éº‹é¹¿æ°£çƒé ç´„ç™»è¨˜'; 
const SHEET_NAMES = ['å°ˆäººä½ˆç½®', 'å¾Œè»Šå»‚ä½ˆç½®', 'å·¥ä½œå®¤å–è²¨', 'æ°£çƒå¤–é€']; 
const COL_EVENT_ID_NAME = 'è¡Œäº‹æ›†ID'; 
const COL_EVENT_ID_IDX = 26; // Z æ¬„
const MAKE_LINE_WEBHOOK_URL = 'https://hook.eu1.make.com/63u0kheb71v9vengzdggfy1ga7r8gmng'; 

function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸˆ MILU åŠŸèƒ½')
    .addItem('ç«‹åˆ»åŒæ­¥è¡Œäº‹æ›†', 'autoSyncFiveMinutes')
    .addItem('è¨­å®šè‡ªå‹•åŒ–è§¸ç™¼å™¨', 'setupAllTriggers')
    .addToUi();
}

function setupAllTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => ScriptApp.deleteTrigger(t));
  ScriptApp.newTrigger('autoSyncFiveMinutes').timeBased().everyMinutes(5).create();
  ScriptApp.newTrigger('onFormSubmitHandler').forSpreadsheet(SpreadsheetApp.getActive()).onFormSubmit().create();
  SpreadsheetApp.getUi().alert("âœ… è§¸ç™¼å™¨è¨­å®šå®Œæˆï¼");
}

// --- é›»è©±è‡ªå‹•ä¿®æ­£ ---
function onFormSubmitHandler(e) {
  try {
    const range = e.range;
    const sheet = range.getSheet();
    const row = range.getRow();
    const data = sheet.getDataRange().getDisplayValues()[0];
    const phoneCol = data.indexOf("é›»è©±") + 1 || 5; 
    
    const phoneValue = String(sheet.getRange(row, phoneCol).getValue());
    if (phoneValue.length === 9 && phoneValue.startsWith('9')) {
      sheet.getRange(row, phoneCol).setValue("'0" + phoneValue);
    } else if (!phoneValue.startsWith("'")) {
      sheet.getRange(row, phoneCol).setValue("'" + phoneValue);
    }
  } catch (err) { console.log("ä¿®æ­£é›»è©±å¤±æ•—: " + err.toString()); }
}

// --- æ—¥æ›†åŒæ­¥æ ¸å¿ƒ ---
function autoSyncFiveMinutes() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  SHEET_NAMES.forEach(sheetName => {
    const sheet = ss.getSheetByName(sheetName.trim());
    if (!sheet) return;
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return;
    
    const displayData = sheet.getDataRange().getDisplayValues();
    const headers = displayData[0];
    
    // å‹•æ…‹æ‰¾å°‹é—œéµåˆ—ç´¢å¼• (0-based)
    const idx = {
      oid: headers.indexOf("è¨‚å–®ç·¨è™Ÿ"),
      line: headers.indexOf("LINEåç¨±"),
      client: headers.indexOf("æ”¶ä»¶äººå§“å"),
      phone: headers.indexOf("é›»è©±"),
      date: headers.indexOf("é€è²¨æ—¥æœŸ"),
      time: headers.indexOf("é€è²¨æ™‚æ®µ"),
      loc: headers.indexOf("é€è²¨åœ°å€"),
      status: headers.indexOf("ç‹€æ…‹") !== -1 ? headers.indexOf("ç‹€æ…‹") : headers.indexOf("ä»˜æ¬¾ç‹€æ…‹"),
      venue: headers.indexOf("æˆ¿å‹/å ´åœ°"),
      price: headers.indexOf("ç¸½é‡‘é¡"),
      rec: headers.indexOf("å·²æ”¶é‡‘é¡"),
      bal: headers.indexOf("å‰©é¤˜å°¾æ¬¾")
    };

    displayData.slice(1).forEach((row, index) => {
      const rowNum = index + 2;
      const status = row[idx.status] || "";
      const eventId = row[COL_EVENT_ID_IDX - 1]; 
      
      // åªè¦ä¸æ˜¯æœªä»˜æ¬¾ä¸”ä¸æ˜¯ç©ºç™½ï¼Œå°±è¦–ç‚ºæœ‰æ•ˆè¨‚å–®
      const isPaid = (status !== "" && !status.includes('æœªä»˜æ¬¾') && !status.toUpperCase().includes('UNPAID')) || 
                     status.includes('å·²ä»˜æ¬¾') || status.includes('å·²å‚™è²¨') || status.includes('æœªå‚™è²¨') || status.includes('æª¢æŸ¥å®Œç•¢');
      const isCanceled = status.includes('å–æ¶ˆ') || status.includes('CANCELED');

      if (isPaid || (isCanceled && eventId !== '')) {
        const params = {
          service: sheetName,
          orderId: row[idx.oid],
          lineName: row[idx.line],
          clientName: row[idx.client],
          phone: row[idx.phone],
          date: row[idx.date],
          time: row[idx.time],
          location: row[idx.loc],
          status: status,
          venue: row[idx.venue],
          price: row[idx.price],
          received: row[idx.rec],
          balance: row[idx.bal]
        };
        updateSingleCalendarEvent(sheet, rowNum, params);
      }
    });
  });
}

function updateSingleCalendarEvent(sheet, rowNum, params) {
  const calendars = CalendarApp.getCalendarsByName(CALENDAR_NAME);
  const calendar = calendars.length > 0 ? calendars[0] : null;
  if (!calendar) return;

  const eventIdCell = sheet.getRange(rowNum, COL_EVENT_ID_IDX);
  const currentEventId = eventIdCell.getValue();
  const status = String(params.status || '');
  
  // åˆ¤å®šæ˜¯å¦éœ€è¦å‡ºç¾åœ¨è¡Œäº‹æ›†ä¸Š
  const isValidOrder = (status !== "" && !status.includes('æœªä»˜æ¬¾') && !status.toUpperCase().includes('UNPAID')) || 
                       status.includes('å·²ä»˜æ¬¾') || status.includes('æª¢æŸ¥å®Œç•¢') || status.includes('å·²å‚™è²¨');
  
  let startTime, endTime;
  try {
    const dStr = String(params.date);
    const tStr = String(params.time);
    const dParts = dStr.match(/(\d+)\/(\d+)\/(\d+)/) || dStr.match(/(\d+)-(\d+)-(\d+)/);
    const tParts = tStr.match(/(\d+):(\d+)/);
    
    if (dParts && tParts) {
      const year = parseInt(dParts[1]);
      const month = parseInt(dParts[2]) - 1;
      const day = parseInt(dParts[3]);
      let hour = parseInt(tParts[1]);
      let minute = parseInt(tParts[2]);
      if ((tStr.includes('ä¸‹åˆ') || tStr.toUpperCase().includes('PM')) && hour < 12) hour += 12;
      else if ((tStr.includes('ä¸Šåˆ') || tStr.toUpperCase().includes('AM')) && hour === 12) hour = 0;
      
      startTime = new Date(year, month, day, hour, minute);
      let durationHours = (params.service === 'å°ˆäººä½ˆç½®') ? 2 : 1;
      endTime = new Date(startTime.getTime() + (durationHours * 60 * 60 * 1000));
    }
  } catch (e) { return; }
  
  if (!startTime) return;
  const location = String(params.location || '');
  const sheetName = params.service;
  let shortService = (sheetName === 'å·¥ä½œå®¤å–è²¨') ? "è‡ªå–" : (sheetName === 'å°ˆäººä½ˆç½®' ? "å°ˆä½ˆ" : sheetName);
  const eventTitle = `ğŸˆ${location.substring(0,2)}${shortService} - ${params.lineName}(${params.clientName})`;
  let description = `è¨‚å–®: ${params.orderId}\né›»è©±: ${params.phone}\nåœ°é»: ${location}\nç‹€æ…‹: ${status}\nğŸ’° ç¸½é¡: ${params.price}\nâœ… å·²æ”¶: ${params.received}\nâ— å°¾æ¬¾: ${params.balance}`;

  if (isValidOrder && !currentEventId) {
    const event = calendar.createEvent(eventTitle, startTime, endTime, { description: description, location: location });
    event.removeAllReminders();
    eventIdCell.setValue(event.getId());
  } else if (isValidOrder && currentEventId) {
    const event = calendar.getEventById(currentEventId);
    if (event) {
      event.setTitle(eventTitle); event.setTime(startTime, endTime); event.setDescription(description); event.setLocation(location);
    } else { eventIdCell.setValue(""); }
  } else if (!isValidOrder && currentEventId) {
    const event = calendar.getEventById(currentEventId);
    if (event) event.deleteEvent();
    eventIdCell.setValue("");
  }
}

// --- Web API æ¥å£ ---
function doGet(e) {
  const action = e.parameter.action;
  if (action === 'getOrders') return handleGetOrders();
  return ContentService.createTextOutput("MILU API Active");
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    if (params.action === 'updateStatus') return handleUpdateStatus(params);
    return responseJSON({status: 'error', message: 'Unknown Action'});
  } catch (err) { return responseJSON({status: 'error', message: err.toString()}); }
}

function handleGetOrders() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let allData = [];
  SHEET_NAMES.forEach(name => {
    const sheet = ss.getSheetByName(name.trim());
    if (!sheet) return;
    const data = sheet.getDataRange().getDisplayValues();
    const headers = data[0];
    
    // æ‰¾å‡ºç‹€æ…‹æ¬„ä½ç´¢å¼•ï¼Œç”¨æ–¼å¾Œç«¯éæ¿¾
    const statusIdx = headers.indexOf("ç‹€æ…‹") !== -1 ? headers.indexOf("ç‹€æ…‹") : headers.indexOf("ä»˜æ¬¾ç‹€æ…‹");

    const rows = data.slice(1).map((row, i) => {
      const obj = { "__row__": i + 2, "__sheet__": name };
      headers.forEach((h, idx) => { if (h) obj[h] = row[idx]; });
      return obj;
    }).filter(obj => {
      // å¾Œç«¯éæ¿¾ï¼šåƒ…æŠ“å–å·²ä»˜æ¬¾è³‡æ–™
      const status = obj["ç‹€æ…‹"] || obj["ä»˜æ¬¾ç‹€æ…‹"] || "";
      return status !== "" && !status.includes("æœªä»˜æ¬¾") && !status.toUpperCase().includes("UNPAID");
    });
    
    allData = allData.concat(rows);
  });
  return responseJSON(allData);
}

function handleUpdateStatus(params) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(params.sheet.trim());
  if (!sheet) return responseJSON({status: 'error', message: 'Sheet not found'});
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const statusCol = headers.indexOf("ç‹€æ…‹") + 1 || headers.indexOf("ä»˜æ¬¾ç‹€æ…‹") + 1 || 11;
  
  sheet.getRange(params.row, statusCol).setValue(params.status);
  
  // æ›´æ–°æ—¥æ›†
  const rowData = sheet.getRange(params.row, 1, 1, 26).getDisplayValues()[0];
  const updateParams = {
    service: params.sheet, orderId: rowData[0], lineName: rowData[2], clientName: rowData[3],
    phone: rowData[4], date: rowData[5], time: rowData[6], location: rowData[7],
    status: params.status, price: rowData[11], received: rowData[12], balance: rowData[13]
  };
  updateSingleCalendarEvent(sheet, params.row, updateParams);
  
  return responseJSON({status: 'success'});
}

function responseJSON(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
