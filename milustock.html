<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>麋鹿氣球 - 整合備貨管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .primary-gradient { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .order-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CONFIG = {
            OFFICIAL: {
                name: "官網系統",
                url: "https://script.google.com/macros/s/AKfycbwhH5axa1J6Q9nThs0Z8SQ3O4aEUAsTg5p9aTa1Mdwe-iJAd1GbI8t2SS1KnF6MDCTqBQ/exec",
                statusField: "備貨狀態",
                params: "action=getOrders"
            },
            MILU: {
                name: "MILU系統",
                url: "https://script.google.com/macros/s/AKfycbyL1VarFpdQhPe24Fj9RQrGYoGunAcm1XNxlZwIW-kr_3CqG_hvQgWoS0xpCb9zb0vdjQ/exec",
                statusField: "撿貨狀態",
                params: "mode=api"
            }
        };

        const CATEGORIES = ["全部", "專人佈置", "氣球外送", "工作室取貨", "後車廂佈置"];

        const FIELD_MAPS = {
            id: ["訂單編號", "編號", "OrderID"],
            name: ["收件人姓名", "收件人", "客戶名稱", "姓名"],
            address: ["詳細地址", "地址", "送貨地址", "地點"],
            date: ["日期", "送貨日期", "預約日期", "取貨/送貨日期"],
            time: ["時間/時段", "送貨時段", "配送時段", "預約時間", "時間"],
            status: ["備貨狀態", "撿貨狀態", "備貨"],
            payment: ["付款狀態", "狀態", "付款"],
            remark: ["備註", "備註欄", "注意事項"],
            quoteUrl: ["報價單連結", "報價單網址"]
        };

        const LucideIcon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentCategory, setCurrentCategory] = useState("全部");
            const [toast, setToast] = useState(null);

            const findVal = (order, type) => {
                if (!order) return "";
                const keys = Object.keys(order);
                const targets = FIELD_MAPS[type] || [];
                const cleanKeys = keys.filter(k => !k.includes("戳記") && !k.toLowerCase().includes("timestamp"));
                let actualKey = targets.reduce((found, t) => found || cleanKeys.find(k => k.trim() === t), null) || 
                                targets.reduce((found, t) => found || cleanKeys.find(k => k.includes(t)), null);
                
                let val = actualKey ? order[actualKey] : "";
                if (type === 'date' && val) {
                    const d = new Date(val);
                    if (!isNaN(d.getTime())) {
                        if (String(val).includes("T") && !String(val).includes("1899")) d.setHours(d.getHours() + 8);
                        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
                    }
                }
                if (type === 'time' && val && (String(val).includes("1899") || String(val).includes("T"))) {
                    const d = new Date(val);
                    if (!isNaN(d.getTime())) {
                        const h = d.getHours(), m = String(d.getMinutes()).padStart(2, '0');
                        return `${h >= 12 ? '下午' : '上午'} ${h % 12 || 12}:${m}`;
                    }
                }
                return String(val || "").trim();
            };

            const fetchAllData = async () => {
                setLoading(true);
                let combined = [];
                for (const key of Object.keys(CONFIG)) {
                    try {
                        const res = await fetch(`${CONFIG[key].url}?${CONFIG[key].params}&t=${Date.now()}`);
                        const data = await res.json();
                        if (key === "MILU") {
                            combined.push(...data.map(row => ({
                                "訂單編號": row[0], "客戶名稱": row[3], "日期": row[5], "時間/時段": row[6],
                                "地點": row[7], "狀態": row[10], "撿貨狀態": row[21], "_src": "MILU", "_apiUrl": CONFIG.MILU.url, "__sheet__": row[row.length-1]
                            })));
                        } else {
                            combined.push(...data.map(o => ({ ...o, _src: "OFFICIAL", _apiUrl: CONFIG.OFFICIAL.url })));
                        }
                    } catch (e) { console.error(key + " 讀取失敗"); }
                }
                setOrders(combined);
                setLoading(false);
            };

            useEffect(() => { fetchAllData(); }, []);

            const showToast = (text) => { setToast(text); setTimeout(() => setToast(null), 3000); };

            const handleUpdate = async (order, newStatus) => {
                setLoading(true);
                try {
                    const isMilu = order._src === "MILU";
                    const payload = isMilu ? {
                        action: "UPDATE_ORDER", orderId: order["訂單編號"], service: order["__sheet__"], pickingStatus: newStatus
                    } : {
                        action: "updateStatus", row: order["__row__"], status: newStatus, columnName: CONFIG.OFFICIAL.statusField
                    };
                    await fetch(order._apiUrl, { method: "POST", body: JSON.stringify(payload) });
                    showToast("更新成功: " + newStatus);
                    fetchAllData();
                } catch (e) { showToast("更新失敗"); setLoading(false); }
            };

            const dayStatus = useMemo(() => {
                const stats = {};
                orders.forEach(o => {
                    const date = findVal(o, 'date').replace(/\//g, '-');
                    if (!date) return;
                    if (!stats[date]) stats[date] = { green: true, red: false, yellow: false };
                    const s = findVal(o, 'status');
                    if (!s || s === "未撿取") stats[date].red = true;
                    else if (s === "已備貨") stats[date].yellow = true;
                });
                return stats;
            }, [orders]);

            const filtered = orders.filter(o => {
                if (currentCategory !== "全部" && o["__sheet__"] !== currentCategory) return false;
                return findVal(o, 'date').replace(/\//g, '-').includes(selectedDate);
            }).sort((a, b) => findVal(a, 'time').localeCompare(findVal(b, 'time')));

            const days = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                const start = new Date(y, m, 1).getDay(), len = new Date(y, m + 1, 0).getDate();
                return Array.from({ length: 42 }, (_, i) => (i >= start && i < start + len) ? new Date(y, m, i - start + 1).toISOString().split('T')[0] : null);
            }, [currentMonth]);

            return (
                <div className="min-h-screen pb-20">
                    <header className="primary-gradient text-white p-4 sticky top-0 z-40 flex justify-between items-center shadow-lg">
                        <div className="flex items-center gap-3"><LucideIcon name="package" size={24} /><h1 className="text-xl font-black">麋鹿氣球備貨系統</h1></div>
                        <button onClick={fetchAllData} className="p-2"><LucideIcon name="refresh-cw" className={loading ? "spin" : ""} /></button>
                    </header>
                    <div className="bg-white/80 backdrop-blur-md border-b sticky top-[64px] z-30 flex gap-2 p-3 overflow-x-auto no-scrollbar">
                        {CATEGORIES.map(c => <button key={c} onClick={() => setCurrentCategory(c)} className={`px-4 py-2 rounded-full text-xs font-black transition-all ${currentCategory === c ? 'bg-emerald-800 text-white' : 'bg-slate-100 text-slate-400'}`}>{c}</button>)}
                    </div>
                    <main className="max-w-6xl mx-auto p-4 lg:flex gap-8">
                        <div className="lg:w-[340px] shrink-0 mb-6">
                            <div className="bg-white rounded-[2.5rem] shadow-sm border p-6 sticky top-[150px]">
                                <div className="flex justify-between items-center mb-6"><h2 className="font-black text-slate-700">{currentMonth.getFullYear()} / {currentMonth.getMonth() + 1}</h2><div className="flex gap-2"><button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(m-1)))}><LucideIcon name="chevron-left" /></button><button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(m+1)))}><LucideIcon name="chevron-right" /></button></div></div>
                                <div className="grid grid-cols-7 gap-1 text-center">
                                    {['日', '一', '二', '三', '四', '五', '六'].map(d => <div key={d} className="text-[10px] font-black text-slate-300 py-2">{d}</div>)}
                                    {days.map((d, i) => {
                                        const s = dayStatus[d];
                                        return <div key={i} onClick={() => d && setSelectedDate(d)} className={`h-11 rounded-2xl flex flex-col items-center justify-center cursor-pointer text-sm font-bold relative ${d === selectedDate ? 'bg-emerald-800 text-white shadow-lg scale-110' : 'hover:bg-slate-50'}`}>
                                            <span>{d ? parseInt(d.split('-')[2]) : ""}</span>
                                            {s && <div className="flex gap-0.5 absolute bottom-1">
                                                {s.green && <div className="w-1 h-1 rounded-full bg-emerald-500"></div>}
                                                {s.yellow && <div className="w-1 h-1 rounded-full bg-amber-400"></div>}
                                                {s.red && <div className="w-1 h-1 rounded-full bg-red-600 animate-pulse"></div>}
                                            </div>}
                                        </div>
                                    })}
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 space-y-4">
                            <h3 className="font-black text-slate-600 flex items-center gap-2 px-2"><LucideIcon name="list-checks" className="text-emerald-600" /> {selectedDate} 排程 ({filtered.length})</h3>
                            {filtered.length === 0 ? <div className="py-20 text-center bg-white rounded-[3rem] border-2 border-dashed text-slate-300 font-black italic">尚無待辦事項</div> : filtered.map(o => (
                                <div key={o._src + (o["訂單編號"]||o["__row__"])} className="bg-white rounded-[2.5rem] shadow-sm border p-7 order-card">
                                    <div className="flex justify-between mb-5">
                                        <div className="space-y-1">
                                            <div className="flex gap-2"><span className={`text-[9px] font-black px-2 py-0.5 rounded border ${o._src==='OFFICIAL'?'bg-blue-50 text-blue-600 border-blue-100':'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>{CONFIG[o._src].name}</span><span className="text-[9px] font-black bg-slate-100 text-slate-400 px-2 py-0.5 rounded uppercase">{o["__sheet__"]}</span></div>
                                            <h4 className="font-black text-2xl text-slate-800">{findVal(o, 'name')}</h4>
                                            <p className="text-[10px] text-slate-300 font-bold tracking-widest">#{findVal(o, 'id')}</p>
                                        </div>
                                        <div className={`text-[10px] font-black px-4 py-1.5 rounded-full h-fit shadow-sm ${findVal(o, 'status').includes("檢查") ? "bg-emerald-500 text-white" : findVal(o, 'status').includes("已備") ? "bg-amber-400 text-white" : "bg-red-600 text-white"}`}>{findVal(o, 'status') || "未撿取"}</div>
                                    </div>
                                    <div className="space-y-3 mb-6">
                                        <div className="flex items-center gap-3 text-slate-700 font-black bg-slate-50 p-3 rounded-2xl w-fit border border-slate-100"><LucideIcon name="clock" className="text-emerald-500" />{findVal(o, 'time')}</div>
                                        <div className="flex items-start gap-3 px-1 text-sm text-slate-500 font-bold leading-relaxed"><LucideIcon name="map-pin" className="shrink-0 text-slate-300" />{findVal(o, 'address')}</div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        {["未撿取", "已備貨", "檢查完畢"].map(st => <button key={st} onClick={() => handleUpdate(o, st)} className={`py-4 rounded-2xl text-[11px] font-black border transition-all active:scale-95 ${findVal(o, 'status') === st || (!findVal(o,'status') && st==='未撿取') ? 'bg-slate-800 text-white shadow-xl' : 'bg-white text-slate-400 border-slate-100'}`}>{st}</button>)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                    {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 px-10 py-4 rounded-full shadow-2xl z-[300] bg-slate-900 text-white text-sm font-black animate-bounce">{toast}</div>}
                    {loading && <div className="fixed inset-0 bg-white/40 backdrop-blur-md flex flex-col items-center justify-center z-[500]"><div className="w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div></div>}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
