<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶æ¬¾ç¢ºèªç™¼é€å™¨ | MILU Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', green: '#10B981' }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; padding: 20px; padding-bottom: 80px; }
        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 500px; margin: 0 auto; margin-bottom: 20px; }
        .input-group { margin-bottom: 16px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; color: #374151; }
        .input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; font-size: 1rem; background-color: #fff; }
        .input:focus { border-color: #C69C6D; ring: 2px solid #C69C6D; }
        .input-readonly { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
        .btn { width: 100%; padding: 14px; background-color: #4A4A4A; color: white; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); background-color: #333; }
        .preview-title { text-align: center; font-family: 'Playfair Display', serif; color: #C69C6D; font-size: 1.5rem; margin-bottom: 20px; font-weight: bold; }
        
        /* è¼”åŠ©å€å¡Šæ¨£å¼ */
        .code-box { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem; color: #2563eb; word-break: break-all; position: relative; margin-top: 10px; min-height: 60px; display: flex; align-items: center; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background-color: #e5e7eb; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; color: #4b5563; cursor: pointer; border: none; font-weight: bold; }
        .copy-btn:hover { background-color: #d1d5db; }
        .pill-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .pill { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: 1px solid #C69C6D; color: #C69C6D; background: white; transition: all 0.2s; }
        .pill.active { background: #C69C6D; color: white; }
    </style>
</head>
<body>

    <!-- ç™¼é€å™¨ä¸»ä»‹é¢ -->
    <div class="card">
        <div class="preview-title">Payment Confirm</div>
        <p class="text-center text-xs text-gray-400 mb-6">ç¢ºèªæ¬¾é …å¾Œï¼Œé¸å–å®¢äººç™¼é€é€šçŸ¥</p>

        <form id="admin-form" onsubmit="return sendConfirmMessage(this)">
            
            <div class="input-group">
                <label class="label">è¨‚å–®ç·¨è™Ÿ (Order ID)</label>
                <input type="text" id="cust-oid" class="input input-readonly" placeholder="è‡ªå‹•å¸¶å…¥" readonly>
            </div>

            <div class="input-group">
                <label class="label">å®¢äººå§“å</label>
                <input type="text" id="cust-name" class="input" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾" required>
            </div>

            <div class="input-group">
                <label class="label">æœå‹™é …ç›®</label>
                <select id="cust-service" class="input" required>
                    <option value="" disabled selected>è«‹é¸æ“‡æœå‹™</option>
                    <option value="å°ˆäººä½ˆç½®">âœ¨ å°ˆäººä½ˆç½®</option>
                    <option value="æ°£çƒå¤–é€">ğŸšš æ°£çƒå¤–é€</option>
                    <option value="å¾Œè»Šå»‚é©šå–œ">ğŸš— å¾Œè»Šå»‚é©šå–œ</option>
                    <option value="å·¥ä½œå®¤è‡ªå–">ğŸ›ï¸ å·¥ä½œå®¤è‡ªå–</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="label">æ—¥æœŸ</label>
                    <input type="date" id="cust-date" class="input" required>
                </div>
                <div class="input-group">
                    <label class="label">æ™‚é–“</label>
                    <input type="text" id="cust-time" class="input" placeholder="13:00" required>
                </div>
            </div>

            <div class="input-group">
                <label class="label">ç¢ºèªé‡‘é¡</label>
                <input type="text" id="cust-price" class="input" placeholder="ä¾‹å¦‚ï¼š$2,500 (å«é‹)">
            </div>
            
            <!-- éš±è—æ¬„ä½ï¼Œç”¨æ–¼å„²å­˜å®¢æˆ¶ ID -->
            <input type="hidden" id="cust-to-id" value="">

            <button type="submit" class="btn">
                é¸å–å®¢äººä¸¦ç™¼é€ <i class="fa-solid fa-paper-plane ml-1"></i>
            </button>
        </form>
    </div>

    <!-- è©¦ç®—è¡¨å…¬å¼å°å¹«æ‰‹ -->
    <div class="card">
        <div class="preview-title" style="font-size: 1.2rem;">Google è©¦ç®—è¡¨é€£å‹•</div>
        <p class="text-xs text-gray-500 mb-4">
            è«‹é¸æ“‡æœå‹™é¡å‹ï¼Œè¤‡è£½å…¬å¼åˆ° Google è©¦ç®—è¡¨çš„ã€Œç™¼é€é€šçŸ¥ã€æ¬„ï¼š
        </p>

        <div class="pill-group">
            <div class="pill active" onclick="setFormula('å°ˆäººä½ˆç½®', this)">å°ˆäººä½ˆç½®</div>
            <div class="pill" onclick="setFormula('æ°£çƒå¤–é€', this)">æ°£çƒå¤–é€</div>
            <div class="pill" onclick="setFormula('å¾Œè»Šå»‚é©šå–œ', this)">å¾Œè»Šå»‚</div>
            <div class="pill" onclick="setFormula('å·¥ä½œå®¤è‡ªå–', this)">è‡ªå–</div>
        </div>
        
        <div class="code-box">
            <code id="formula-code"></code>
            <button onclick="copyFormula()" class="copy-btn">è¤‡è£½å…¬å¼</button>
        </div>
        
        <div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500 leading-relaxed border border-gray-100">
            <p class="font-bold mb-1">ğŸ’¡ å¦‚ä½•ä½¿ç”¨ï¼š</p>
            1. åœ¨è©¦ç®—è¡¨æ–°å¢ä¸€æ¬„ã€Œç™¼é€é€šçŸ¥ã€ã€‚<br>
            2. è²¼ä¸Šå…¬å¼ã€‚<br>
            3. ç¢ºèªå…¬å¼å…§çš„å„²å­˜æ ¼ä»£è™Ÿ (å¦‚ B2, C2) å°æ‡‰æ­£ç¢ºã€‚
        </div>
    </div>

    <script>
        // âœ… é€™è£¡å¡«å…¥æ‚¨ä¹‹å‰æä¾›çš„ã€ç®¡ç†å“¡å°ˆç”¨ LIFF IDã€‘
        const LIFF_ID = '2004044468-KFCOlJSB'; 

        window.onload = function() {
            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    console.log('LIFF initialized');
                    if (!liff.isLoggedIn()) liff.login();
                })
                .catch((err) => { console.error(err); });

            // *** ä¿®æ­£ï¼šè™•ç† LIFF é‡å°å‘çš„åƒæ•¸ (liff.state) ***
            const urlParams = new URLSearchParams(window.location.search);
            let params;
            
            if (urlParams.has('liff.state')) {
                // å¦‚æœç¶²å€ä¸­æœ‰ liff.stateï¼Œè§£æå®ƒ
                const stateValue = decodeURIComponent(urlParams.get('liff.state'));
                // liff.state çš„æ ¼å¼æ˜¯ key=value&key2=value2ï¼Œæ‰€ä»¥ç›´æ¥ç”¨ URLSearchParams è§£æ
                params = new URLSearchParams(stateValue);
            } else {
                // å¦å‰‡ï¼Œè®€å–æ™®é€šçš„ URL åƒæ•¸
                params = urlParams;
            }
            
            // æª¢æŸ¥ 'to' åƒæ•¸æ˜¯å¦å­˜åœ¨
            const toId = params.get('to');
            if (toId) {
                document.getElementById('cust-to-id').value = toId;
                console.log("Client ID loaded successfully.");
            } else {
                // å¦‚æœæ²’æœ‰å®¢æˆ¶ IDï¼Œé¡¯ç¤ºéŒ¯èª¤ (é€™å°±æ˜¯æ‚¨çœ‹åˆ°çš„éŒ¯èª¤è¨Šæ¯çš„ä¾†æº)
                Swal.fire('éŒ¯èª¤ï¼šæœªæ‰¾åˆ°å®¢æˆ¶ ID', 'to åƒæ•¸éºå¤±æˆ–æœªæˆåŠŸå¾ LIFF å‚³è¼¸ã€‚è«‹ç¢ºèª Google è©¦ç®—è¡¨ L æ¬„æœ‰ User ID äº‚ç¢¼ã€‚', 'error');
            }

            // è‡ªå‹•è®€å–ç¶²å€åƒæ•¸ï¼Œä¸¦å¡«å…¥è¡¨å–®
            if (params.has('oid')) document.getElementById('cust-oid').value = params.get('oid');
            if (params.has('name')) document.getElementById('cust-name').value = params.get('name');
            if (params.has('service')) document.getElementById('cust-service').value = params.get('service');
            if (params.has('date')) document.getElementById('cust-date').value = params.get('date');
            if (params.has('time')) document.getElementById('cust-time').value = params.get('time');
            if (params.has('price')) document.getElementById('cust-price').value = params.get('price');

            // é è¨­é¡¯ç¤ºå…¬å¼
            setFormula('å°ˆäººä½ˆç½®', document.querySelector('.pill.active'));
        };

        // ç”¢ç”Ÿ Google è©¦ç®—è¡¨å…¬å¼
        function setFormula(serviceName, btn) {
            document.querySelectorAll('.pill').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // é€™è£¡é¡¯ç¤ºçš„å…¬å¼æ˜¯ç¯„æœ¬ï¼Œèˆ‡æ‚¨å¯¦éš›ä½¿ç”¨çš„ ARRAYFORMULA èªæ³•ç•¥æœ‰ä¸åŒï¼Œä½†é‚è¼¯ä¸€è‡´ã€‚
            const formula = `=ARRAYFORMULA(IF(ISBLANK(B2:B);"";HYPERLINK("https://liff.line.me/${LIFF_ID}?to="&L2:L&"&oid="&A2:A&"&name="&C2:C&"&service=${serviceName}"&"&date="&TEXT(D2:D;"YYYY/MM/DD")&"&time="&P2:P&"&price="&K2:K;"ğŸ“² ç™¼é€é€šçŸ¥")))`;
            
            document.getElementById('formula-code').innerText = formula;
        }

        // ç™¼é€å¡ç‰‡é‚è¼¯
        function sendConfirmMessage(form) {
            event.preventDefault();

            const oid = document.getElementById('cust-oid').value || '#';
            const name = document.getElementById('cust-name').value;
            const service = document.getElementById('cust-service').value;
            const date = document.getElementById('cust-date').value;
            const time = document.getElementById('cust-time').value;
            const price = document.getElementById('cust-price').value || '-';
            const toId = document.getElementById('cust-to-id').value; // è®€å–éš±è—æ¬„ä½çš„å®¢æˆ¶ ID

            if (!liff.isInClient()) {
                Swal.fire('è«‹åœ¨ LINE å…§é–‹å•Ÿ', 'è«‹é»æ“Šè©¦ç®—è¡¨ä¸­çš„é€£çµé–‹å•Ÿæ­¤é é¢ï¼Œæ‰èƒ½ä½¿ç”¨é¸äººç™¼é€åŠŸèƒ½ã€‚', 'warning');
                return false;
            }

            // å¦‚æœå®¢æˆ¶ ID ä»ç„¶æ˜¯ç©ºçš„ï¼Œå‰‡æé†’ç®¡ç†å“¡
            if (!toId) {
                Swal.fire('éŒ¯èª¤ï¼šæœªæ‰¾åˆ°å®¢æˆ¶ ID', 'å®¢æˆ¶ ID éºå¤±ã€‚è«‹ç¢ºèª L æ¬„è³‡æ–™æ­£ç¢ºï¼Œæˆ–ä½¿ç”¨ã€Œé¸äººç™¼é€ã€åŠŸèƒ½æ‰‹å‹•é¸æ“‡å®¢æˆ¶ã€‚', 'error');
                return false;
            }

            // ç™¼é€ Flex Message (ShareTargetPicker)
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    type: 'flex',
                    altText: 'âœ… æ‚¨çš„é ç´„å·²ç¢ºèªæˆåŠŸï¼',
                    contents: {
                        "type": "bubble",
                        "size": "mega",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "PAYMENT CONFIRMED", "weight": "bold", "color": "#10B981", "size": "xs", "align": "center", "letterSpacing": "1px" },
                                { "type": "text", "text": "é ç´„ç¢ºèªæˆåŠŸ", "weight": "bold", "size": "xl", "margin": "md", "align": "center", "color": "#4A4A4A" },
                                { "type": "text", "text": "æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„æ¬¾é …ï¼ŒæœŸå¾…ç‚ºæ‚¨æœå‹™ï¼", "size": "xs", "color": "#aaaaaa", "wrap": true, "align": "center", "margin": "sm" },
                                
                                // è¨‚å–®ç·¨è™Ÿå€å¡Š
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "margin": "lg",
                                    "backgroundColor": "#F0FDF4",
                                    "cornerRadius": "md",
                                    "paddingAll": "sm",
                                    "contents": [
                                        { "type": "text", "text": "ORDER ID: " + oid, "size": "xs", "color": "#10B981", "align": "center", "weight": "bold" }
                                    ]
                                },

                                { "type": "separator", "margin": "xxl" },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "margin": "xxl",
                                    "spacing": "sm",
                                    "contents": [
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "å§“å", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": name, "size": "sm", "color": "#111111", "align": "end", "weight": "bold" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "é …ç›®", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": service, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "æ—¥æœŸ", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": date, "size": "sm", "color": "#111111", "align": "end" } ] },
                                        { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "æ™‚é–“", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": time, "size": "sm", "color": "#111111", "align": "end" } ] }
                                    ]
                                },
                                { "type": "box", "layout": "vertical", "margin": "lg", "contents":
