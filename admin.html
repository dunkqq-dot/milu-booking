<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶æ¬¾ç¢ºèªç™¼é€å™¨ | MILU Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        milu: { gold: '#C69C6D', dark: '#4A4A4A', green: '#10B981' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; color: #4A4A4A; padding: 20px; padding-bottom: 80px; }
        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); max-width: 500px; margin: 0 auto; margin-bottom: 20px; }
        .input-group { margin-bottom: 16px; }
        .label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; color: #374151; }
        .input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; font-size: 1rem; background-color: #fff; }
        .input:focus { border-color: #C69C6D; ring: 2px solid #C69C6D; }
        .input-readonly { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
        .btn { width: 100%; padding: 14px; background-color: #4A4A4A; color: white; border-radius: 12px; font-weight: bold; font-size: 1rem; margin-top: 10px; transition: all 0.2s; }
    </style>
</head>
<body>

    <div class="card">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-milu-gold">Payment Confirm</h2>
            <p class="text-xs text-gray-400">ç¢ºèªæ¬¾é …å¾Œï¼Œé»æ“ŠæŒ‰éˆ•å¾å®˜æ–¹å¸³è™Ÿç™¼é€</p>
        </div>

        <form id="admin-form" onsubmit="return sendConfirmMessage()">
            <div class="input-group">
                <label class="label">è¨‚å–®ç·¨è™Ÿ</label>
                <input type="text" id="cust-oid" class="input input-readonly" readonly>
            </div>
            <div class="input-group">
                <label class="label">æœå‹™é …ç›®</label>
                <select id="cust-service" class="input" required>
                    <option value="å°ˆäººä½ˆç½®">âœ¨ å°ˆäººä½ˆç½®</option>
                    <option value="æ°£çƒå¤–é€">ğŸšš æ°£çƒå¤–é€</option>
                    <option value="å¾Œè»Šå»‚é©šå–œ">ğŸš— å¾Œè»Šå»‚é©šå–œ</option>
                    <option value="å·¥ä½œå®¤è‡ªå–">ğŸ›ï¸ å·¥ä½œå®¤è‡ªå–</option>
                </select>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="label">å®¢äººå§“å</label>
                    <input type="text" id="cust-name" class="input" required>
                </div>
                <div class="input-group">
                    <label class="label">è¯çµ¡é›»è©±</label>
                    <input type="text" id="cust-phone" class="input" placeholder="0912345678" required>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label class="label">æ—¥æœŸ</label>
                    <input type="date" id="cust-date" class="input" required>
                </div>
                <div class="input-group">
                    <label class="label">æ™‚é–“</label>
                    <input type="text" id="cust-time" class="input" required>
                </div>
            </div>

            <div class="input-group">
                <label class="label">åœ°é» / åœ°å€</label>
                <input type="text" id="cust-location" class="input" placeholder="è«‹è¼¸å…¥åœ°å€æˆ–é–€å¸‚" required>
            </div>

            <div class="input-group">
                <label class="label">ç¢ºèªé‡‘é¡</label>
                <input type="text" id="cust-price" class="input" placeholder="ä¾‹å¦‚ï¼š2500">
            </div>
            
            <input type="hidden" id="cust-to-id" value="">

            <button type="submit" class="btn">
                ç™¼é€é ç´„æˆåŠŸé€šçŸ¥ <i class="fa-solid fa-paper-plane ml-1"></i>
            </button>
        </form>
    </div>

    <script>
        const WEBHOOK_URL = 'https://hook.eu1.make.com/mhwhl6m6nqii8zfbv9p3ggz2ih12dpt6';
        const LIFF_ID = '2004044468-KFCOlJSB'; 

        window.onload = function() {
            liff.init({ liffId: LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) { liff.login(); } else { parseUrlParams(); }
            }).catch(err => console.error(err));
        };

        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            let params = urlParams;
            if (urlParams.has('liff.state')) {
                params = new URLSearchParams(decodeURIComponent(urlParams.get('liff.state')));
            }

            document.getElementById('cust-to-id').value = params.get('to') || '';
            document.getElementById('cust-oid').value = params.get('oid') || '';
            document.getElementById('cust-name').value = params.get('name') || '';
            document.getElementById('cust-service').value = params.get('service') || 'å°ˆäººä½ˆç½®';
            document.getElementById('cust-date').value = params.get('date') || '';
            document.getElementById('cust-time').value = params.get('time') || '';
            document.getElementById('cust-price').value = params.get('price') || '';
            
            // æ–°å¢ï¼šé›»è©±èˆ‡åœ°é»
            document.getElementById('cust-phone').value = params.get('phone') || '';
            document.getElementById('cust-location').value = params.get('location') || '';
        }

        function buildFlexMessage(oid, name, service, date, time, price, phone, location) {
            const formattedPrice = price ? price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : 'å¾…ç¢ºèª';
            const icon = { 'å°ˆäººä½ˆç½®': 'âœ¨', 'æ°£çƒå¤–é€': 'ğŸšš', 'å¾Œè»Šå»‚é©šå–œ': 'ğŸš—', 'å·¥ä½œå®¤è‡ªå–': 'ğŸ›ï¸' }[service] || 'âœ…';

            return {
                type: 'flex',
                altText: `âœ… æ‚¨çš„${service}é ç´„å·²ç¢ºèªæˆåŠŸï¼`,
                contents: {
                    "type": "bubble",
                    "size": "mega",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            { "type": "text", "text": "PAYMENT CONFIRMED", "weight": "bold", "color": "#10B981", "size": "xs", "align": "center", "letterSpacing": "1px" },
                            { "type": "text", "text": `${icon} ${service} é ç´„ç¢ºèª`, "weight": "bold", "size": "xl", "margin": "md", "align": "center", "color": "#4A4A4A" },
                            { "type": "separator", "margin": "lg" },
                            {
                                "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm",
                                "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "å®¢æˆ¶å§“å", "size": "sm", "color": "#999999", "flex": 2 }, { "type": "text", "text": name, "size": "sm", "color": "#111111", "align": "end", "weight": "bold", "flex": 4 } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "è¯çµ¡é›»è©±", "size": "sm", "color": "#999999", "flex": 2 }, { "type": "text", "text": phone, "size": "sm", "color": "#111111", "align": "end", "flex": 4 } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "æ—¥æœŸæ™‚é–“", "size": "sm", "color": "#999999", "flex": 2 }, { "type": "text", "text": date + ' ' + time, "size": "sm", "color": "#111111", "align": "end", "flex": 4 } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "åœ°é»", "size": "sm", "color": "#999999", "flex": 2 }, { "type": "text", "text": location, "size": "sm", "color": "#111111", "align": "end", "wrap": true, "flex": 4 } ] }
                                ]
                            },
                            { "type": "separator", "margin": "lg" },
                            { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [ { "type": "text", "text": "ç¢ºèªé‡‘é¡", "size": "sm", "color": "#999999" }, { "type": "text", "text": "NT$ " + formattedPrice, "size": "md", "color": "#C69C6D", "align": "end", "weight": "bold" } ] },
                             { "type": "box", "layout": "vertical", "margin": "xxl", "contents": [ { "type": "image", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png", "size": "xxs", "aspectMode": "fit" }, { "type": "text", "text": "MILU BALLOONS", "size": "xxxs", "color": "#dddddd", "align": "center", "margin": "xs", "letterSpacing": "2px" } ] }
                        ]
                    }
                }
            };
        }

        async function sendConfirmMessage() {
            event.preventDefault();
            const toId = document.getElementById('cust-to-id').value;
            if (!toId) return Swal.fire('éŒ¯èª¤', 'å®¢æˆ¶ ID éºå¤±', 'error');

            Swal.fire({ title: 'ç™¼é€ä¸­...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const payload = {
                to: toId,
                orderId: document.getElementById('cust-oid').value,
                clientName: document.getElementById('cust-name').value,
                service: document.getElementById('cust-service').value,
                price: document.getElementById('cust-price').value,
                // å‚³éæ‰€æœ‰æ¬„ä½çµ¦ Make å’Œ Flex Builder
                message: buildFlexMessage(
                    document.getElementById('cust-oid').value,
                    document.getElementById('cust-name').value,
                    document.getElementById('cust-service').value,
                    document.getElementById('cust-date').value,
                    document.getElementById('cust-time').value,
                    document.getElementById('cust-price').value,
                    document.getElementById('cust-phone').value,
                    document.getElementById('cust-location').value
                )
            };

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) Swal.fire('ç™¼é€æˆåŠŸ', 'é€šçŸ¥å·²é€é”', 'success');
                else throw new Error('Server Error');
            } catch (error) {
                Swal.fire('ç™¼é€å¤±æ•—', error.message, 'error');
            }
            return false;
        }
    </script>
</body>
</html>
