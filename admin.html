<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>發送通知確認 (管理後台專用)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #f7f7f7; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 400px; width: 100%; text-align: center; }
        .btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; transition: background-color 0.3s; }
        .status-box { background: #e0f7fa; color: #00796b; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="card">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">發送預約確認通知</h1>
        <p class="text-gray-600 mb-6">請確認您要發送以下通知給客戶：</p>
        
        <div id="content-display" class="status-box text-left">
            <div class="font-bold text-lg mb-2">通知內容載入中...</div>
        </div>
        
        <button id="send-btn" class="btn bg-green-500 hover:bg-green-600 text-white w-full mt-6" onclick="sendConfirmation()">
            點此發送 [✅ 款項已確認]
        </button>

        <p id="error-message" class="text-red-500 mt-4 text-sm hidden">發送失敗，請從 LINE APP 內部重試。</p>
    </div>

    <script>
        let USER_ID = '';
        let FLEX_MESSAGE_JSON = null; // 儲存 Flex 訊息物件

        window.onload = function() {
            // 引入 SweetAlert 的字體，與 LINE 的 Noto Sans TC 一致
            const link = document.createElement('link');
            link.href = 'https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap';
            link.rel = 'stylesheet';
            document.head.appendChild(link);
            
            // 獲取 URL 參數
            const urlParams = new URLSearchParams(window.location.search);
            
            // 從 URL 獲取必要參數
            USER_ID = urlParams.get('to');
            const name = urlParams.get('name') || '客戶';
            const service = urlParams.get('service') || '預約服務';
            const date = urlParams.get('date') || '未定日期';
            const time = urlParams.get('time') || '請見內文'; // 假設時間也傳過來

            // 建立 Flex 訊息物件
            FLEX_MESSAGE_JSON = buildFlexMessage(name, service, date, time);
            
            // 顯示內容給管理員確認
            document.getElementById('content-display').innerHTML = `
                <p class="text-sm">發送給：<span class="font-bold">${name}</span></p>
                <p class="text-sm">服務：${service}</p>
                <p class="text-sm">日期：${date}</p>
                <p class="text-sm">時間：${time}</p>
                <hr class="my-2 border-gray-300">
                <p class="font-bold text-gray-800">將以卡片形式發送確認通知。</p>
            `;

            // 初始化 LIFF
            if (USER_ID) {
                 liff.init({ liffId: '2004044468-w8s4Ex1k' })
                    .then(() => {
                        console.log('LIFF initialized');
                    })
                    .catch(err => {
                        console.error('LIFF Init Error:', err);
                        document.getElementById('error-message').textContent = 'LIFF 初始化失敗。';
                        document.getElementById('error-message').classList.remove('hidden');
                    });
            } else {
                 document.getElementById('content-display').innerHTML = `<p class="font-bold text-red-700">錯誤：未找到客戶 ID (to 參數遺失)。</p>`;
                 document.getElementById('send-btn').disabled = true;
            }
        };

        // 建立 Flex Message JSON 結構
        function buildFlexMessage(name, service, date, time) {
            // 由於價格和訂單ID可能無法穩定從官方帳號後台點擊連結傳送，我們使用簡化版卡片。
            const pricePlaceholder = '已收款 (請查閱原始訂單)';
            const statusColor = "#10B981"; // 綠色

            return {
                type: 'flex',
                altText: '✅ 您的預約已確認成功！',
                contents: {
                    "type": "bubble",
                    "size": "mega",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            { "type": "text", "text": "PAYMENT CONFIRMED", "weight": "bold", "color": statusColor, "size": "xs", "align": "center", "letterSpacing": "1px" },
                            { "type": "text", "text": "預約確認成功", "weight": "bold", "size": "xl", "margin": "md", "align": "center", "color": "#4A4A4A" },
                            { "type": "text", "text": "我們已收到您的款項，期待為您服務！", "size": "xs", "color": "#aaaaaa", "wrap": true, "align": "center", "margin": "sm" },
                            
                            { "type": "separator", "margin": "xxl" },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "margin": "xxl",
                                "spacing": "sm",
                                "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "姓名", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": name, "size": "sm", "color": "#111111", "align": "end", "weight": "bold" } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "項目", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": service, "size": "sm", "color": "#111111", "align": "end" } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "日期", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": date, "size": "sm", "color": "#111111", "align": "end" } ] },
                                    { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": "時間", "size": "sm", "color": "#999999", "flex": 0 }, { "type": "text", "text": time, "size": "sm", "color": "#111111", "align": "end" } ] }
                                ]
                            },
                            { "type": "box", "layout": "vertical", "margin": "lg", "contents": [ { "type": "separator" } ] },
                            { "type": "box", "layout": "horizontal", "margin": "lg", "contents": [ { "type": "text", "text": "付款狀態", "size": "sm", "color": "#999999" }, { "type": "text", "text": pricePlaceholder, "size": "md", "color": statusColor, "align": "end", "weight": "bold" } ] },
                            { "type": "box", "layout": "vertical", "margin": "xxl", "contents": [ { "type": "image", "url": "https://scdn.line-apps.com/n/channel_devcenter/img/fx/review_gold_star_28.png", "size": "xxs", "aspectMode": "fit" }, { "type": "text", "text": "MILU BALLOONS", "size": "xxxs", "color": "#dddddd", "align": "center", "margin": "xs", "letterSpacing": "2px" } ] }
                        ]
                    }
                }
            };
        }

        function sendConfirmation() {
            document.getElementById('send-btn').disabled = true;
            document.getElementById('send-btn').textContent = '發送中...';

            // 檢查 LIFF 是否準備好，且有目標 ID
            if (liff.isInClient() && USER_ID && FLEX_MESSAGE_JSON) {
                // 使用 liff.sendMessages 發送 Flex Message 給指定的 USER_ID
                liff.sendMessages([FLEX_MESSAGE_JSON], {
                    to: USER_ID // 使用 'to' 參數指定接收者
                })
                .then(() => {
                    Swal.fire({
                        title: '✅ 通知已成功發送！',
                        icon: 'success',
                        customClass: { popup: 'font-sans' }
                    }).then(() => {
                        // 嘗試關閉視窗，方便管理員回到後台
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        }
                    });
                })
                .catch((err) => {
                    console.error('Send message failed:', err);
                    Swal.fire({
                        title: '發送失敗',
                        text: `錯誤代碼: ${err.code}。請確認您已正確取得客戶 ID，或從 LINE App 內部點擊連結重試。`,
                        icon: 'error',
                        customClass: { popup: 'font-sans' }
                    });
                    document.getElementById('error-message').classList.remove('hidden');
                    document.getElementById('send-btn').disabled = false;
                    document.getElementById('send-btn').textContent = '點此發送 [✅ 款項已確認]';
                });
            } else {
                Swal.fire({
                    title: '環境或參數錯誤',
                    text: '無法在當前環境發送訊息。請從 LINE 官方帳號 App 點擊連結重試，並確保客戶 ID 存在。',
                    icon: 'warning',
                    customClass: { popup: 'font-sans' }
                });
                document.getElementById('send-btn').disabled = false;
                document.getElementById('send-btn').textContent = '點此發送 [✅ 款項已確認]';
            }
        }
    </script>
</body>
</html>
