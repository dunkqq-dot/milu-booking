<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸˆ æ’¿è²¨å°å¹«æ‰‹</title>
    <!-- å¼•å…¥ Bootstrap è®“æŒ‰éˆ•è®Šæ¼‚äº® -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding-bottom: 80px; }
      .big-text { font-size: 1.2rem; }
      .card-order { cursor: pointer; transition: 0.2s; border-left: 5px solid #ccc; }
      .card-order.done { border-left-color: #198754; background-color: #e8f5e9; }
      .item-checkbox { transform: scale(1.5); margin-right: 10px; }
      .item-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
      .item-row label { font-size: 1.3rem; margin-left: 10px; width: 100%; }
      .loader { display: none; text-align: center; padding: 20px; }
      
      /* é ‚éƒ¨å°èˆª */
      .navbar { background-color: #FF6B6B; color: white; padding: 15px; font-size: 1.5rem; font-weight: bold; }
      
      /* åº•éƒ¨æŒ‰éˆ•å€ */
      .footer-btn { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; }
    </style>
  </head>
  <body>

    <!-- é é¢ 1: è¨‚å–®åˆ—è¡¨ -->
    <div id="view-list">
      <div class="navbar justify-content-center">
        ğŸˆ æ’¿è²¨å·¥å–® (GitHubç‰ˆ)
      </div>
      
      <div class="container mt-3">
        <div class="input-group mb-3">
          <input type="date" id="datePicker" class="form-control form-control-lg">
          <button class="btn btn-dark btn-lg" onclick="loadOrders()">ğŸ” æŸ¥è©¢</button>
        </div>

        <div id="loader-list" class="loader">
          <div class="spinner-border text-danger" role="status"></div>
          <div class="mt-2">æ­£åœ¨è®€å–è¨‚å–®...</div>
        </div>

        <div id="orderListContainer">
          <!-- è¨‚å–®å¡ç‰‡æœƒç”Ÿåœ¨é€™è£¡ -->
          <div class="text-center text-muted mt-5">è«‹é¸æ“‡æ—¥æœŸä¸¦æŒ‰ä¸‹æŸ¥è©¢</div>
        </div>
      </div>
    </div>

    <!-- é é¢ 2: è©³ç´°æ’¿è²¨æ¸…å–® -->
    <div id="view-detail" style="display:none;">
      <div class="navbar">
        <button class="btn btn-outline-light btn-lg" onclick="goBack()">â¬… è¿”å›</button>
        <span class="ms-3" id="detailTitle">è¨‚å–®å…§å®¹</span>
      </div>

      <div class="container mt-3">
        <div class="alert alert-info big-text">
           <strong id="customerName"></strong> <br>
           ä¾†æºï¼š<span id="sheetName">è¼‰å…¥ä¸­...</span>
        </div>

        <div id="loader-detail" class="loader">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">æ­£åœ¨è®€å–å ±åƒ¹å–®...</div>
        </div>

        <div id="materialList" class="bg-white rounded shadow-sm">
          <!-- ææ–™æ¸…å–®æœƒç”Ÿåœ¨é€™è£¡ -->
        </div>
        
        <div style="height: 100px;"></div> <!-- å¢Šé«˜åº•éƒ¨ -->
      </div>

      <div class="footer-btn" id="footerAction" style="display:block;">
        <button class="btn btn-success btn-lg w-100 py-3" onclick="finishOrder()">
          âœ… å®Œæˆæ’¿è²¨ (æ›´æ–°ç³»çµ±)
        </button>
      </div>
    </div>

    <script>
      // ==========================================
      // âš ï¸ é€™è£¡å¡«å…¥æ‚¨çš„ GAS å¾Œç«¯ç¶²å€
      // ==========================================
      const API_URL = "https://script.google.com/macros/s/AKfycbzYOxTAcrUDrTfkCH3K4voyHOWu-uk-AVFfAu60nuIHu0kI6D4Q_k-RlMdJhhUG1dZb/exec";

      let currentOrders = [];
      let currentRowIndex = -1;

      // åˆå§‹åŒ–ï¼šé è¨­ä»Šå¤©æ—¥æœŸ
      window.onload = function() {
        // è¨­å®šæ™‚å€ç‚ºæœ¬åœ°æ™‚é–“ï¼Œé¿å…æŠ“åˆ°æ˜¨å¤©çš„æ—¥æœŸ
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('datePicker').value = `${yyyy}-${mm}-${dd}`;
        
        loadOrders();
      };

      // è¼‰å…¥è¨‚å–®åˆ—è¡¨ (ä½¿ç”¨ fetch)
      function loadOrders() {
        const date = document.getElementById('datePicker').value;
        document.getElementById('loader-list').style.display = 'block';
        document.getElementById('orderListContainer').innerHTML = '';

        // æ”¹ç”¨ fetch å‘¼å« API
        fetch(`${API_URL}?action=getOrders&date=${date}`)
          .then(response => {
             // ğŸ” åµéŒ¯é‡é»ï¼šæª¢æŸ¥å›å‚³çš„æ˜¯ä¸æ˜¯ JSON è³‡æ–™
             const contentType = response.headers.get("content-type");
             if (!contentType || !contentType.includes("application/json")) {
               // å¦‚æœå›å‚³çš„æ˜¯ HTML (ä¾‹å¦‚ Google ç™»å…¥é æˆ–éŒ¯èª¤é )ï¼Œé€™è£¡æœƒæŠ“åˆ°
               throw new Error("âš ï¸ è®€å–å¤±æ•—ï¼ç³»çµ±å›å‚³äº†ç¶²é è€Œéè³‡æ–™ã€‚<br>å¯èƒ½åŸå› ï¼š<br>1. GAS ç¨‹å¼ç¢¼æ²’æœ‰æ›´æ–°æˆ API ç‰ˆæœ¬<br>2. éƒ¨ç½²æ¬Šé™æ²’è¨­ç‚ºã€Œä»»ä½•äººã€");
             }
             return response.json();
          })
          .then(data => {
            // å¾Œç«¯å›å‚³æ ¼å¼é è¨ˆæ˜¯ { orders: [...] }
            // å¦‚æœ data.error å­˜åœ¨ï¼Œä»£è¡¨å¾Œç«¯é‚è¼¯éŒ¯èª¤
            if (data.error) {
                throw new Error(data.error);
            }
            renderOrders(data.orders || []);
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('loader-list').style.display = 'none';
            // å°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œæ–¹ä¾¿æ’æŸ¥
            document.getElementById('orderListContainer').innerHTML = `<div class="alert alert-danger text-center">${error.message}</div>`;
          });
      }

      function renderOrders(orders) {
        currentOrders = orders;
        document.getElementById('loader-list').style.display = 'none';
        const container = document.getElementById('orderListContainer');

        if (!orders || orders.length === 0) {
          container.innerHTML = '<div class="alert alert-warning text-center">ä»Šå¤©æ²’æœ‰è¨‚å–®æˆ–æ˜¯æ—¥æœŸé¸éŒ¯å›‰ï¼<br><small>è«‹ç¢ºèªè©¦ç®—è¡¨æœ‰è©²æ—¥æœŸçš„è³‡æ–™</small></div>';
          return;
        }

        let html = '';
        orders.forEach((order, index) => {
          const statusClass = order.status ? 'done' : '';
          const statusText = order.status ? '(å·²å®Œæˆ)' : '(æœªæ’¿è²¨)';
          
          html += `
            <div class="card p-3 mb-3 shadow-sm card-order ${statusClass}" onclick="openDetail(${index})">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 class="m-0 fw-bold">${order.time} ${order.name}</h3>
                  <div class="text-muted mt-1">${statusText}</div>
                </div>
                <div class="fs-1 text-secondary">á³</div>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      // é€²å…¥è©³ç´°é é¢
      function openDetail(index) {
        const order = currentOrders[index];
        currentRowIndex = order.rowIndex;
        
        // åˆ‡æ›ç•«é¢
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        
        // å¡«å…¥åŸºæœ¬è³‡æ–™
        document.getElementById('customerName').innerText = order.name;
        document.getElementById('detailTitle').innerText = order.time + " æ’¿è²¨å–®";
        document.getElementById('materialList').innerHTML = '';
        document.getElementById('sheetName').innerText = "è®€å–ä¸­...";

        // å‘¼å«å¾Œç«¯è®€å–é€£çµ (ä½¿ç”¨ fetch)
        if(order.link) {
          document.getElementById('loader-detail').style.display = 'block';
          
          fetch(`${API_URL}?action=getMaterials&url=${encodeURIComponent(order.link)}`)
            .then(response => response.json())
            .then(data => {
              renderMaterials(data);
            })
            .catch(error => {
              console.error('Error:', error);
              document.getElementById('loader-detail').style.display = 'none';
              document.getElementById('materialList').innerHTML = '<div class="p-3 text-danger">è®€å–å ±åƒ¹å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            });

        } else {
          document.getElementById('materialList').innerHTML = '<div class="p-4 text-center text-danger">âš ï¸ ç¸½è¡¨ä¸Šæ²’æœ‰è²¼å ±åƒ¹å–®é€£çµï¼<br>è«‹è¡Œæ”¿äººå“¡è£œä¸Šç¶²å€ã€‚</div>';
        }
      }

      function renderMaterials(result) {
        document.getElementById('loader-detail').style.display = 'none';
        
        if (result.error) {
           document.getElementById('materialList').innerHTML = `<div class="p-3 text-danger">${result.error}</div>`;
           return;
        }

        document.getElementById('sheetName').innerText = result.sheetName || "å ±åƒ¹å–®";

        let html = '';
        // ç¢ºä¿ result.items å­˜åœ¨
        const items = result.items || [];
        
        if (items.length === 0) {
            html = '<div class="p-3 text-center text-muted">é€™å¼µå–®å¥½åƒæ²’æœ‰ææ–™å…§å®¹å–”</div>';
        } else {
            items.forEach((item, idx) => {
              html += `
                <div class="item-row" onclick="toggleCheck(${idx})">
                  <input type="checkbox" class="item-checkbox" id="check-${idx}">
                  <label for="check-${idx}">
                    ${item.name} <br>
                    <span class="badge bg-secondary">${item.qty}</span>
                  </label>
                </div>
              `;
            });
        }
        document.getElementById('materialList').innerHTML = html;
      }

      // é»æ“Šæ•´è¡Œéƒ½èƒ½æ‰“å‹¾
      function toggleCheck(idx) {
        // é€™è£¡ä¸éœ€è¦é¡å¤–é‚è¼¯ï¼Œä¾é  label for å±¬æ€§å³å¯
      }

      // è¿”å›åˆ—è¡¨
      function goBack() {
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-detail').style.display = 'none';
        // é¸æ“‡æ€§ï¼šè¿”å›æ™‚æ˜¯å¦é‡æ–°æ•´ç†åˆ—è¡¨ï¼Ÿå¦‚æœè¦æ›´æ–°ç‹€æ…‹å»ºè­°é‡è¼‰
        loadOrders(); 
      }

      // å®Œæˆæ’¿è²¨ (ä½¿ç”¨ fetch POST)
      function finishOrder() {
        if(!confirm("ç¢ºå®šéƒ½æ’¿å¥½è²¨äº†å—ï¼Ÿ")) return;
        
        // é¡¯ç¤º loading é¿å…é‡è¤‡é»æ“Š
        const btn = document.querySelector('#footerAction button');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "æ›´æ–°ä¸­...";

        // ä½¿ç”¨ fetch POST é€å‡ºè³‡æ–™ (JSON å­—ä¸²)
        // é€™è£¡ä½¿ç”¨ text/plain ä»¥é¿å… GAS çš„ CORS é æª¢å•é¡Œï¼Œå¾Œç«¯éœ€åšå°æ‡‰è§£æ
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "markAsDone",
                rowIndex: currentRowIndex
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("ğŸ‰ æ›´æ–°æˆåŠŸï¼");
                goBack();
            } else {
                alert("æ›´æ–°å¤±æ•—ï¼š" + (data.error || "æœªçŸ¥éŒ¯èª¤"));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•æ›´æ–°");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = originalText;
        });
      }
    </script>
  </body>
</html>
