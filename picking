<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- å¼•å…¥ Bootstrap è®“æŒ‰éˆ•è®Šæ¼‚äº® -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; padding-bottom: 80px; }
      .big-text { font-size: 1.2rem; }
      .card-order { cursor: pointer; transition: 0.2s; border-left: 5px solid #ccc; }
      .card-order.done { border-left-color: #198754; background-color: #e8f5e9; }
      .item-checkbox { transform: scale(1.5); margin-right: 10px; }
      .item-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
      .item-row label { font-size: 1.3rem; margin-left: 10px; width: 100%; }
      .loader { display: none; text-align: center; padding: 20px; }
      
      /* é ‚éƒ¨å°èˆª */
      .navbar { background-color: #FF6B6B; color: white; padding: 15px; font-size: 1.5rem; font-weight: bold; }
      
      /* åº•éƒ¨æŒ‰éˆ•å€ */
      .footer-btn { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; }
    </style>
  </head>
  <body>

    <!-- é é¢ 1: è¨‚å–®åˆ—è¡¨ -->
    <div id="view-list">
      <div class="navbar justify-content-center">
        ğŸˆ æ’¿è²¨å·¥å–®
      </div>
      
      <div class="container mt-3">
        <div class="input-group mb-3">
          <input type="date" id="datePicker" class="form-control form-control-lg">
          <button class="btn btn-dark btn-lg" onclick="loadOrders()">ğŸ” æŸ¥è©¢</button>
        </div>

        <div id="loader-list" class="loader">
          <div class="spinner-border text-danger" role="status"></div>
          <div class="mt-2">æ­£åœ¨è®€å–è¨‚å–®...</div>
        </div>

        <div id="orderListContainer">
          <!-- è¨‚å–®å¡ç‰‡æœƒç”Ÿåœ¨é€™è£¡ -->
          <div class="text-center text-muted mt-5">è«‹é¸æ“‡æ—¥æœŸä¸¦æŒ‰ä¸‹æŸ¥è©¢</div>
        </div>
      </div>
    </div>

    <!-- é é¢ 2: è©³ç´°æ’¿è²¨æ¸…å–® -->
    <div id="view-detail" style="display:none;">
      <div class="navbar">
        <button class="btn btn-outline-light btn-lg" onclick="goBack()">â¬… è¿”å›</button>
        <span class="ms-3" id="detailTitle">è¨‚å–®å…§å®¹</span>
      </div>

      <div class="container mt-3">
        <div class="alert alert-info big-text">
           <strong id="customerName"></strong> <br>
           ä¾†æºï¼š<span id="sheetName">è¼‰å…¥ä¸­...</span>
        </div>

        <div id="loader-detail" class="loader">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">æ­£åœ¨è®€å–å ±åƒ¹å–®...</div>
        </div>

        <div id="materialList" class="bg-white rounded shadow-sm">
          <!-- ææ–™æ¸…å–®æœƒç”Ÿåœ¨é€™è£¡ -->
        </div>
        
        <div style="height: 100px;"></div> <!-- å¢Šé«˜åº•éƒ¨ -->
      </div>

      <div class="footer-btn" id="footerAction" style="display:block;">
        <button class="btn btn-success btn-lg w-100 py-3" onclick="finishOrder()">
          âœ… å®Œæˆæ’¿è²¨ (æ›´æ–°ç³»çµ±)
        </button>
      </div>
    </div>

    <script>
      let currentOrders = [];
      let currentRowIndex = -1;

      // åˆå§‹åŒ–ï¼šé è¨­ä»Šå¤©æ—¥æœŸ
      window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('datePicker').value = today;
        loadOrders();
      };

      // è¼‰å…¥è¨‚å–®åˆ—è¡¨
      function loadOrders() {
        const date = document.getElementById('datePicker').value;
        document.getElementById('loader-list').style.display = 'block';
        document.getElementById('orderListContainer').innerHTML = '';

        google.script.run.withSuccessHandler(renderOrders).getOrdersByDate(date);
      }

      function renderOrders(orders) {
        currentOrders = orders;
        document.getElementById('loader-list').style.display = 'none';
        const container = document.getElementById('orderListContainer');

        if (orders.length === 0) {
          container.innerHTML = '<div class="alert alert-warning text-center">ä»Šå¤©æ²’æœ‰è¨‚å–®æˆ–æ˜¯æ—¥æœŸé¸éŒ¯å›‰ï¼</div>';
          return;
        }

        let html = '';
        orders.forEach((order, index) => {
          const statusClass = order.status ? 'done' : '';
          const statusText = order.status ? '(å·²å®Œæˆ)' : '(æœªæ’¿è²¨)';
          
          html += `
            <div class="card p-3 mb-3 shadow-sm card-order ${statusClass}" onclick="openDetail(${index})">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 class="m-0 fw-bold">${order.time} ${order.name}</h3>
                  <div class="text-muted mt-1">${statusText}</div>
                </div>
                <div class="fs-1 text-secondary">á³</div>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      }

      // é€²å…¥è©³ç´°é é¢
      function openDetail(index) {
        const order = currentOrders[index];
        currentRowIndex = order.rowIndex;
        
        // åˆ‡æ›ç•«é¢
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-detail').style.display = 'block';
        
        // å¡«å…¥åŸºæœ¬è³‡æ–™
        document.getElementById('customerName').innerText = order.name;
        document.getElementById('detailTitle').innerText = order.time + " æ’¿è²¨å–®";
        document.getElementById('materialList').innerHTML = '';
        document.getElementById('sheetName').innerText = "è®€å–ä¸­...";

        // å‘¼å«å¾Œç«¯è®€å–é€£çµ
        if(order.link) {
          document.getElementById('loader-detail').style.display = 'block';
          google.script.run.withSuccessHandler(renderMaterials).getMaterialList(order.link);
        } else {
          document.getElementById('materialList').innerHTML = '<div class="p-4 text-center text-danger">âš ï¸ ç¸½è¡¨ä¸Šæ²’æœ‰è²¼å ±åƒ¹å–®é€£çµï¼<br>è«‹è¡Œæ”¿äººå“¡è£œä¸Šç¶²å€ã€‚</div>';
        }
      }

      function renderMaterials(result) {
        document.getElementById('loader-detail').style.display = 'none';
        
        if (result.error) {
           document.getElementById('materialList').innerHTML = `<div class="p-3 text-danger">${result.error}</div>`;
           return;
        }

        document.getElementById('sheetName').innerText = result.sheetName || "å ±åƒ¹å–®";

        let html = '';
        result.items.forEach((item, idx) => {
          html += `
            <div class="item-row" onclick="toggleCheck(${idx})">
              <input type="checkbox" class="item-checkbox" id="check-${idx}">
              <label for="check-${idx}">
                ${item.name} <br>
                <span class="badge bg-secondary">${item.qty}</span>
              </label>
            </div>
          `;
        });
        document.getElementById('materialList').innerHTML = html;
      }

      // é»æ“Šæ•´è¡Œéƒ½èƒ½æ‰“å‹¾
      function toggleCheck(idx) {
        // é¿å…é»æ“Š checkbox æœ¬èº«æ™‚è§¸ç™¼å…©æ¬¡
        // é€™è£¡å–®ç´”ä¾é  label çš„ for å±¬æ€§å³å¯ï¼Œæˆ–æ˜¯æ‰‹å‹•åˆ‡æ›
      }

      // è¿”å›åˆ—è¡¨
      function goBack() {
        document.getElementById('view-list').style.display = 'block';
        document.getElementById('view-detail').style.display = 'none';
        loadOrders(); // é‡æ–°æ•´ç†ç‹€æ…‹
      }

      // å®Œæˆæ’¿è²¨
      function finishOrder() {
        if(!confirm("ç¢ºå®šéƒ½æ’¿å¥½è²¨äº†å—ï¼Ÿ")) return;
        
        google.script.run.withSuccessHandler(function() {
          alert("ğŸ‰ æ›´æ–°æˆåŠŸï¼");
          goBack();
        }).markOrderAsDone(currentRowIndex);
      }
    </script>
  </body>
</html>
